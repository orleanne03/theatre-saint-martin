<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸŸï¸ Scanner â€” ThÃ©Ã¢tre Saint Martin</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:system-ui;margin:0;padding:16px;text-align:center;
background:linear-gradient(180deg,#f9f9f9,#e3f2fd)}
h1{color:#0d47a1}
#reader{width:320px;margin:12px auto;border-radius:10px;overflow:hidden;
box-shadow:0 4px 12px rgba(0,0,0,.15)}
.panel{max-width:500px;margin:16px auto;background:#fff;padding:16px;
border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.ok{color:#2e7d32;font-weight:700}
.err{color:#d32f2f;font-weight:700}
button{padding:10px 14px;border-radius:8px;border:none;color:#fff;
cursor:pointer;margin:6px}
.green{background:#2e7d32}
.violet{background:#8e24aa}
#counter{font-weight:700;color:#0d47a1}
#details{margin-top:10px;text-align:left;background:#f9f9f9;
padding:10px;border-radius:8px;border:1px solid #ddd}
</style>
</head>

<body>

<h1>ğŸ­ ThÃ©Ã¢tre Saint Martin â€” Scanner</h1>
<p>Alignez le QR dans le carrÃ© pour valider un billet.</p>

<div id="reader"></div>

<div class="panel">
  <p id="status">PrÃªt Ã  scanner.</p>
  <p id="counter">Billets scannÃ©s : 0</p>
  <div id="details" style="display:none;"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ğŸ”¥ CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "TA_API_KEY",
  authDomain: "TON_PROJET.firebaseapp.com",
  databaseURL: "https://TON_PROJET-default-rtdb.firebaseio.com",
  projectId: "TON_PROJET"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* UI */
const statusEl = document.getElementById("status");
const counterEl = document.getElementById("counter");
const detailsEl = document.getElementById("details");

let scanner;
let scanning = false;
let lastText="", lastTime=0;

function flash(color){
  const d=document.createElement("div");
  Object.assign(d.style,{
    position:"fixed",inset:"0",background:color,opacity:.25,zIndex:99
  });
  document.body.append(d);
  setTimeout(()=>d.remove(),150);
}

async function startScanner(){
  if(scanning) return;
  scanning=true;
  scanner=new Html5Qrcode("reader");
  await scanner.start(
    {facingMode:"environment"},
    {fps:10,qrbox:{width:250,height:250}},
    onScanSuccess
  );
}

async function stopScanner(){
  if(scanner){
    await scanner.stop();
    scanning=false;
  }
}

function safeDecode(t){
  try{ return decodeURIComponent(t); }catch{ return t; }
}

async function onScanSuccess(text){
  const now=Date.now();
  if(text===lastText && now-lastTime<3000) return;
  lastText=text; lastTime=now;

  await stopScanner();

  let data=null;
  try{ data=JSON.parse(safeDecode(text)); }catch{}

  const sieges = data?.sieges || "";
  const maxScans = sieges.split(",").filter(Boolean).length || 1;
  const ticketId = sieges.replace(/\s+/g,"") || text;

  const ticketRef = ref(db,"scans/"+ticketId);

  runTransaction(ticketRef,(current)=>{
    if(current===null){
      return {
        count:1,
        nom:data?.nom || "Participant",
        sieges:sieges,
        lastScan:Date.now()
      };
    }

    if(current.count>=maxScans) return;

    if(data?.nom && current.nom==="Participant"){
      current.nom=data.nom;
    }

    current.count++;
    current.lastScan=Date.now();
    return current;
  }).then(res=>{
    if(!res.committed){
      statusEl.innerHTML="<span class='err'>â›” Billet dÃ©jÃ  utilisÃ©</span>";
      flash("red");
      document.body.style.background=
        "linear-gradient(180deg,#ffebee,#ffcdd2)";
      setTimeout(()=>{
        document.body.style.background=
          "linear-gradient(180deg,#f9f9f9,#e3f2fd)";
        statusEl.textContent="PrÃªt Ã  scanner.";
        startScanner();
      },5000);
      return;
    }

    const v=res.snapshot.val();

    statusEl.innerHTML=
      `<span class='ok'>âœ… Scan ${v.count} / ${maxScans}</span>`;

    counterEl.textContent="Billets scannÃ©s : "+v.count;

    detailsEl.style.display="block";
    detailsEl.innerHTML=`
      <strong>RÃ©servation au nom de :</strong><br>
      <span style="font-size:18px;font-weight:700;color:#0d47a1">
        ${v.nom}
      </span>
      <hr>
      <strong>ğŸŸï¸ SiÃ¨ges :</strong> ${v.sieges}
    `;

    flash("lime");
    setTimeout(()=>startScanner(),1200);
  });
}

startScanner();
</script>

</body>
</html>

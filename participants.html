

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ğŸŸï¸ Informations des participants</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fff8e1;
      padding: 20px;
      text-align: center;
    }
    form {
      background: white;
      max-width: 420px;
      margin: auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,.15);
      text-align: left;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #2e7d32;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h2>ğŸ‘¥ Informations des participants</h2>



<p>Merci de complÃ©ter les informations demandÃ©es.</p>

<form id="participantsForm">
  <input id="pname" placeholder="Nom du participant" required>
  <input id="pemail" type="email" placeholder="Email du participant" required>
  <input id="pphone" placeholder="TÃ©lÃ©phone du participant" required>

  <button type="submit">âœ… Enregistrer</button>
  <button id="closeWindow"
  style="
    margin-bottom:15px;
    background:#a10e0e;
    color:white;
    border:none;
    padding:8px 14px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
        width: 100%;
  ">
  âŒ Fermer
</button>
</form>
<!-- ğŸ“‹ Liste des participants -->
<div id="participantsList" style="margin-top:30px;">
  <h3 style="text-align:center;">ğŸ“‹ Participants enregistrÃ©s</h3>

  <table style="
    width:100%;
    max-width:420px;
    margin:10px auto;
    border-collapse:collapse;
    font-size:14px;
  ">
    <thead>
      <tr style="background:#f0f0f0;">
        <th>Nom</th>
        <th>Email</th>
        <th>TÃ©lÃ©phone</th>
        <th>âœï¸</th>
        <th>âŒ</th>
      </tr>
    </thead>
    <tbody id="participantsTableBody">
      <!-- lignes injectÃ©es en JS -->
    </tbody>
  </table>
</div>

<script type="module">
    
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";


  const app = initializeApp({
    apiKey: "AIzaSyXXXX_TON_API_KEY",
    authDomain: "theatre-saint-martin.firebaseapp.com",
    databaseURL: "https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "theatre-saint-martin",
    storageBucket: "theatre-saint-martin.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcd1234efgh"
  });

  const db = getDatabase(app);

  // ğŸ”‘ RÃ©cupÃ©ration du resId depuis lâ€™URL
  const params = new URLSearchParams(window.location.search);
  const resId = params.get("resId");
  const pname = document.getElementById("pname");
const pemail = document.getElementById("pemail");
const pphone = document.getElementById("pphone");

// âœï¸ Nom â†’ Majuscule au dÃ©but de chaque mot
pname.addEventListener("input", () => {
  const pos = pname.selectionStart;
  pname.value = formatName(pname.value);
  pname.setSelectionRange(pos, pos);
});

// ğŸ“§ Email â†’ toujours en minuscules
pemail.addEventListener("input", () => {
  pemail.value = pemail.value.toLowerCase();
});

// ğŸ“ TÃ©lÃ©phone â†’ 06 61 49 97 12
pphone.addEventListener("input", () => {
  const pos = pphone.selectionStart;
  pphone.value = formatPhone(pphone.value);
  pphone.setSelectionRange(pos, pos);
});

function formatName(str) {
  return str
    .toLowerCase()
    .split(" ")
    .filter(Boolean)
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

function formatPhone(str) {
  const digits = str.replace(/\D/g, "").slice(0, 10);
  return digits.replace(/(\d{2})(?=\d)/g, "$1 ").trim();
}

if (!resId) {
  alert("âŒ Lien invalide ou incomplet.\nVeuillez utiliser le lien reÃ§u par email.");
  document.getElementById("participantsForm").style.display = "none";
  throw new Error("resId manquant");
}



  document.getElementById("participantsForm").addEventListener("submit", async (e) => {
    e.preventDefault();

const data = {
  name: formatName(pname.value.trim()),
  email: pemail.value.trim().toLowerCase(),
  phone: formatPhone(pphone.value.trim()),
  createdAt: Date.now()
};

if (editingParticipantId) {
  await set(
    ref(db, `participants/${resId}/${editingParticipantId}`),
    data
  );
  editingParticipantId = null;
  await loadParticipantsTable();
  e.target.reset();
  return;
}


const newParticipantRef = await push(
  ref(db, `participants/${resId}`),
  data
);
// ğŸ”½ RÃ©cupÃ¨re la rÃ©servation principale (Firebase)
const resSnap = await get(ref(db, `spectacles/salle_bessay/${resId}`));

if (!resSnap.exists()) {
  alert("âŒ RÃ©servation introuvable");
  return;
}

const reservationMain = resSnap.val();

// âœ‰ï¸ Envoi du billet AU PARTICIPANT
await sendParticipantTicket(data, {
  ...reservationMain,
  id: resId
});




alert("âœ… Participant enregistrÃ© et billet envoyÃ© !");
await loadParticipantsTable();

e.target.reset();

  });
  async function loadParticipantsTable() {
  const tbody = document.getElementById("participantsTableBody");
  if (!tbody) return;

  tbody.innerHTML = "";

  const snap = await get(ref(db, `participants/${resId}`));
  if (!snap.exists()) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center;color:#777;">
          Aucun participant enregistrÃ©
        </td>
      </tr>`;
    return;
  }

  Object.entries(snap.val()).forEach(([pid, p]) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.email}</td>
      <td>${p.phone || ""}</td>

      <!-- âœï¸ Modifier -->
      <td style="text-align:center;">
        <button class="edit-participant"
          data-id="${pid}"
          style="background:none;border:none;cursor:pointer;font-size:16px;">
          âœï¸
        </button>
      </td>

      <!-- âŒ Supprimer -->
      <td style="text-align:center;">
        <button class="delete-participant"
          data-id="${pid}"
          style="background:none;border:none;cursor:pointer;font-size:16px;color:#e53935;">
          âŒ
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}
document.addEventListener("click", async (e) => {
  const delBtn = e.target.closest(".delete-participant");
  if (!delBtn) return;

  const pid = delBtn.dataset.id;

  if (!confirm("Supprimer ce participant ?")) return;

  await remove(ref(db, `participants/${resId}/${pid}`));
  loadParticipantsTable();
});
let editingParticipantId = null;

document.addEventListener("click", async (e) => {
  const editBtn = e.target.closest(".edit-participant");
  if (!editBtn) return;

  const pid = editBtn.dataset.id;
  const snap = await get(ref(db, `participants/${resId}/${pid}`));
  if (!snap.exists()) return;

  const p = snap.val();

  pname.value = p.name;
  pemail.value = p.email;
  pphone.value = p.phone || "";

  editingParticipantId = pid;
});
document.getElementById("closeWindow").addEventListener("click", () => {
  // Tente de fermer lâ€™onglet
  window.open("", "_self");
  window.close();

  // SÃ©curitÃ© : si le navigateur refuse, on redirige
  setTimeout(() => {
    window.location.href = "https://orleanne03.github.io/theatre-saint-martin/";
  }, 400);
});
loadParticipantsTable();


</script>

</body>
</html>

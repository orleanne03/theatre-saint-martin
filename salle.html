<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üé≠ Th√©√¢tre Saint Martin ‚Äì R√©servations</title>

<!-- Librairies externes -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<!-- ‚úÖ Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyXXXX_TON_API_KEY",
    authDomain: "theatre-saint-martin.firebaseapp.com",
    databaseURL: "https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "theatre-saint-martin",
    storageBucket: "theatre-saint-martin.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcd1234efgh"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window._firebaseDB = db;
  window._firebaseRef = ref;
  window._firebaseSet = set;
  window._firebaseOnValue = onValue;

  console.log("üî• Firebase initialis√© :", db);
</script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(180deg, #e3f2fd 0%, #fafafa 100%);
  margin: 0;
  text-align: center;
  color: #212121;
}
h1 {
  color: #0d47a1;
  margin: 20px 0;
  font-size: 1.8rem;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}
  #legend-paid {
  background: #f1f8e9;
  padding: 4px 8px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.scene {
  background: #212121;
  color: #fff;
  width: 80%;
  max-width: 800px;
  margin: 10px auto 20px;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
  font-weight: 600;
  letter-spacing: 1px;
}
.legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 15px;
  font-size: 14px;
}
.legend div { display: flex; align-items: center; gap: 5px; }
.legend span { width: 18px; height: 18px; border-radius: 3px; display: inline-block; }
.free { background: #e0e0e0; }
.selected { background: #64b5f6; }
.reserved { background: #ef5350; }
.strapontin { background: #ffd54f; }
.seat.strapontin.selected { background: #82b1ff !important; }

/* === Conteneur principal === */
.hall-wrapper {
  display: block;
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  touch-action: pinch-zoom pan-x pan-y;
  padding: 10px 0;
  box-sizing: border-box;
  background: transparent;
  text-align: center;  /* ‚úÖ centre par d√©faut */
}

/* === Bloc des si√®ges === */
#hall {
  display: inline-flex;             /* ‚úÖ permet le centrage avec text-align: center */
  flex-direction: column;
  align-items: center;
  background: #fff;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,.15);
  transition: transform 0.2s ease;
}

/* === üåê Correction responsive : sur mobile, on d√©sactive le centrage pour garder le scroll complet === */
@media (max-width: 768px) {
  .hall-wrapper {
    text-align: left;              /* ‚úÖ permet le scroll total (gauche et droite) */
    padding-left: 10px;
  }
  #hall {
    display: flex;                 /* ‚úÖ comportement normal sans centrage forc√© */
    width: max-content;
  }
}




.row {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: nowrap;
  margin: 4px 0;
}
.row-label {
  font-weight: 600;
  margin-right: 8px;
  min-width: 18px;
}
/* === STYLE DES SI√àGES (R√âALISTES + CENTR√âS) === */
.seat {
  position: relative;
  width: 34px;
  height: 34px;
  margin: 4px;
  border-radius: 6px 6px 8px 8px;
  cursor: pointer;
  display: inline-block;
  overflow: hidden;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  transform-origin: bottom center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  font-weight: 700;
  color: #fff;
}

/* ‚úÖ Texte centr√© parfaitement au milieu du si√®ge */
.seat span {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  text-align: center;
  font-size: 0.95em;
  line-height: 1;
  pointer-events: none;
}

/* === Effets du dossier et de l‚Äôassise === */
.seat::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 60%;
  border-radius: 6px 6px 0 0;
  background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0)),
              radial-gradient(circle at top left, rgba(255,255,255,0.2), transparent);
  pointer-events: none;
}

.seat::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 45%;
  border-radius: 0 0 8px 8px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  pointer-events: none;
}

/* === √âTATS DES SI√àGES === */

/* üî¥ Libre */
.free {
  background: linear-gradient(145deg, #c62828, #8e0000);
  box-shadow: 0 2px 5px rgba(0,0,0,0.25);
}
.free:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 10px rgba(0,0,0,0.35);
}

/* üîµ S√©lectionn√© */
.selected {
  background: linear-gradient(145deg, #1565c0, #0d47a1);
  box-shadow: 0 4px 10px rgba(13,71,161,0.4);
  transform: scale(1.1);
}

/* ‚ö´ R√©serv√© */
/* ‚ö´ R√©serv√© non pay√© ‚Äî rose clair */
.reserved {
  background: #f8bbd0 !important;
  color: #212121;
  cursor: not-allowed;
  box-shadow: 0 0 6px rgba(233,30,99,0.3);
  opacity: 1;
}
/* üü° Strapontin r√©serv√© (m√™me rose) */
.seat.strapontin.reserved {
  background: #f8bbd0 !important;
  color: #212121;
  box-shadow: 0 0 6px rgba(233,30,99,0.3);
}

/* üíö Si√®ge r√©serv√© et pay√© */
/* üíö L√©gende Pay√© */
.paid {
  background: linear-gradient(145deg, #43a047, #2e7d32);
  box-shadow: 0 0 4px rgba(67,160,71,0.6);
}



/* üü° Strapontin */
.strapontin {
  background: linear-gradient(145deg, #f9a825, #f57f17);
  box-shadow: 0 3px 6px rgba(0,0,0,0.25);
}
.seat.strapontin.selected {
  background: linear-gradient(145deg, #ffca28, #fbc02d);
  box-shadow: 0 0 10px rgba(255,193,7,0.6);
}

/* === Ajustement Mobile === */
@media (max-width: 600px) {
  .seat {
    width: 26px;
    height: 26px;
    margin: 2px;
  }
  .seat span {
    font-size: 12px;
  }
}

.buttons {
  margin: 20px 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
}
button {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: .3s;
}
#confirm { background: #2e7d32; } #confirm:hover { background: #1b5e20; }
#admin { background: #d32f2f; } #admin:hover { background: #b71c1c; }
#reset { background: #455a64; } #reset:hover { background: #263238; }
#export { background: #009688; } #export:hover { background: #00695c; }
#scanTicket { background: #8e24aa; } #scanTicket:hover { background: #6a1b9a; }
#save {
    background: black;
}
#close {
    background: black;
}
#reservations {
  margin: 20px auto;
  width: 90%;
  max-width: 800px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  padding: 10px;
}
#reservations h3 {
  text-align: left;
  margin: 10px;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 6px;
}
#reservations table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
#reservations th, #reservations td {
  border-bottom: 1px solid #ddd;
  padding: 6px;
  text-align: left;
}
#reservations th { background: #1976d2; color: #fff; }

.modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,.5); display: flex; justify-content: center; align-items: center; z-index: 10;
}
.modal.hidden { display: none; }
.modal-content {
  background: #fff; padding: 20px; border-radius: 10px; width: 300px;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
}
.modal-content input {
  width: 90%; margin: 6px auto; padding: 8px; border: 1px solid #ccc;
  border-radius: 5px; display: block;
}
#loader {
  position: fixed; inset: 0;
  background: linear-gradient(180deg,#e3f2fd 0%,#fafafa 100%);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999; transition: opacity .4s ease;
}
#loader.hidden { opacity: 0; pointer-events: none; }
.loader-content { text-align: center; color: #0d47a1; font-weight: 600; font-size: 1.1rem; }
.spinner {
  width: 40px; height: 40px;
  border: 4px solid #bbdefb;
  border-top: 4px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px;
}
  /* === STYLE FAUTEUILS R√âALISTES === */
.seat {
  position: relative;
  width: 34px;
  height: 34px;
  margin: 4px;
  border-radius: 6px 6px 8px 8px;
  cursor: pointer;
  display: inline-block;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  transform-origin: bottom center;
}

/* Dossier (partie haute) */
.seat::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 60%;
  border-radius: 6px 6px 0 0;
  background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0)),
              radial-gradient(circle at top left, rgba(255,255,255,0.2), transparent);
  pointer-events: none;
}

/* Assise (partie basse) */
.seat::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 45%;
  border-radius: 0 0 8px 8px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  pointer-events: none;
}

/* üî¥ Si√®ge libre */
.free {
  background: linear-gradient(145deg, #c62828, #8e0000);
  box-shadow: 0 2px 5px rgba(0,0,0,0.25);
  color: #fff; /* texte blanc */
}
.free:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 10px rgba(0,0,0,0.35);
}

/* üîµ S√©lectionn√© */
.selected {
  background: linear-gradient(145deg, #1565c0, #0d47a1);
  box-shadow: 0 4px 10px rgba(13,71,161,0.4);
  transform: scale(1.1);
  color: #fff; /* texte blanc */
}

/* ‚ö´ R√©serv√© */
.reserved {
  background: linear-gradient(145deg, #7c787773, #3e272300);
  opacity: 0.8;
  cursor: not-allowed;
  box-shadow: inset 0 2px 4px rgba(255,255,255,0.1);
}

/* üü° Strapontin */
.strapontin {
  background: linear-gradient(145deg, #f9a825, #f57f17);
  box-shadow: 0 3px 6px rgba(0,0,0,0.25);
}
.seat.strapontin.selected {
  background: linear-gradient(145deg, #ffca28, #fbc02d);
  box-shadow: 0 0 10px rgba(255,193,7,0.6);
}

@keyframes spin { to { transform: rotate(360deg); } }
@media(max-width:600px){
  .seat { width: 26px; height: 26px; font-size: 9px; margin: 2px; }
  .row-label { font-size: 12px; margin-right: 4px; }
  h1 { font-size: 1.5rem; }
  /* === üåü VISUEL AM√âLIOR√â POUR LE MODE ADMIN === */

/* Fond l√©g√®rement dor√© pour signaler le mode admin */
body.admin {
  background: radial-gradient(circle at center, #fff8e1, #ffe082);
  transition: background 0.5s ease;
}

/* Aura dor√©e autour de tous les si√®ges r√©serv√©s */
.admin .seat.reserved {
  box-shadow: 0 0 10px 3px rgba(255,215,0,0.7),
              inset 0 2px 4px rgba(0,0,0,0.3);
  animation: pulseGold 1.5s infinite alternate;
}

/* Animation douce (pulsation dor√©e) */
@keyframes pulseGold {
  from { box-shadow: 0 0 10px 3px rgba(255,215,0,0.6); }
  to   { box-shadow: 0 0 14px 5px rgba(255,215,0,0.9); }
}

/* Curseur et effet au survol des si√®ges r√©serv√©s */
.admin .seat.reserved:hover {
  cursor: pointer;
  transform: scale(1.12);
  filter: brightness(1.15);
}

/* Petite √©tiquette visuelle "Mode Admin" fixe */
#adminBanner {
  position: fixed;
  top: 10px;
  right: 10px;
  background: linear-gradient(90deg, #ffb300, #f57c00);
  color: #fff;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 10000;
  display: none;
}
body.admin #adminBanner {
  display: block;
}

}
  /* === Ajustement de l'espacement sur mobile === */
@media (max-width: 768px) {
  .hall-wrapper {
    margin-bottom: 10px !important;   /* R√©duit l'espace sous le plan */
  }

  #hall {
    margin-bottom: 0 !important;      /* Supprime tout espace interne inutile */
  }

  .buttons {
    margin-top: 5px !important;       /* Rapproche les boutons de la salle */
    margin-bottom: 10px;
  }

  /* Optionnel : rendre les boutons un peu plus compacts sur mobile */
  .buttons button {
    padding: 8px 12px;
    font-size: 13px;
  }
}
#info {
  background: #1976d2;
}
#info:hover {
  background: #0d47a1;
}
/* === Strapontin r√©serv√© : m√™me style que les si√®ges r√©serv√©s === */
.seat.strapontin.reserved {
  background: linear-gradient(145deg, #7c787773, #3e272300);
  opacity: 0.8;
  cursor: not-allowed;
  box-shadow: inset 0 2px 4px rgba(255,255,255,0.1);
}
#reservations tr:hover {
  background-color: #e3f2fd;
  transition: background-color 0.3s;
}
input.paid-toggle {
  transform: scale(1.2);
  cursor: pointer;
}
.seat.strapontin.paid {
  background: linear-gradient(145deg, #7cb342, #558b2f);
}
/* === Ligne "Paiement re√ßu" === */
.paid-line {
  
  align-items: center;
  justify-content: space-between;
  margin: 8px 0 12px 5px;
  font-weight: 500;
}

.paid-line input[type="checkbox"] {
  transform: scale(1.3);
  cursor: pointer;
  margin-right: 8px; /* espace l√©ger avec le bord droit */
}
/* ‚ú® Animation d'apparition des si√®ges */
@keyframes seatPop {
  from { transform: scale(0.5); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.seat {
  animation: seatPop 0.4s ease-out;
}

/* üí° Petit rebond au clic */
.seat:active {
  transform: scale(0.9);
  transition: transform 0.1s;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #bbdefb;
  border-top: 4px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s cubic-bezier(0.45, 0, 0.55, 1) infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader-content p {
  animation: fadeIn 1s ease-in-out infinite alternate;
}

@keyframes fadeIn {
  from { opacity: 0.6; }
  to { opacity: 1; }
}
.modal-content {
  transform: scale(0.8);
  opacity: 0;
  animation: modalIn 0.3s ease-out forwards;
}

@keyframes modalIn {
  to {
    transform: scale(1);
    opacity: 1;
  }
}
button {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
button:active {
  transform: scale(0.96);
}
.scene {
  animation: float 3s ease-in-out infinite alternate;
}

@keyframes float {
  from { transform: translateY(0); }
  to { transform: translateY(-4px); }
}
/* === Accord√©ons de r√©servation par client (version douce) === */
.accordion {
  background: #f9f9f9;
  border-radius: 8px;
  margin: 10px 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  overflow: hidden;
  transition: all 0.3s ease;
}

.accordion-header {
  background: #6fb572; /* üíô bleu plus doux */
  color: #000000;
  padding: 10px 14px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 100;
  transition: background 0.3s;
}

.accordion-header:hover {
  background: #42a5f5;
}

.accordion-content {
  background: #fff;
  padding: 10px 14px;
  display: none;
  border-top: 1px solid #ddd;
  transition: all 0.3s ease;
}

.accordion.open .accordion-content {
  display: block;
}

.accordion-header span {
  font-size: 0.9rem;
  font-weight: normal;
  color: #e3f2fd;
}

.seat-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  font-size: 0.9rem;
  margin-top: 6px;
}

.badge-seat {
  background: #64b5f6; /* m√™me bleu doux */
  color: #fff;
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: 600;
}

.accordion-content p {
  margin: 4px 0;
}
/* === Couleur diff√©rente si non pay√© === */
.accordion-header.paid {
  background: #a5d1a7; /* üíô bleu doux */
}

.accordion-header.unpaid {
  background: #f8bbd0; /* üå∏ rose clair */
  color: #212121;
}

.accordion-header.unpaid:hover {
  background: #f48fb1;
}
.accordion-header.paid {
  border-left: 6px solid #49a760;
}

.accordion-header.unpaid {
  border-left: 6px solid #e91e63;
}

.paid-toggle-client {
  transform: scale(1.2);
  cursor: pointer;
}
#amount {
  width: 90%;
  margin: 6px auto;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 5px;
  display: block;
  font-size: 14px;
}
#total-amount {
  transition: transform 0.3s ease, color 0.3s ease;
}
#total-amount.updated {
  transform: scale(1.1);
  color: #43a047;
}
.paid-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 10px auto 14px;
  padding: 6px 10px;
  width: 90%;
  background: #f1f1f1;
  border-radius: 6px;
  font-weight: 600;
  color: #333;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.paid-line input[type="checkbox"] {
  transform: scale(1.3);
  accent-color: #2e7d32; /* ‚úÖ vert doux */
  cursor: pointer;
}
.payment-group {
  background: #f5f5f5;
  padding: 10px;
  border-radius: 8px;
  margin: 10px auto 15px;
  width: 90%;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.payment-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
}

.payment-line input[type="checkbox"] {
  transform: scale(1.2);
  accent-color: #2e7d32; /* vert doux */
  cursor: pointer;
}

#amount {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 14px;
  box-sizing: border-box;
}
input#paid {
    width: 10%;
}
#stats {
  background: linear-gradient(180deg, #e3f2fd 0%, #f8f9fa 100%);
  border-radius: 10px;
  padding: 10px 16px;
  margin-top: 15px;
  width: fit-content;
  text-align: left;
  font-weight: 600;
  color: #0d47a1;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  font-size: 15px;
}
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}
.modal.hidden { display: none; }
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
}
.mini-seat.selected {
  background: linear-gradient(145deg,#1565c0,#0d47a1);
  color:#fff;
  transform: scale(1.1);
}
.mini-seat:hover {
  box-shadow: 0 0 6px rgba(33,150,243,0.6);
}
/* üé≠ Mini-plan compact pour l‚Äôajout manuel */
#miniSeatMap {
  display: grid;
  grid-template-columns: repeat(16, 1fr);
  gap: 6px;
  justify-items: center;
  align-items: center;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 12px;
  max-height: 320px;
  overflow: auto;
  box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
}

/* Si√®ge visuel dans le mini-plan */
.mini-seat {
  width: 34px;
  height: 34px;
  border-radius: 6px 6px 8px 8px;
  border: none;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(145deg, #e0e0e0, #bdbdbd);
  color: #212121;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
}

.mini-seat:hover {
  transform: scale(1.1);
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

/* Si√®ge s√©lectionn√© */
.mini-seat.selected {
  background: linear-gradient(145deg, #1565c0, #0d47a1);
  color: #fff;
  box-shadow: 0 0 10px rgba(25,118,210,0.6);
}

/* Strapontins */
.mini-seat[data-strapontin="true"] {
  background: linear-gradient(145deg, #f9a825, #f57f17);
  color: #fff;
}
.mini-seat[data-strapontin="true"].selected {
  background: linear-gradient(145deg, #ffca28, #fbc02d);
}

/* Indication de rang√©e √† gauche */
.mini-row-label {
  grid-column: 1 / -1;
  text-align: left;
  width: 100%;
  margin: 4px 0 0 4px;
  font-weight: 700;
  color: #424242;
}

/* Scrollbar discr√®te */
#miniSeatMap::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
#miniSeatMap::-webkit-scrollbar-thumb {
  background: #90a4ae;
  border-radius: 3px;
}
#miniSeatMap::-webkit-scrollbar-track {
  background: #e0e0e0;
}
button#editPrices {
    background: coral;
}
	input#childCount {
    width: 50%;
}
	input#adultCount {
    width: 50%;
}
	input#babyCount {
    width: 50%;
}
</style>
</head>

<body>
<div id="loader">
  <div class="loader-content">
    <div class="spinner"></div>
    <p>Chargement de la salle‚Ä¶</p>
  </div>
</div>

<h1>üé≠ Th√©√¢tre Saint Martin</h1>
<div class="scene">SC√àNE</div>

<div class="legend">
  <div><span class="free"></span>Libre</div>
  <div><span class="selected"></span>S√©lectionn√©</div>
  <div><span class="reserved"></span>R√©serv√© non pay√©</div>
  <div><span class="strapontin"></span>Strapontin</div>
  <div><span class="paid"></span>R√©serv√© et pay√©</div> <!-- üíö ajout√© -->
</div>

<div class="hall-wrapper">
  <div id="hall"></div>
</div>

<div class="buttons">
  <button id="confirm">‚úÖ Confirmer</button>
  <button id="admin">üîê Admin</button>
  <button id="reset">‚ôªÔ∏è R√©initialiser</button>
  <button id="export" style="display:none;">üì§ Export CSV</button>
  <button id="scanTicket">üéüÔ∏è Scanner un billet</button>
  <button id="editPrices" style="display:none;">üí∂ Modifier les tarifs</button>

    <button id="info">‚ÑπÔ∏è AIDE</button>

</div>
<!-- üí∞ R√©sum√© des statistiques -->
<!-- üí∞ R√©sum√© des statistiques globales -->
<div id="stats-bar" style="
  display:flex;
  justify-content:center;
  align-items:center;
  gap:25px;
  background:#f8f9fa;
  padding:10px 20px;
  margin:10px auto 5px;
  border-radius:12px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
  font-family:'Segoe UI',sans-serif;
  font-weight:600;
  color:#2e7d32;
  flex-wrap:wrap;
">
  <span id="stat-total">üí∞ Total encaiss√© : 0 ‚Ç¨</span>
  <span id="stat-adult">üßç Adultes : 0</span>
  <span id="stat-child">üë∂ Enfants : 0</span>
  <span id="stat-baby">üçº Moins de 8 ans : 0</span>
  <span id="stat-sold">üéüÔ∏è Places r√©serv√©es : 0</span>
</div>


<div id="reservations">
  <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
    <h3>üìã Liste des r√©servations</h3>
	<h4 id="total-amount" style="
  text-align:right;
  color:#2e7d32;
  margin:10px 15px;
  font-size:1rem;
  font-weight:600;
"></h4>

    <div id="legend-paid" style="display: flex; align-items: center; gap: 6px; font-size: 14px;">
      <div style="width:18px; height:18px; background:#c8e6c9; border:1px solid #81c784; border-radius:3px;"></div>
      
    </div>
  </div>

  <div id="resBody"><p>Aucune r√©servation.</p></div>


</div>


<!-- üßæ Fen√™tre modale de r√©servation -->
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <h3>Informations de r√©servation</h3>

    <input id="name" placeholder="Nom complet">
    <input id="email" placeholder="Adresse email">
    <input id="phone" placeholder="T√©l√©phone">

    <div class="payment-group">
      <div class="payment-line">
        <span>Si paiement re√ßu, coche la case</span>
        <input type="checkbox" id="paid">
      </div>
	<div class="payment-line">
  <label for="babyCount">- de 8 ans</label>
  <input id="babyCount" type="number" min="0" value="0" step="1">
</div>

      <div class="payment-line">
        <label for="adultCount">Adultes</label>
        <input id="adultCount" type="number" min="0" value="0" step="1">
      </div>

      <div class="payment-line">
        <label for="childCount">9-14 ans</label>
        <input id="childCount" type="number" min="0" value="0" step="1">
      </div>

      <p id="total-display" style="
        margin:6px 0 0;
        font-weight:600;
        text-align:right;
        color:#2e7d32;
      ">
        Total : 0 ‚Ç¨
      </p>
    </div>

    <div>
      <button id="save">Valider</button>
      <button id="close">Annuler</button>
    </div>
  </div>
</div>



<script type="module">
/* === Attente que Firebase soit pr√™t === */
await new Promise(resolve => {
  const check = () => window._firebaseRef ? resolve() : setTimeout(check, 100);
  check();
});

emailjs.init("2m3fNNkp36a2wCfZn");

const db = window._firebaseDB;
const ref = window._firebaseRef;
const set = window._firebaseSet;
const onValue = window._firebaseOnValue;

let seats = {}, selected = [], admin = false;
const hall = document.getElementById("hall");
const resetBtn = document.getElementById("reset");
const adminBtn = document.getElementById("admin");
const loader = document.getElementById("loader");

/* === Plan de la salle === */
const rows = [...Array(19)].map((_, i) => String.fromCharCode(65 + i));
const seatNums = [15,13,11,9,7,5,3,1,2,4,6,8,10,12,14,16];

rows.forEach(r => {
  const row = document.createElement("div");
  row.className = "row";

  const label = document.createElement("div");
  label.className = "row-label";
  label.textContent = r;
  row.append(label);

  row.append(makeSeat(`${r}-S15`, "S", "strapontin"));
  seatNums.forEach(n => row.append(makeSeat(`${r}-${n}`, n)));
  row.append(makeSeat(`${r}-S16`, "S", "strapontin"));

  hall.append(row);
});

function makeSeat(id, label, extra){
  const d = document.createElement("div");
  d.className = "seat " + (extra || "free");
  d.dataset.id = id;
  d.setAttribute("aria-label", `Si√®ge ${id}`);

  const labelSpan = document.createElement("span");
  labelSpan.textContent = label;
  d.appendChild(labelSpan);

  d.onclick = () => toggle(id, d);
  return d;
}

/* === Connexion Firebase === */
const seatsRef = ref(db, "seats");
onValue(seatsRef, snapshot => {
  seats = snapshot.val() || {};
  render();
  updateTable();
  updateStatsBar(); // ‚úÖ AJOUT ICI ‚Äî met √† jour les compteurs au chargement
  setTimeout(() => loader.classList.add("hidden"), 400);
});

function save(){ set(seatsRef, seats); }

/* === Rendu === */
function render() {
  document.querySelectorAll(".seat").forEach(el => {
    const id = el.dataset.id;
    const wasStrap = el.classList.contains("strapontin");
    el.className = "seat";
    if (wasStrap) el.classList.add("strapontin");

    const seatData = seats[id];
    if (seatData) {
      if (seatData.paid) el.classList.add("paid");
      else el.classList.add("reserved");
    } else if (selected.includes(id)) {
      el.classList.add("selected");
    } else {
      el.classList.add("free");
    }
  });
}

/* === S√©lection === */
function toggle(id, el) {
  if (admin && seats[id]) {
  if (confirm(`üîì Lib√©rer le si√®ge ${id} ?`)) {
    const clientName = seats[id].name;
    delete seats[id];

    // üßÆ Recalculer les totaux restants pour ce client
    let totalA = 0, totalC = 0, totalB = 0;
    let totalAmount = 0;

    for (const data of Object.values(seats)) {
      if (data.name === clientName) {
        totalA += parseInt(data.type === "adulte" ? 1 : 0);
        totalC += parseInt(data.type === "enfant" ? 1 : 0);
        totalB += parseInt(data.type === "moins8" ? 1 : 0);
      }
    }

    totalAmount = totalA * PRICE_ADULT + totalC * PRICE_CHILD;

    // üîÅ Appliquer les nouveaux totaux √† tous les si√®ges restants du client
    for (const [sid, data] of Object.entries(seats)) {
      if (data.name === clientName) {
        data.nbAdult = totalA;
        data.nbChild = totalC;
        data.nbBaby = totalB;
        data.amount = totalAmount;
      }
    }

    save();
    render();
    updateTable();
    updateStatsBar(); // ‚úÖ rafra√Æchit aussi la barre du haut
    alert(`‚úÖ Si√®ge ${id} lib√©r√©. Totaux mis √† jour pour ${clientName}.`);
  }
  return;
}

  if (seats[id]) return alert("‚ö†Ô∏è Ce si√®ge est d√©j√† r√©serv√© !");
  if (selected.includes(id)) selected = selected.filter(s => s !== id);
  else selected.push(id);
  render();
}

/* === Ouvre/ferme la modale === */
document.getElementById("confirm").onclick = () => {
  if (!selected.length) return alert("Aucun si√®ge s√©lectionn√© !");
  document.getElementById("modal").classList.remove("hidden");
};
document.getElementById("close").onclick = () => document.getElementById("modal").classList.add("hidden");

/* === Formatage nom/email/t√©l√©phone === */
function formatPhone(input) {
  let digits = input.replace(/\D/g, "");
  if (digits.startsWith("33")) digits = "0" + digits.slice(2);
  if (digits.startsWith("0033")) digits = "0" + digits.slice(4);
  digits = digits.slice(0, 10);
  return digits.replace(/(\d{2})(?=\d)/g, "$1 ").trim();
}
document.getElementById("name").addEventListener("input", e => e.target.value = e.target.value.toUpperCase());
document.getElementById("email").addEventListener("input", e => e.target.value = e.target.value.toLowerCase());
document.getElementById("phone").addEventListener("input", e => e.target.value = formatPhone(e.target.value));

/* === üßÆ Calcul automatique total (adultes/enfants) === */
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("reset").style.display = "none";

  const adultInput = document.getElementById("adultCount");
  const childInput = document.getElementById("childCount");
  const totalDisplay = document.getElementById("total-display");
  function updateTotal() {
    const nbA = parseInt(adultInput.value) || 0;
const nbE = parseInt(childInput.value) || 0;
const nbB = parseInt(document.getElementById("babyCount").value) || 0; // üë∂ Moins de 8 ans
const total = nbA * PRICE_ADULT + nbE * PRICE_CHILD; // üë∂ Gratuit ou tarif 0 ‚Ç¨

    totalDisplay.textContent = `Total : ${total.toFixed(2)} ‚Ç¨`;
  }
  adultInput.addEventListener("input", updateTotal);
  childInput.addEventListener("input", updateTotal);
});

/* === Validation + enregistrement === */
document.getElementById("save").onclick = async () => {
  const name   = document.getElementById("name").value.trim().toUpperCase();
  const email  = document.getElementById("email").value.trim().toLowerCase();
  const phone  = formatPhone(document.getElementById("phone").value.trim());
  const paid   = document.getElementById("paid").checked;

  const nbAdult = parseInt(document.getElementById("adultCount").value) || 0;
  const nbChild = parseInt(document.getElementById("childCount").value) || 0;
  const nbBaby  = parseInt(document.getElementById("babyCount")?.value || "0") || 0; // "Moins de 8 ans" (gratuit)

  const totalSeats  = selected.length;                  // ‚úÖ manquait
  const totalPeople = nbAdult + nbChild + nbBaby;

  if (!name || !email || !phone) {
    alert("Tous les champs sont requis.");
    return;
  }
  if (totalPeople !== totalSeats) {
    alert(`‚ö†Ô∏è Le nombre total de personnes (${totalPeople}) doit correspondre au nombre de si√®ges s√©lectionn√©s (${totalSeats}).`);
    return;
  }

  // üí∂ Moins de 8 ans = gratuit. Utilise les tarifs configurables si pr√©sents.
  const amount = nbAdult * (typeof PRICE_ADULT === "number" ? PRICE_ADULT : 14)
               + nbChild * (typeof PRICE_CHILD === "number" ? PRICE_CHILD : 10);

  const user = { name, email, phone, paid, nbAdult, nbChild, nbBaby, amount };

  // R√©partition des types par si√®ge
  let adultRemaining = nbAdult;
  let childRemaining = nbChild;
  let babyRemaining  = nbBaby;

  selected.forEach(id => {
    if (!seats[id]) {
      const seatData = { ...user };
      if (adultRemaining > 0) {
        seatData.type = "adulte";
        adultRemaining--;
      } else if (childRemaining > 0) {
        seatData.type = "enfant";
        childRemaining--;
      } else if (babyRemaining > 0) {
        seatData.type = "moins8";
        babyRemaining--;
      } else {
        seatData.type = "autre";
      }
      seats[id] = seatData;
    }
  });

  save();
  await sendEmail(user);
  selected = [];
  document.getElementById("modal").classList.add("hidden");
  updateStatsBar(); // ‚úÖ met √† jour la barre du haut imm√©diatement

  alert(`‚úÖ R√©servation confirm√©e : ${nbAdult} adulte(s), ${nbChild} enfant(s), ${nbBaby} (-8 ans) ‚Äî Total ${amount} ‚Ç¨.`);
};


/* === Email + QR === */
async function sendEmail(user) {
  const reservedSeats = Object.entries(seats)
    .filter(([_, v]) => v.email === user.email)
    .map(([id]) => id)
    .join(", ");
  const qrData = JSON.stringify({ nom: user.name, email: user.email, tel: user.phone, sieges: reservedSeats });
  const qrImage = await QRCode.toDataURL(qrData, { width: 180 });
  emailjs.send("service_91fpmi6", "template_xzjnnc2", {
    to_name: user.name,
    to_email: user.email,
    seats: reservedSeats,
    phone: user.phone,
    qr_image: qrImage
  }).then(() => console.log("‚úÖ Email envoy√©")).catch(err => console.error("‚ùå Erreur EmailJS :", err));
}

/* === Mode Admin === */
adminBtn.onclick = () => {
  const scanBtn = document.getElementById("scanTicket");
  const infoBtn = document.getElementById("info");

  if (!admin) {
    const p = prompt("Mot de passe admin :");
    if (p === "admin123") {
      admin = true;
      alert("‚úÖ Mode admin activ√©");
      resetBtn.style.display = "inline-block";
      document.getElementById("export").style.display = "inline-block";
      scanBtn.style.display = "none";
      infoBtn.style.display = "none";
      document.body.classList.add("admin");
      adminBtn.textContent = "üö™ Sortir du mode admin";
      updateTable();

      toggleAdminUI(); // ‚úÖ ajoute cette ligne ici aussi
    } else {
      alert("‚ùå Mot de passe incorrect.");
    }
  } else {
    admin = false;
    alert("üëã Mode admin d√©sactiv√©");
    resetBtn.style.display = "none";
    document.getElementById("export").style.display = "none";
    scanBtn.style.display = "inline-block";
    infoBtn.style.display = "inline-block";
    document.body.classList.remove("admin");
    adminBtn.textContent = "üîê Admin";
    updateTable();
    toggleAdminUI(); // ‚úÖ d√©j√† pr√©sent ici
  }
};



/* === R√©initialiser === */
resetBtn.onclick = () => {
  if (!admin) return alert("Activez le mode admin.");
  if (confirm("Effacer toutes les r√©servations ?")) {
    seats = {};
    save();
	updateStatsBar(); // ‚úÖ ajout ici
    alert("‚úÖ R√©initialisation compl√®te.");
  }
};

/* === Export CSV === */
document.getElementById("export").onclick = () => {
  const entries = Object.entries(seats)
    .sort(([a], [b]) => a.localeCompare(b, 'fr', { numeric: true }));
  const now = new Date().toLocaleString("fr-FR");
  let csv = `Export des r√©servations ‚Äì Th√©√¢tre Saint Martin (${now})\n\n`;
  csv += "RANG√âE;SI√àGE;NOM;EMAIL;T√âL√âPHONE;ADULTES;ENFANTS;MOINS_DE_X_ANS;TOTAL(‚Ç¨)\n";

  for (const [k, v] of entries) {
    const [r, s] = k.split("-");
csv += `${r};${s};${v.name};${v.email};${v.phone};${v.nbAdult||0};${v.nbChild||0};${v.nbBaby||0};${v.amount||0}\n`;
  }
  csv += `\nTOTAL R√âSERVATIONS;${entries.length}\n`;
  const bom = "\uFEFF";
  const blob = new Blob([bom + csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `reservations_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
};

/* === Liste r√©servations === */
function updateTable() {
  const container = document.getElementById("resBody");
  container.innerHTML = "";
  const entries = Object.entries(seats || {});
  if (!entries.length) return container.innerHTML = '<p>Aucune r√©servation.</p>';

  // === Regroupement des r√©servations par client ===
const grouped = {};

for (const [id, data] of entries) {
  const key = data.name || "Inconnu";

  if (!grouped[key]) {
    grouped[key] = {
      ...data,
      seats: [],
      emails: new Set(),
      allPaid: true,
    };
  }

  grouped[key].seats.push({
    id,
    paid: data.paid || false,
    nbAdult: data.nbAdult || 0,
    nbChild: data.nbChild || 0,
  });


  grouped[key].emails.add(data.email || "N/A");

  // ‚úÖ Si au moins un si√®ge n‚Äôest pas pay√© ‚Üí la ligne sera rose
  if (!data.paid) grouped[key].allPaid = false;
}



  const sorted = Object.entries(grouped).sort(([, a], [, b]) =>
    (a.name || "").localeCompare(b.name || "", "fr", { sensitivity: "base" })
  );

  for (const [name, info] of sorted) {
  const div = document.createElement("div");
  div.className = "accordion";
  const header = document.createElement("div");
  header.className = `accordion-header ${info.allPaid ? "paid" : "unpaid"}`;
  header.innerHTML = `
    <div>üë§ ${name}</div>
    <div>${info.allPaid ? "üí∞ Tous pay√©s" : "‚ùå Partiel / Non pay√©"}</div>
  `;
  header.onclick = () => div.classList.toggle("open");

  const content = document.createElement("div");
  content.className = "accordion-content";
  content.innerHTML = `
  ${[...info.emails].map(e => `<p><strong>Email :</strong> ${e}</p>`).join("")}
  <p><strong>T√©l√©phone :</strong> ${info.phone || "N/A"}</p>
  ${(() => {
  // üß† R√©cup√®re les si√®ges par type si disponible,
  // sinon les r√©partit selon les nombres de personnes enregistr√©es.
  const allSeats = [...info.seats];
  let adults = allSeats.filter(s => s.type === "adulte");
  let children = allSeats.filter(s => s.type === "enfant");
  let babies = allSeats.filter(s => s.type === "moins8");

  // ‚úÖ Si aucun type n‚Äôest d√©fini, on r√©partit dans l‚Äôordre :
  if (!adults.length && !children.length && !babies.length) {
    const nbA = info.nbAdult || 0;
    const nbC = info.nbChild || 0;
    const nbB = info.nbBaby || 0;

    adults = allSeats.slice(0, nbA);
    children = allSeats.slice(nbA, nbA + nbC);
    babies = allSeats.slice(nbA + nbC, nbA + nbC + nbB);
  }

  const adultSeats = adults.map(s => s.id).join(", ") || "‚Äî";
  const childSeats = children.map(s => s.id).join(", ") || "‚Äî";
  const babySeats  = babies.map(s => s.id).join(", ") || "‚Äî";

  return `
    <p><strong>üßç Adultes :</strong> ${info.nbAdult || 0} √ó ${PRICE_ADULT} ‚Ç¨ ‚Üí 
      <span style="color:#1565c0;font-weight:600">${adultSeats}</span>
    </p>
    <p><strong>üëß Enfants :</strong> ${info.nbChild || 0} √ó ${PRICE_CHILD} ‚Ç¨ ‚Üí 
      <span style="color:#0288d1;font-weight:600">${childSeats}</span>
    </p>
    <p><strong>üçº Moins de 8 ans :</strong> ${info.nbBaby || 0} ‚Üí 
      <span style="color:#6a1b9a;font-weight:600">${babySeats}</span>
    </p>
    <p><strong>Total :</strong> ${info.amount ? info.amount.toFixed(2) + " ‚Ç¨" : "0 ‚Ç¨"}</p>
  `;
})()}


${(() => {
  // üß© On reconstruit les groupes de si√®ges par type.
  const adultSeats = info.seats
    .filter(s => (s.type === "adulte") || (!s.type && /[13579]$/.test(s.id))) // üîÅ fallback si pas de type
    .map(s => s.id)
    .join(", ") || "‚Äî";

  const childSeats = info.seats
    .filter(s => (s.type === "enfant") || (!s.type && /[02468]$/.test(s.id))) // üîÅ fallback simple
    .map(s => s.id)
    .join(", ") || "‚Äî";

  const babySeats = info.seats
    .filter(s => s.type === "moins8")
    .map(s => s.id)
    .join(", ") || "‚Äî";

  // ‚úÖ On renvoie le HTML voulu (sinon ‚Üí undefined)
  return `
  
  `;
})()}




    <div class="seat-list" style="margin-top:8px;">
      ${info.seats.map(s => {
        const type = s.type === "adulte" ? "üßç" : s.type === "enfant" ? "üë∂" : "üéüÔ∏è";
        const paidIcon = s.paid ? "üí∞" : "‚ùå";
        return `
          <span class="badge-seat" style="
            background:${s.paid ? "#43a047" : "#ef5350"};
            color:white;
            border-radius:6px;
            padding:4px 8px;
            font-size:0.85rem;
          ">${type} ${s.id} ${paidIcon}</span>`;
      }).join("")}
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
      <label>üí∂ Tout pay√© <input type="checkbox" class="paid-toggle-client" data-name="${name}" ${info.allPaid ? "checked" : ""}></label>
      ${admin ? `<button class="add-seat-btn" data-name="${name}" style="background:#1565c0;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">‚ûï Ajouter si√®ge</button>` : ""}
    </div>
  `;

  div.append(header, content);
  container.append(div);
}


  // === Gestion stable de la case "Tout pay√©" (sans cumul) ===
document.querySelectorAll(".paid-toggle-client").forEach(cb => {
  cb.addEventListener("change", e => {
    if (!admin) {
      alert("‚ö†Ô∏è Vous devez √™tre en mode admin pour modifier le paiement.");
      e.target.checked = !e.target.checked;
      return;
    }

    const clientName = e.target.dataset.name;
    const isPaid = e.target.checked;
    const clientSeats = Object.entries(seats).filter(([_, d]) => d.name === clientName);
    if (!clientSeats.length) return;

    if (isPaid) {
      // ‚úÖ Marque tout comme pay√©, sans modifier les quantit√©s existantes
      for (const [id, data] of clientSeats) {
        data.paid = true;

        // üí∂ recalcul du montant uniquement si inexistant
        if (!data.amount || data.amount === 0) {
          const nbA = parseInt(data.nbAdult || 0);
          const nbC = parseInt(data.nbChild || 0);
          data.amount = nbA * PRICE_ADULT + nbC * PRICE_CHILD;
        }
      }

      save();
      render();
      updateTable();
      updateStatsBar();
      console.log(`‚úÖ ${clientName} marqu√© comme pay√© (montants recalcul√©s si n√©cessaire)`);

    } else {
      // ‚ùå Annule le paiement sans toucher aux quantit√©s
      for (const [id, data] of clientSeats) {
        data.paid = false;
      }

      save();
      render();
      updateTable();
      updateStatsBar();
      console.log(`‚ùå Paiement retir√© pour ${clientName}`);
    }
  });
});



// === Ajouter des si√®ges manuellement (mode admin) ===
document.querySelectorAll(".add-seat-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    if (!admin) return alert("‚ö†Ô∏è Activez le mode admin.");
    const clientName = btn.dataset.name;
    const clientSeat = Object.entries(seats).find(([_, d]) => d.name === clientName);
    if (!clientSeat) return alert("‚ùå Client introuvable.");

    const modal = document.getElementById("addSeatModal");
    const map = document.getElementById("miniSeatMap");
    const manualInput = document.getElementById("manualSeatInput");
    const paidBox = document.getElementById("addSeatPaid");
    const adultInput = document.getElementById("addSeatAdult");
    const childInput = document.getElementById("addSeatChild");
    const babyInput = document.getElementById("addSeatBaby");
    const totalDisplay = document.getElementById("addSeatTotal");

    document.getElementById("addSeatClient").textContent = `Client : ${clientName}`;
    map.innerHTML = "";
    manualInput.value = "";
    paidBox.checked = false;
    adultInput.value = 0;
    childInput.value = 0;
    babyInput.value = 0;
    totalDisplay.textContent = "Total : 0 ‚Ç¨";

    // üé® Affichage des si√®ges libres (mini version)
    const allSeats = Array.from(document.querySelectorAll(".seat.free"));
    allSeats.forEach(el => {
      const id = el.dataset.id;
      const seatBtn = document.createElement("button");
      seatBtn.textContent = id;
      seatBtn.className = "mini-seat";
      seatBtn.style.cssText = `
        width:45px;height:30px;
        border:none;
        border-radius:6px;
        background:#e0e0e0;
        color:#000;
        cursor:pointer;
        font-size:12px;
        font-weight:600;
      `;
      seatBtn.onclick = () => seatBtn.classList.toggle("selected");
      map.appendChild(seatBtn);
    });

    // üßÆ Recalcul du total
    function updateTotal() {
      const a = parseInt(adultInput.value) || 0;
      const c = parseInt(childInput.value) || 0;
      const b = parseInt(babyInput.value) || 0;
      totalDisplay.textContent = `Total : ${(a * PRICE_ADULT + c * PRICE_CHILD).toFixed(2)} ‚Ç¨`; // üë∂ Moins de 8 ans gratuit
    }
    adultInput.oninput = childInput.oninput = babyInput.oninput = updateTotal;

    modal.classList.remove("hidden");

    document.getElementById("addSeatCancel").onclick = () => modal.classList.add("hidden");

    document.getElementById("addSeatConfirm").onclick = () => {
  const chosen = Array.from(map.querySelectorAll(".mini-seat.selected")).map(b => b.textContent);
  const typed = manualInput.value.split(",").map(s => s.trim().toUpperCase()).filter(Boolean);
  const allChosen = [...chosen, ...typed];
  const nbA = parseInt(adultInput.value) || 0;
  const nbC = parseInt(childInput.value) || 0;
  const nbB = parseInt(babyInput.value) || 0;
  const totalPeople = nbA + nbC + nbB;
  const totalAdd = nbA * PRICE_ADULT + nbC * PRICE_CHILD; // üë∂ moins de 8 ans gratuit

  if (!allChosen.length) return alert("‚ö†Ô∏è Aucun si√®ge s√©lectionn√©.");
  if (totalPeople !== allChosen.length)
    return alert(`‚ö†Ô∏è ${totalPeople} personne(s) pour ${allChosen.length} si√®ge(s).`);

  // üîç R√©cup√®re les anciens totaux du client
  let oldA = 0, oldC = 0, oldB = 0, oldTotal = 0;
  for (const [sid, data] of Object.entries(seats)) {
    if (data.name === clientName) {
      oldA = parseInt(data.nbAdult || 0);
      oldC = parseInt(data.nbChild || 0);
      oldB = parseInt(data.nbBaby  || 0);
      oldTotal = parseFloat(data.amount || 0);
      break;
    }
  }

  const newA = oldA + nbA;
  const newC = oldC + nbC;
  const newB = oldB + nbB;
  const newTotal = oldTotal + totalAdd;

  // ü™ë Ajout des nouveaux si√®ges
  let added = 0;
  for (let id of allChosen) {

    // ‚úÖ Correction : normalise les IDs pour les strapontins ("S15", "S16" ‚Üí "A-S15", etc.)
    if (/^S\d+$/i.test(id)) {
      id = `A-${id}`; // üü° tu peux changer la lettre de rang√©e ici si besoin
    }

    const seatEl = document.querySelector(`.seat[data-id="${id}"]`);
    console.log("Ajout manuel :", id, "‚Üí", seatEl ? "OK" : "non trouv√©");

    if (!seatEl) {
      alert(`‚ö†Ô∏è Le si√®ge ${id} n'existe pas dans le plan.`);
      continue;
    }

    if (!seatEl.classList.contains("free")) {
      alert(`‚ö†Ô∏è Le si√®ge ${id} est d√©j√† r√©serv√©.`);
      continue;
    }

    const type = added < nbA ? "adulte" : added < nbA + nbC ? "enfant" : "moins8";

    seats[id] = {
      ...clientSeat[1],
      paid: paidBox.checked,
      nbAdult: newA,
      nbChild: newC,
      nbBaby: newB,
      type,
      amount: newTotal,
    };
    added++;
  }

  // ‚úÖ Met √† jour TOUS les si√®ges du client avec les nouveaux totaux
  for (const [sid, data] of Object.entries(seats)) {
    if (data.name === clientName) {
      data.nbAdult = newA;
      data.nbChild = newC;
      data.nbBaby  = newB;
      data.amount  = newTotal;
    }
  }

  if (added > 0) {
    save();
    render();       // üü¢ met √† jour visuellement le plan
    updateTable();  // üü¢ met √† jour la liste de r√©servations
    updateStatsBar(); // üßÆ met √† jour la barre de stats

    // ‚ú® Ouvre automatiquement l‚Äôaccord√©on du client ajout√©
    setTimeout(() => {
      const accHeader = [...document.querySelectorAll('.accordion-header')]
        .find(h => h.textContent.includes(clientName));
      if (accHeader && accHeader.parentElement) {
        accHeader.parentElement.classList.add('open');
        accHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
        accHeader.style.transition = "background 0.4s";
        accHeader.style.background = "#fff59d";
        setTimeout(() => accHeader.style.background = "", 1200);
      }
    }, 300);

    alert(`‚úÖ ${added} si√®ge(s) ajout√©(s) √† ${clientName} (${newA} adultes, ${newC} enfants, ${newB} -8 ans).`);
  }

  modal.classList.add("hidden");
};


  });
});





} // ‚Üê derni√®re accolade de la fonction updateTable()





/* === Scanner et Aide === */
document.getElementById("scanTicket").onclick = () => window.location.href = "scanner.html";
document.getElementById("info").onclick = () => window.open("mode_emploi.pdf", "_blank");

/* === Zoom/drag mobile (version fluide) === */
const wrapper = document.querySelector(".hall-wrapper");
let scale = 1;
let lastDist = 0;
let startMid = { x: 0, y: 0 };
let translate = { x: 0, y: 0 };

wrapper.addEventListener("touchstart", (e) => {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    lastDist = Math.hypot(dx, dy);
    startMid = {
      x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
      y: (e.touches[0].clientY + e.touches[1].clientY) / 2,
    };
  }
});

wrapper.addEventListener("touchmove", (e) => {
  if (e.touches.length === 2) {
    e.preventDefault(); // on bloque le scroll seulement pendant le zoom
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.hypot(dx, dy);

    if (lastDist) {
      const delta = dist / lastDist;
      scale = Math.max(0.8, Math.min(3, scale * delta));
      hall.style.transform = `scale(${scale})`;
    }

    lastDist = dist;
  }
});

wrapper.addEventListener("touchend", (e) => {
  if (e.touches.length < 2) lastDist = 0;
});


wrapper.addEventListener("touchend", e => {
  if (e.touches.length < 2) lastDist = 0;
  if (e.touches.length === 0) isDragging = false;
});


/* === üí∂ Gestion des tarifs personnalisables === */
const editPricesBtn = document.getElementById("editPrices");
const priceModal = document.getElementById("priceModal");
const priceAdultInput = document.getElementById("priceAdult");
const priceChildInput = document.getElementById("priceChild");

// === Valeurs par d√©faut ou charg√©es du localStorage ===
let PRICE_ADULT = parseFloat(localStorage.getItem("PRICE_ADULT")) || 14;
let PRICE_CHILD = parseFloat(localStorage.getItem("PRICE_CHILD")) || 10;

/* === Affiche les tarifs actuels dans les labels === */
function updatePriceLabels() {
  const mainAdult = document.getElementById("labelPriceAdult");
  const mainChild = document.getElementById("labelPriceChild");
  const addAdult = document.getElementById("labelAddSeatPriceAdult");
  const addChild = document.getElementById("labelAddSeatPriceChild");

  if (mainAdult) mainAdult.textContent = PRICE_ADULT.toFixed(2);
  if (mainChild) mainChild.textContent = PRICE_CHILD.toFixed(2);
  if (addAdult) addAdult.textContent = PRICE_ADULT.toFixed(2);
  if (addChild) addChild.textContent = PRICE_CHILD.toFixed(2);
}

/* === Ouvrir la modale === */
function openPriceModal() {
  priceAdultInput.value = PRICE_ADULT;
  priceChildInput.value = PRICE_CHILD;
  priceModal.classList.remove("hidden");
}

/* === Fermer la modale === */
document.getElementById("cancelPrices").onclick = () => {
  priceModal.classList.add("hidden");
};

/* === Enregistrer les nouveaux tarifs === */
document.getElementById("savePrices").onclick = () => {
  const newAdult = parseFloat(priceAdultInput.value);
  const newChild = parseFloat(priceChildInput.value);
  if (isNaN(newAdult) || isNaN(newChild)) {
    alert("‚ö†Ô∏è Les tarifs doivent √™tre des nombres valides.");
    return;
  }

  const oldAdult = PRICE_ADULT;
  const oldChild = PRICE_CHILD;

  PRICE_ADULT = newAdult;
  PRICE_CHILD = newChild;

  localStorage.setItem("PRICE_ADULT", PRICE_ADULT);
  localStorage.setItem("PRICE_CHILD", PRICE_CHILD);

  updatePriceLabels();
  render();
  updateTable();

  const msg = document.getElementById("priceMessage");
  msg.textContent = `‚úîÔ∏è Tarifs mis √† jour :
  Adulte : ${oldAdult.toFixed(2)} ‚Ç¨ ‚Üí ${PRICE_ADULT.toFixed(2)} ‚Ç¨ | 
  Enfant : ${oldChild.toFixed(2)} ‚Ç¨ ‚Üí ${PRICE_CHILD.toFixed(2)} ‚Ç¨`;
  msg.style.display = "block";
  msg.style.opacity = 1;

  // Effet de disparition douce
  setTimeout(() => {
    msg.style.transition = "opacity 0.5s";
    msg.style.opacity = 0;
    setTimeout(() => {
      msg.style.display = "none";
      priceModal.classList.add("hidden");
    }, 600);
  }, 1800);
};



/* === Afficher le bouton si admin === */
function toggleAdminUI() {
  const isAdmin = document.body.classList.contains("admin");
  editPricesBtn.style.display = isAdmin ? "inline-block" : "none";
}




/* === Lier le bouton principal === */
editPricesBtn.onclick = openPriceModal;

/* === Initialiser au d√©marrage === */
updatePriceLabels();
toggleAdminUI();

// === üîÑ Mise √† jour compl√®te de la barre de statistiques ===
function updateStatsBar() {
  let totalAmount = 0;
  let totalAdult = 0;
  let totalChild = 0;
  let totalBaby = 0;
  let soldSeats = Object.keys(seats).length;
  const processedClients = new Set();

  for (const data of Object.values(seats)) {
    if (data.paid && !processedClients.has(data.name)) {
      let amount = parseFloat(data.amount);
      if (isNaN(amount) || amount === 0) {
        const nbA = parseInt(data.nbAdult || 0);
        const nbC = parseInt(data.nbChild || 0);
        amount = nbA * PRICE_ADULT + nbC * PRICE_CHILD;
      }

      totalAmount += amount;
      totalAdult += parseInt(data.nbAdult || 0);
      totalChild += parseInt(data.nbChild || 0);
      totalBaby += parseInt(data.nbBaby || 0);
      processedClients.add(data.name);
    }
  }

  document.getElementById("stat-total").textContent = `üí∞ Total encaiss√© : ${totalAmount.toFixed(2)} ‚Ç¨`;
  document.getElementById("stat-adult").textContent = `üßç Adultes : ${totalAdult}`;
  document.getElementById("stat-child").textContent = `üë∂ Enfants : ${totalChild}`;
  document.getElementById("stat-baby").textContent = `üçº Moins de 8 ans : ${totalBaby}`;
  document.getElementById("stat-sold").textContent = `üéüÔ∏è Places r√©serv√©es : ${soldSeats}`;
}



</script>

<!-- üßÆ Fen√™tre admin : saisie adultes/enfants -->
<div id="adminPaymentModal" class="modal hidden">
  <div class="modal-content">
    <h3>üí∞ Saisie du paiement</h3>
    <p id="adminClientName" style="font-weight:600;margin-bottom:10px;"></p>

    <label for="adminAdult">Nombre d‚Äôadultes (14 ‚Ç¨)</label>
    <input id="adminAdult" type="number" min="0" value="0" step="1">

    <label for="adminChild">Nombre d‚Äôenfants (10 ‚Ç¨)</label>
    <input id="adminChild" type="number" min="0" value="0" step="1">
	<label for="adminBaby">Nombre de moins de 8 ans</label>
<input id="adminBaby" type="number" min="0" value="0" step="1">


    <p id="adminTotal" style="font-weight:600;color:#2e7d32;margin-top:8px;">Total : 0 ‚Ç¨</p>

    <div style="margin-top:12px;">
      <button id="adminSavePayment">Valider</button>
      <button id="adminCancelPayment">Annuler</button>
    </div>
  </div>
</div>
<!-- üÜï Modale ajout manuel de si√®ges -->
<!-- üÜï Modale ajout manuel de si√®ges -->
<div id="addSeatModal" class="modal hidden">
  <div class="modal-content" style="max-width:480px;">
    <h3>‚ûï Ajouter des si√®ges</h3>
    <p id="addSeatClient" style="font-weight:600;margin-bottom:10px;"></p>

    <!-- üß≠ Mini plan des si√®ges -->
    <div id="miniSeatMap" style="
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap:5px;
      justify-items:center;
      margin-bottom:10px;
      max-height:250px;
      overflow-y:auto;
      padding:8px;
      background:#fafafa;
      border-radius:8px;
      border:1px solid #ddd;
    "></div>

    <p style="font-weight:600;">ou saisir manuellement :</p>
    <input id="manualSeatInput" type="text" placeholder="Ex : A12, B3, S9" style="width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:6px;margin-bottom:10px;">

    <div class="payment-group">
      <div class="payment-line">
        <label for="addSeatAdult">Adultes (${PRICE_ADULT} ‚Ç¨)</label>
        <input id="addSeatAdult" type="number" min="0" value="0" step="1" style="width:60px;">
      </div>
	  <div class="payment-line">
  <label for="addSeatBaby">Moins de 8 ans</label>
  <input id="addSeatBaby" type="number" min="0" value="0" step="1" style="width:60px;">
</div>

      <div class="payment-line">
        <label for="addSeatChild">Enfants (${PRICE_CHILD} ‚Ç¨)</label>
        <input id="addSeatChild" type="number" min="0" value="0" step="1" style="width:60px;">
      </div>
      <p id="addSeatTotal" style="margin-top:8px;text-align:right;font-weight:600;color:#2e7d32;">Total : 0 ‚Ç¨</p>
    </div>

    <label style="display:flex;align-items:center;gap:6px;margin:10px 0;">
      <input type="checkbox" id="addSeatPaid">
      üí∂ Marquer ces si√®ges comme pay√©s
    </label>

    <div style="margin-top:12px;">
      <button id="addSeatConfirm">Valider</button>
      <button id="addSeatCancel">Annuler</button>
    </div>
  </div>
</div>


<!-- üí∂ Fen√™tre modale de modification des tarifs -->
<div id="priceModal" class="modal hidden">
  <div class="modal-content">
    <h3>üí∂ Modifier les tarifs</h3>

<label for="priceAdult">Tarif adulte (‚Ç¨)</label>
<input id="priceAdult" type="number" min="0" step="0.5" value="14">
<span id="labelPriceAdult" style="display:none;"></span>

<label for="priceChild">Tarif enfant (‚Ç¨)</label>
<input id="priceChild" type="number" min="0" step="0.5" value="10">
<span id="labelPriceChild" style="display:none;"></span>


    <div style="margin-top:12px;">
      <button id="savePrices">Enregistrer</button>
      <button id="cancelPrices">Annuler</button>
    </div>
  </div>
</div>




</body>
</html>














































































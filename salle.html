<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üé≠ Th√©√¢tre Saint Martin ‚Äì R√©servations</title>
	

<!-- Librairies externes -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>






<!-- ‚úÖ Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyXXXX_TON_API_KEY",
    authDomain: "theatre-saint-martin.firebaseapp.com",
    databaseURL: "https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "theatre-saint-martin",
    storageBucket: "theatre-saint-martin.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcd1234efgh"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window._firebaseDB = db;
  window._firebaseRef = ref;
  window._firebaseSet = set;
  window._firebaseOnValue = onValue;
  window._firebaseGet = get;

  console.log("üî• Firebase initialis√© :", db);
</script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(180deg, #e3f2fd 0%, #fafafa 100%);
  margin: 0;
  text-align: center;
  color: #212121;
}
h1 {
  color: #0d47a1;
  margin: 20px 0;
  font-size: 1.8rem;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}
  #legend-paid {
  background: #f1f8e9;
  padding: 4px 8px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.scene {
  background: #212121;
  color: #fff;
  width: 80%;
  max-width: 800px;
  margin: 10px auto 20px;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
  font-weight: 600;
  letter-spacing: 1px;
}
.legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 15px;
  font-size: 14px;
}
.legend div { display: flex; align-items: center; gap: 5px; }
.legend span { width: 18px; height: 18px; border-radius: 3px; display: inline-block; }
.free { background: #e0e0e0; }
.selected { background: #64b5f6; }
.reserved { background: #ef5350; }
.strapontin { background: #ffd54f; }
.seat.strapontin.selected { background: #82b1ff !important; }

/* === Conteneur principal === */
.hall-wrapper {
  display: block;
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  touch-action: pinch-zoom pan-x pan-y;
  padding: 10px 0;
  box-sizing: border-box;
  background: transparent;
  text-align: center;  /* ‚úÖ centre par d√©faut */
}

/* === Bloc des si√®ges === */
#hall {
  display: inline-flex;             /* ‚úÖ permet le centrage avec text-align: center */
  flex-direction: column;
  align-items: center;
  background: #fff;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,.15);
  transition: transform 0.2s ease;
}

/* === üåê Correction responsive : sur mobile, on d√©sactive le centrage pour garder le scroll complet === */
@media (max-width: 768px) {
  .hall-wrapper {
    text-align: left;              /* ‚úÖ permet le scroll total (gauche et droite) */
    padding-left: 10px;
  }
  #hall {
    display: flex;                 /* ‚úÖ comportement normal sans centrage forc√© */
    width: max-content;
  }
}




.row {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: nowrap;
  margin: 4px 0;
}
.row-label {
  font-weight: 600;
  margin-right: 8px;
  min-width: 18px;
}
/* === STYLE DES SI√àGES (R√âALISTES + CENTR√âS) === */
.seat {
  position: relative;
  width: 34px;
  height: 34px;
  margin: 4px;
  border-radius: 6px 6px 8px 8px;
  cursor: pointer;
  display: inline-block;
  overflow: hidden;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  transform-origin: bottom center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  font-weight: 700;
  color: #fff;
}

/* ‚úÖ Texte centr√© parfaitement au milieu du si√®ge */
.seat span {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  text-align: center;
  font-size: 0.95em;
  line-height: 1;
  pointer-events: none;
}

/* === Effets du dossier et de l‚Äôassise === */
.seat::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 60%;
  border-radius: 6px 6px 0 0;
  background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0)),
              radial-gradient(circle at top left, rgba(255,255,255,0.2), transparent);
  pointer-events: none;
}

.seat::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 45%;
  border-radius: 0 0 8px 8px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  pointer-events: none;
}

/* === √âTATS DES SI√àGES === */

/* üî¥ Libre */
.free {
  background: linear-gradient(145deg, #c62828, #8e0000);
  box-shadow: 0 2px 5px rgba(0,0,0,0.25);
}
.free:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 10px rgba(0,0,0,0.35);
}

/* üîµ S√©lectionn√© */
.selected {
  background: linear-gradient(145deg, #1565c0, #0d47a1);
  box-shadow: 0 4px 10px rgba(13,71,161,0.4);
  transform: scale(1.1);
}

/* ‚ö´ R√©serv√© */
/* ‚ö´ R√©serv√© non pay√© ‚Äî rose clair */
.reserved {
  background: #f8bbd0 !important;
  color: #212121;
  cursor: not-allowed;
  box-shadow: 0 0 6px rgba(233,30,99,0.3);
  opacity: 1;
}
/* üü° Strapontin r√©serv√© (m√™me rose) */
.seat.strapontin.reserved {
  background: #f8bbd0 !important;
  color: #212121;
  box-shadow: 0 0 6px rgba(233,30,99,0.3);
}

/* üíö Si√®ge r√©serv√© et pay√© */
/* üíö L√©gende Pay√© */
.paid {
  background: linear-gradient(145deg, #43a047, #2e7d32);
  box-shadow: 0 0 4px rgba(67,160,71,0.6);
}



/* üü° Strapontin */
.strapontin {
  background: linear-gradient(145deg, #f9a825, #f57f17);
  box-shadow: 0 3px 6px rgba(0,0,0,0.25);
}
.seat.strapontin.selected {
  background: linear-gradient(145deg, #ffca28, #fbc02d);
  box-shadow: 0 0 10px rgba(255,193,7,0.6);
}

/* === Ajustement Mobile === */
@media (max-width: 600px) {
  .seat {
    width: 26px;
    height: 26px;
    margin: 2px;
  }
  .seat span {
    font-size: 12px;
  }
}

.buttons {
  margin: 20px 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
}
button {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: .3s;
}
#confirm { background: #2e7d32; } #confirm:hover { background: #1b5e20; }
#admin { background: #d32f2f; } #admin:hover { background: #b71c1c; }
#reset { background: #455a64; } #reset:hover { background: #263238; }
#export { background: #009688; } #export:hover { background: #00695c; }
#scanTicket { background: #8e24aa; } #scanTicket:hover { background: #6a1b9a; }
#save {
    background: black;
}
#close {
    background: black;
}
#reservations {
  margin: 20px auto;
  width: 90%;
  max-width: 800px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  padding: 10px;
}
#reservations h3 {
  text-align: left;
  margin: 10px;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 6px;
}
#reservations table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
#reservations th, #reservations td {
  border-bottom: 1px solid #ddd;
  padding: 6px;
  text-align: left;
}
#reservations th { background: #1976d2; color: #fff; }

.modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,.5); display: flex; justify-content: center; align-items: center; z-index: 10;
}
.modal.hidden { display: none; }
.modal-content {
  background: #fff; padding: 20px; border-radius: 10px; width: 300px;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
}
.modal-content input {
  width: 90%; margin: 6px auto; padding: 8px; border: 1px solid #ccc;
  border-radius: 5px; display: block;
}
#loader {
  position: fixed; inset: 0;
  background: linear-gradient(180deg,#e3f2fd 0%,#fafafa 100%);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999; transition: opacity .4s ease;
}
#loader.hidden { opacity: 0; pointer-events: none; }
.loader-content { text-align: center; color: #0d47a1; font-weight: 600; font-size: 1.1rem; }
.spinner {
  width: 40px; height: 40px;
  border: 4px solid #bbdefb;
  border-top: 4px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px;
}
  /* === STYLE FAUTEUILS R√âALISTES === */
.seat {
  position: relative;
  width: 34px;
  height: 34px;
  margin: 4px;
  border-radius: 6px 6px 8px 8px;
  cursor: pointer;
  display: inline-block;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  transform-origin: bottom center;
}

/* Dossier (partie haute) */
.seat::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 60%;
  border-radius: 6px 6px 0 0;
  background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0)),
              radial-gradient(circle at top left, rgba(255,255,255,0.2), transparent);
  pointer-events: none;
}

/* Assise (partie basse) */
.seat::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 45%;
  border-radius: 0 0 8px 8px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  pointer-events: none;
}

/* üî¥ Si√®ge libre */
.free {
  background: linear-gradient(145deg, #c62828, #8e0000);
  box-shadow: 0 2px 5px rgba(0,0,0,0.25);
  color: #fff; /* texte blanc */
}
.free:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 10px rgba(0,0,0,0.35);
}

/* üîµ S√©lectionn√© */
.selected {
  background: linear-gradient(145deg, #1565c0, #0d47a1);
  box-shadow: 0 4px 10px rgba(13,71,161,0.4);
  transform: scale(1.1);
  color: #fff; /* texte blanc */
}

/* ‚ö´ R√©serv√© */
.reserved {
  background: linear-gradient(145deg, #7c787773, #3e272300);
  opacity: 0.8;
  cursor: not-allowed;
  box-shadow: inset 0 2px 4px rgba(255,255,255,0.1);
}

/* üü° Strapontin */
.strapontin {
  background: linear-gradient(145deg, #f9a825, #f57f17);
  box-shadow: 0 3px 6px rgba(0,0,0,0.25);
}
.seat.strapontin.selected {
  background: linear-gradient(145deg, #ffca28, #fbc02d);
  box-shadow: 0 0 10px rgba(255,193,7,0.6);
}

@keyframes spin { to { transform: rotate(360deg); } }
@media(max-width:600px){
  .seat { width: 26px; height: 26px; font-size: 9px; margin: 2px; }
  .row-label { font-size: 12px; margin-right: 4px; }
  h1 { font-size: 1.5rem; }
  /* === üåü VISUEL AM√âLIOR√â POUR LE MODE ADMIN === */

/* Fond l√©g√®rement dor√© pour signaler le mode admin */
body.admin {
  background: radial-gradient(circle at center, #fff8e1, #ffe082);
  transition: background 0.5s ease;
}

/* Aura dor√©e autour de tous les si√®ges r√©serv√©s */
.admin .seat.reserved {
  box-shadow: 0 0 10px 3px rgba(255,215,0,0.7),
              inset 0 2px 4px rgba(0,0,0,0.3);
  animation: pulseGold 1.5s infinite alternate;
}

/* Animation douce (pulsation dor√©e) */
@keyframes pulseGold {
  from { box-shadow: 0 0 10px 3px rgba(255,215,0,0.6); }
  to   { box-shadow: 0 0 14px 5px rgba(255,215,0,0.9); }
}

/* Curseur et effet au survol des si√®ges r√©serv√©s */
.admin .seat.reserved:hover {
  cursor: pointer;
  transform: scale(1.12);
  filter: brightness(1.15);
}

/* Petite √©tiquette visuelle "Mode Admin" fixe */
#adminBanner {
  position: fixed;
  top: 10px;
  right: 10px;
  background: linear-gradient(90deg, #ffb300, #f57c00);
  color: #fff;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 10000;
  display: none;
}
body.admin #adminBanner {
  display: block;
}

}
  /* === Ajustement de l'espacement sur mobile === */
@media (max-width: 768px) {
  .hall-wrapper {
    margin-bottom: 10px !important;   /* R√©duit l'espace sous le plan */
  }

  #hall {
    margin-bottom: 0 !important;      /* Supprime tout espace interne inutile */
  }

  .buttons {
    margin-top: 5px !important;       /* Rapproche les boutons de la salle */
    margin-bottom: 10px;
  }

  /* Optionnel : rendre les boutons un peu plus compacts sur mobile */
  .buttons button {
    padding: 8px 12px;
    font-size: 13px;
  }
}
#info {
  background: #1976d2;
}
#info:hover {
  background: #0d47a1;
}
/* === Strapontin r√©serv√© : m√™me style que les si√®ges r√©serv√©s === */
.seat.strapontin.reserved {
  background: linear-gradient(145deg, #7c787773, #3e272300);
  opacity: 0.8;
  cursor: not-allowed;
  box-shadow: inset 0 2px 4px rgba(255,255,255,0.1);
}
#reservations tr:hover {
  background-color: #e3f2fd;
  transition: background-color 0.3s;
}
input.paid-toggle {
  transform: scale(1.2);
  cursor: pointer;
}
.seat.strapontin.paid {
  background: linear-gradient(145deg, #7cb342, #558b2f);
}
/* === Ligne "Paiement re√ßu" === */
.paid-line {
  
  align-items: center;
  justify-content: space-between;
  margin: 8px 0 12px 5px;
  font-weight: 500;
}

.paid-line input[type="checkbox"] {
  transform: scale(1.3);
  cursor: pointer;
  margin-right: 8px; /* espace l√©ger avec le bord droit */
}
/* ‚ú® Animation d'apparition des si√®ges */
@keyframes seatPop {
  from { transform: scale(0.5); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.seat {
  animation: seatPop 0.4s ease-out;
}

/* üí° Petit rebond au clic */
.seat:active {
  transform: scale(0.9);
  transition: transform 0.1s;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #bbdefb;
  border-top: 4px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s cubic-bezier(0.45, 0, 0.55, 1) infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader-content p {
  animation: fadeIn 1s ease-in-out infinite alternate;
}

@keyframes fadeIn {
  from { opacity: 0.6; }
  to { opacity: 1; }
}
.modal-content {
  transform: scale(0.8);
  opacity: 0;
  animation: modalIn 0.3s ease-out forwards;
}

@keyframes modalIn {
  to {
    transform: scale(1);
    opacity: 1;
  }
}
button {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
button:active {
  transform: scale(0.96);
}
.scene {
  animation: float 3s ease-in-out infinite alternate;
}

@keyframes float {
  from { transform: translateY(0); }
  to { transform: translateY(-4px); }
}
/* === Accord√©ons de r√©servation par client (version douce) === */
.accordion {
  background: #f9f9f9;
  border-radius: 8px;
  margin: 10px 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  overflow: hidden;
  transition: all 0.3s ease;
}

.accordion-header {
  background: #6fb572; /* üíô bleu plus doux */
  color: #000000;
  padding: 10px 14px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 100;
  transition: background 0.3s;
}

.accordion-header:hover {
  background: #42a5f5;
}

.accordion-content {
  background: #fff;
  padding: 10px 14px;
  display: none;
  border-top: 1px solid #ddd;
  transition: all 0.3s ease;
}

.accordion.open .accordion-content {
  display: block;
}

.accordion-header span {
  font-size: 0.9rem;
  font-weight: normal;
  color: #060606;
}

.seat-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  font-size: 0.9rem;
  margin-top: 6px;
}

.badge-seat {
  background: #64b5f6; /* m√™me bleu doux */
  color: #fff;
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: 600;
}

.accordion-content p {
  margin: 4px 0;
}
/* === Couleur diff√©rente si non pay√© === */
.accordion-header.paid {
  background: #a5d1a7; /* üíô bleu doux */
}

.accordion-header.unpaid {
  background: #f8bbd0; /* üå∏ rose clair */
  color: #212121;
}

.accordion-header.unpaid:hover {
  background: #f48fb1;
}
.accordion-header.paid {
  border-left: 6px solid #49a760;
	text-align: left;
}

.accordion-header.unpaid {
  border-left: 6px solid #e91e63;
}

.paid-toggle-client {
  transform: scale(1.2);
  cursor: pointer;
}
#amount {
  width: 90%;
  margin: 6px auto;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 5px;
  display: block;
  font-size: 14px;
}
#total-amount {
  transition: transform 0.3s ease, color 0.3s ease;
}
#total-amount.updated {
  transform: scale(1.1);
  color: #43a047;
}
.paid-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 10px auto 14px;
  padding: 6px 10px;
  width: 90%;
  background: #f1f1f1;
  border-radius: 6px;
  font-weight: 600;
  color: #333;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.paid-line input[type="checkbox"] {
  transform: scale(1.3);
  accent-color: #2e7d32; /* ‚úÖ vert doux */
  cursor: pointer;
}
.payment-group {
  background: #f5f5f5;
  padding: 10px;
  border-radius: 8px;
  margin: 10px auto 15px;
  width: 90%;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.payment-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
}

.payment-line input[type="checkbox"] {
  transform: scale(1.2);
  accent-color: #2e7d32; /* vert doux */
  cursor: pointer;
}

#amount {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 14px;
  box-sizing: border-box;
}
input#paid {
    width: 10%;
}
#stats {
  background: linear-gradient(180deg, #e3f2fd 0%, #f8f9fa 100%);
  border-radius: 10px;
  padding: 10px 16px;
  margin-top: 15px;
  width: fit-content;
  text-align: left;
  font-weight: 600;
  color: #0d47a1;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  font-size: 15px;
}
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}
.modal.hidden { display: none; }
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
}
.mini-seat.selected {
  background: linear-gradient(145deg,#1565c0,#0d47a1);
  color:#fff;
  transform: scale(1.1);
}
.mini-seat:hover {
  box-shadow: 0 0 6px rgba(33,150,243,0.6);
}
/* üé≠ Mini-plan compact pour l‚Äôajout manuel */
#miniSeatMap {
  display: grid;
  grid-template-columns: repeat(16, 1fr);
  gap: 6px;
  justify-items: center;
  align-items: center;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 12px;
  max-height: 320px;
  overflow: auto;
  box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
}

/* Si√®ge visuel dans le mini-plan */
.mini-seat {
  width: 34px;
  height: 34px;
  border-radius: 6px 6px 8px 8px;
  border: none;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(145deg, #e0e0e0, #bdbdbd);
  color: #212121;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
}

.mini-seat:hover {
  transform: scale(1.1);
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

/* Si√®ge s√©lectionn√© */
.mini-seat.selected {
  background: linear-gradient(145deg, #1565c0, #0d47a1);
  color: #fff;
  box-shadow: 0 0 10px rgba(25,118,210,0.6);
}

/* Strapontins */
.mini-seat[data-strapontin="true"] {
  background: linear-gradient(145deg, #f9a825, #f57f17);
  color: #fff;
}
.mini-seat[data-strapontin="true"].selected {
  background: linear-gradient(145deg, #ffca28, #fbc02d);
}

/* Indication de rang√©e √† gauche */
.mini-row-label {
  grid-column: 1 / -1;
  text-align: left;
  width: 100%;
  margin: 4px 0 0 4px;
  font-weight: 700;
  color: #424242;
}

/* Scrollbar discr√®te */
#miniSeatMap::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
#miniSeatMap::-webkit-scrollbar-thumb {
  background: #90a4ae;
  border-radius: 3px;
}
#miniSeatMap::-webkit-scrollbar-track {
  background: #e0e0e0;
}
button#editPrices {
    background: coral;
}
	input#childCount {
    width: 50%;
}
	input#adultCount {
    width: 50%;
}
	input#babyCount {
    width: 50%;
}
	div#miniSeatMap {
    display: none !important;
}
	button#addSeatConfirm {
    background: black;
}
	button#addSeatCancel {
    background: black;
}
.group-actions button:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
/* Mode group√© : mise en √©vidence */
.seat.selected {
  box-shadow: 0 0 12px 3px rgba(33,150,243,0.7) !important;
}
body.admin .seat.selected {
  transform: scale(1.15);
}

/* Vert clair en ajout, rouge clair en suppression */
body.admin .seat.selected.add-mode {
  background: #a5d6a7 !important;
}
body.admin .seat.selected.remove-mode {
  background: #ef9a9a !important;
}
.hidden {
  display: none !important;
}
/* === Boutons du haut === */
.top-buttons {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 999;
}

.top-buttons button {
  background: linear-gradient(180deg, #b22, #7b0d0d);
  color: #ffeeba;
  font-weight: 700;
  font-size: 0.9rem;
  border: none;
  border-radius: 10px;
  padding: 10px 14px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0,0,0,0.35);
  transition: transform 0.1s ease, filter 0.2s ease;
}
button#retour-dashboard {
    background: midnightblue;
}
.top-buttons button:hover {
  filter: brightness(1.1);
  transform: scale(1.05);
}
/* üüß R√©servation GRATUITE */
.accordion-header.free-line {
    background: #ed00ed !important;
    color: #ffffff;
    border-left: 6px solid #fb8c00;
}

/* üîµ Badge G = place gratuite dans la r√©servation */
.free-badge {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;
  height:18px;
  border-radius:50%;
  background:#1976d2; /* bleu */
  color:white;
  font-weight:700;
  font-size:12px;
  line-height:1;
}
/* üü£ SI√àGE GRATUIT */
.seat.free-ticket {
  background: magenta !important;
  box-shadow: 0 0 8px rgba(142,36,170,0.7);
  color: #fff;
}

/* badge texte du si√®ge */
.seat.free-ticket span {
  color: #fff;
}
/* üü£ SI√àGE GRATUIT */
.seat.free-ticket {
background: magenta !important;
  color: #fff !important;
  box-shadow: 0 0 8px rgba(142,36,170,0.7);
}
.participant-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 22px;
  height: 22px;
  padding: 0 6px;
  border-radius: 50%;
  background: orange;
  color: white;
  font-weight: 700;
  font-size: 12px;
}
.send-ticket-btn {
  background: #f50707;
  border: none;
  border-radius: 6px;
  padding: 6px 8px;
  cursor: pointer;
  font-size: 14px;
}

.send-ticket-btn.sent {
  background: #2e7d32; /* vert */
  color: white;
}

</style>
</head>

<body>
<div id="loader">
  <div class="loader-content">
    <div class="spinner"></div>
    <p>Chargement de la salle‚Ä¶</p>
  </div>
</div>

<h1>üé≠ Th√©√¢tre Saint Martin</h1>
	<h3>LE 24 JANVIER 2026 √† 20H30</h3>
  <br> Adulte : 14‚Ç¨ / Enfant 9-14 ans : 10e / Gratuit - de 8 ans</br>
<div class="scene">SC√àNE</div>

<div class="legend">
  <div><span class="free"></span>Libre</div>
  <div><span class="selected"></span>S√©lectionn√©</div>
  <div><span class="reserved"></span>R√©serv√© non pay√©</div>
  <div><span class="strapontin"></span>Strapontin</div>
  <div><span class="paid"></span>R√©serv√© et pay√©</div> <!-- üíö ajout√© -->
</div>

<div class="hall-wrapper">
  <div id="hall"></div>
</div>

<div class="buttons">
  <button id="confirm">‚úÖ Confirmer</button>
  <button id="admin">üîê Admin</button>
  <button id="reset">‚ôªÔ∏è R√©initialiser</button>
  <button id="export" style="display:none;">üì§ Export CSV</button>
  <button id="scanTicket">üéüÔ∏è Scanner un billet</button>
  <button id="editPrices" style="display:none;">üí∂ Modifier les tarifs</button>
  <button id="toggleEmailTest" style="display:none;">‚úâÔ∏è Mode email : TEST</button>
  <button id="bulkReminder"
  style="display:none;background:#1976d2;">
  üîî Rappel r√©servation (billet + QR)
</button>

  
  <!-- === Bouton retour Tableau de bord === -->
<button id="retour-dashboard" class="back-btn">üè† Retour au tableau de bord</button>


    <button id="info">‚ÑπÔ∏è AIDE</button>

</div>
<!-- üí∞ R√©sum√© des statistiques -->
<!-- üí∞ R√©sum√© des statistiques globales -->
<div id="stats-bar" style="
  display:flex;
  justify-content:center;
  align-items:center;
  gap:25px;
  background:#f8f9fa;
  padding:10px 20px;
  margin:10px auto 5px;
  border-radius:12px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
  font-family:'Segoe UI',sans-serif;
  font-weight:600;
  color:#2e7d32;
  flex-wrap:wrap;
">
  <span id="stat-total">üí∞ Total encaiss√© : 0 ‚Ç¨</span>
  <span id="stat-adult">üßç Adultes : 0</span>
  <span id="stat-child">üë∂ Enfants : 0</span>
  <span id="stat-baby">üçº Moins de 8 ans : 0</span>
  <span id="stat-sold">üéüÔ∏è Places r√©serv√©es : 0</span>
</div>


<div id="reservations">
<div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
    <h3>üìã Liste des r√©servations</h3>
	<h4 id="total-amount" style="
  text-align:right;
  color:#2e7d32;
  margin:10px 15px;
  font-size:1rem;
  font-weight:600;
"></h4>

    <div id="legend-paid" style="display: flex; align-items: center; gap: 6px; font-size: 14px;">
      <div style="width:18px; height:18px; background:#c8e6c9; border:1px solid #81c784; border-radius:3px;"></div>
      
    </div>
  </div>

  <div id="resBody"><p>Aucune r√©servation.</p></div>


</div>


<!-- üßæ Fen√™tre modale de r√©servation -->
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <h3>Informations de r√©servation</h3>

    <input id="name" placeholder="Nom complet">
    <input id="email" placeholder="Adresse email">
    <input id="phone" placeholder="T√©l√©phone">

    <div class="payment-group">
      <div class="payment-line">
        <span>Si paiement re√ßu, coche la case</span>
        <input type="checkbox" id="paid">
      </div>
	<div class="payment-line">
  <label for="babyCount">- de 8 ans</label>
  <input id="babyCount" type="number" min="0" value="0" step="1">
</div>
<div class="payment-line">
  <label for="freeCount">Accompagnants</label>
  <input id="freeCount" type="number" min="0" value="0" step="1">
</div>


      <div class="payment-line">
        <label for="adultCount">Adultes</label>
        <input id="adultCount" type="number" min="0" value="0" step="1">
      </div>

      <div class="payment-line">
        <label for="childCount">9-14 ans</label>
        <input id="childCount" type="number" min="0" value="0" step="1">
      </div>

      <p id="total-display" style="
        margin:6px 0 0;
        font-weight:600;
        text-align:right;
        color:#2e7d32;
      ">
        Total : 0 ‚Ç¨
      </p>
    </div>

    <div>
      <button id="save">Valider</button>
      <button id="close">Annuler</button>
    </div>
  </div>
</div>



<script type="module">
/* === Attente que Firebase soit pr√™t === */
await new Promise(resolve => {
  const check = () => window._firebaseRef ? resolve() : setTimeout(check, 100);
  check();
});
// === TARIFS (source unique) ===
let PRICE_ADULT = parseFloat(localStorage.getItem("PRICE_ADULT")) || 14;
let PRICE_CHILD = parseFloat(localStorage.getItem("PRICE_CHILD")) || 10;
// === MODE EMAIL (source unique) ===
window.EMAIL_TEST_MODE = localStorage.getItem("EMAIL_TEST_MODE") === "true";




const db = window._firebaseDB;
const ref = window._firebaseRef;
const set = window._firebaseSet;
const onValue = window._firebaseOnValue;
const get = window._firebaseGet;

let seats = {}, selected = [], admin = false;
window.seats = seats;

const hall = document.getElementById("hall");
const resetBtn = document.getElementById("reset");
const adminBtn = document.getElementById("admin");
const loader = document.getElementById("loader");

/* === Plan de la salle === */
const rows = [...Array(19)].map((_, i) => String.fromCharCode(65 + i));
const seatNums = [15,13,11,9,7,5,3,1,2,4,6,8,10,12,14,16];

rows.forEach(r => {
  const row = document.createElement("div");
  row.className = "row";

  const label = document.createElement("div");
  label.className = "row-label";
  label.textContent = r;
  row.append(label);

  row.append(makeSeat(`${r}-S15`, "S", "strapontin"));
  seatNums.forEach(n => row.append(makeSeat(`${r}-${n}`, n)));
  row.append(makeSeat(`${r}-S16`, "S", "strapontin"));

  hall.append(row);
});

function makeSeat(id, label, extra){
  const d = document.createElement("div");
  d.className = "seat " + (extra || "free");
  d.dataset.id = id;
  d.setAttribute("aria-label", `Si√®ge ${id}`);

  const labelSpan = document.createElement("span");
  labelSpan.textContent = label;
  d.appendChild(labelSpan);

d.onclick = (e) => {
  e.stopPropagation();
  toggle(id, d);
};

  return d;
}

/* === Connexion Firebase === */
const seatsRef = ref(db, "seats");
onValue(seatsRef, snapshot => {
  seats = snapshot.val() || {};
  render();
  updateTable();
  updateStatsBar(); // ‚úÖ AJOUT ICI ‚Äî met √† jour les compteurs au chargement
  setTimeout(() => loader.classList.add("hidden"), 400);
});

function save(){ set(seatsRef, seats); }
// üé® Nouvelle modale de choix du type de billet (accessible partout)
async function askSeatType(id) {
  return new Promise(resolve => {
    const modal = document.getElementById("ticketTypeModal");
    const seatLabel = document.getElementById("ticketTypeSeat");
    seatLabel.textContent = `ü™ë Si√®ge ${id}`;
    modal.classList.remove("hidden");

    function cleanup() {
      modal.classList.add("hidden");
      document.querySelectorAll(".ticket-type-btn").forEach(btn =>
        btn.removeEventListener("click", onSelect)
      );
      cancelBtn.removeEventListener("click", onCancel);
    }

    function onSelect(e) {
      const type = e.target.dataset.type;
      cleanup();
      resolve(type);
    }

    function onCancel() {
      cleanup();
      resolve(null);
    }

    const cancelBtn = document.getElementById("cancelTicketType");
    document.querySelectorAll(".ticket-type-btn").forEach(btn =>
      btn.addEventListener("click", onSelect)
    );
    cancelBtn.addEventListener("click", onCancel);
  });
}

/* === Rendu === */
function render() {
  document.querySelectorAll(".seat").forEach(el => {
    const id = el.dataset.id;
    const wasStrap = el.classList.contains("strapontin");
    el.className = "seat";
    if (wasStrap) el.classList.add("strapontin");

    const seatData = seats[id];
if (seatData) {
  if (seatData.type === "gratuit") {
    el.classList.add("free-ticket"); // üü£ GRATUIT uniquement
  } else if (seatData.paid) {
    el.classList.add("paid");
  } else {
    el.classList.add("reserved");
  }
}




 else if (selected.includes(id)) {
      el.classList.add("selected");
    } else {
      el.classList.add("free");
    }
  });
}

/* === S√©lection === */
async function toggle(id, el) {

// üß© Si on est en mode suppression group√©e ‚Üí on ne fait pas la logique normale
if (groupMode === "remove" && admin) {
  if (
    el.classList.contains("reserved") ||
    el.classList.contains("paid") ||
    el.classList.contains("free-ticket")
  ) {



    // S√©lectionne ou d√©s√©lectionne le si√®ge pour suppression
    el.classList.toggle("selected");

    if (el.classList.contains("selected")) {
      groupChanges.push(id);
    } else {
      groupChanges = groupChanges.filter(x => x !== id);
    }
  }
  return; // üîÅ On bloque ici : ne pas ex√©cuter le reste de toggle()
}

// üß© Si on est en mode ajout group√© ‚Üí m√™me logique (pas de r√©servation imm√©diate)
if (groupMode === "add" && admin) {
  if (el.classList.contains("free")) {
    el.classList.toggle("selected");

    if (el.classList.contains("selected")) {
      groupChanges.push({ id, name: groupClient });
    } else {
      groupChanges = groupChanges.filter(s => s.id !== id);
    }
  }
  return; // üü¢ On bloque ici aussi
}

// üß© Sinon comportement normal
if (admin && seats[id] && groupMode !== "remove") {

  if (confirm(`üîì Lib√©rer le si√®ge ${id} ?`)) {
    const clientName = seats[id].name;
    const clientEmail = seats[id].email;
    delete seats[id];

    // recalcul totaux
    let totalA = 0, totalC = 0, totalB = 0;
    for (const data of Object.values(seats)) {
      if (data.name === clientName) {
        totalA += (data.type === "adulte") ? 1 : 0;
        totalC += (data.type === "enfant") ? 1 : 0;
        totalB += (data.type === "moins8") ? 1 : 0;
      }
    }
    const totalAmount = totalA * PRICE_ADULT + totalC * PRICE_CHILD;

    for (const [sid, data] of Object.entries(seats)) {
      if (data.name === clientName) {
        data.nbAdult = totalA;
        data.nbChild = totalC;
        data.nbBaby = totalB;
        data.amount = totalAmount;
      }
    }

    save();
    render();
    updateTable();
    updateStatsBar();

    if (clientEmail) await notifyClientUpdate(clientEmail);
    alert(`‚úÖ Si√®ge ${id} lib√©r√©. Totaux mis √† jour pour ${clientName}.`);
  }
  return;
}

// üéüÔ∏è comportement normal utilisateur
if (!seats[id]) {
  if (selected.includes(id)) {
    selected = selected.filter(x => x !== id);
  } else {
    selected.push(id);
  }
  render();
}
}


  // ... le reste de ta fonction toggle



/* === Ouvre/ferme la modale === */
document.getElementById("confirm").onclick = () => {
  if (!selected.length) return alert("Aucun si√®ge s√©lectionn√© !");
  document.getElementById("modal").classList.remove("hidden");
};
document.getElementById("close").onclick = () => document.getElementById("modal").classList.add("hidden");

/* === Formatage nom/email/t√©l√©phone === */
function formatPhone(input) {
  let digits = input.replace(/\D/g, "");
  if (digits.startsWith("33")) digits = "0" + digits.slice(2);
  if (digits.startsWith("0033")) digits = "0" + digits.slice(4);
  digits = digits.slice(0, 10);
  return digits.replace(/(\d{2})(?=\d)/g, "$1 ").trim();
}
document.getElementById("name").addEventListener("input", e => e.target.value = e.target.value.toUpperCase());
document.getElementById("email").addEventListener("input", e => e.target.value = e.target.value.toLowerCase());
document.getElementById("phone").addEventListener("input", e => e.target.value = formatPhone(e.target.value));

/* === üßÆ Calcul automatique total (adultes/enfants) === */
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("reset").style.display = "none";

  const adultInput = document.getElementById("adultCount");
  const childInput = document.getElementById("childCount");
  const totalDisplay = document.getElementById("total-display");
  function updateTotal() {
    const nbA = parseInt(adultInput.value) || 0;
const nbE = parseInt(childInput.value) || 0;
const nbB = parseInt(document.getElementById("babyCount").value) || 0;
const nbG = parseInt(document.getElementById("freeCount")?.value || "0") || 0; // üéüÔ∏è Gratuit
const total = nbA * PRICE_ADULT + nbE * PRICE_CHILD; // gratuit ne compte pas en ‚Ç¨


    totalDisplay.textContent = `Total : ${total.toFixed(2)} ‚Ç¨`;
  }
adultInput.addEventListener("input", updateTotal);
childInput.addEventListener("input", updateTotal);
document.getElementById("babyCount").addEventListener("input", updateTotal);
document.getElementById("freeCount").addEventListener("input", updateTotal);

});

/* === Validation + enregistrement === */
document.getElementById("save").onclick = async () => {
  const name   = document.getElementById("name").value.trim().toUpperCase();
  const email  = document.getElementById("email").value.trim().toLowerCase();
  const phone  = formatPhone(document.getElementById("phone").value.trim());
  const paid   = document.getElementById("paid").checked;

const nbAdult = parseInt(document.getElementById("adultCount").value) || 0;
const nbChild = parseInt(document.getElementById("childCount").value) || 0;
const nbBaby  = parseInt(document.getElementById("babyCount")?.value || "0") || 0;
const nbFree  = parseInt(document.getElementById("freeCount")?.value || "0") || 0; // üéüÔ∏è Gratuit


  const totalSeats  = selected.length;                  // ‚úÖ manquait
const totalPeople = nbAdult + nbChild + nbBaby + nbFree;


  if (!name || !email || !phone) {
    alert("Tous les champs sont requis.");
    return;
  }
  if (totalPeople !== totalSeats) {
    alert(`‚ö†Ô∏è Le nombre total de personnes (${totalPeople}) doit correspondre au nombre de si√®ges s√©lectionn√©s (${totalSeats}).`);
    return;
  }

  // üí∂ Moins de 8 ans = gratuit. Utilise les tarifs configurables si pr√©sents.
  const amount = nbAdult * (typeof PRICE_ADULT === "number" ? PRICE_ADULT : 14)
               + nbChild * (typeof PRICE_CHILD === "number" ? PRICE_CHILD : 10);

const isFree = amount === 0;

const reservationId = crypto.randomUUID();
// üîó Lien r√©servation ‚Üî participants
window.lastReservationId = reservationId;

const user = { 
  reservationId,
  name,
  email,
  phone,
  paid: isFree ? true : paid, // ‚úÖ gratuit = pay√©
  free: isFree,               // üÜï flag gratuit
  nbAdult,
  nbChild,
  nbBaby,
  amount
};



  // R√©partition des types par si√®ge
let adultRemaining = nbAdult;
let childRemaining = nbChild;
let babyRemaining  = nbBaby;
let freeRemaining  = nbFree;


  selected.forEach(id => {
    if (!seats[id]) {
      const seatData = { ...user };
      if (adultRemaining > 0) {
        seatData.type = "adulte";
        adultRemaining--;
      } else if (childRemaining > 0) {
        seatData.type = "enfant";
        childRemaining--;
} else if (babyRemaining > 0) {
  seatData.type = "moins8";
  babyRemaining--;
} else if (freeRemaining > 0) {
  seatData.type = "gratuit";
  seatData.paid = true; // ‚úÖ gratuit = consid√©r√© pay√©
  freeRemaining--;
} else {
  seatData.type = "autre";
}

      seats[id] = seatData;
    }
  });

  save();

// üìß Envoi de l‚Äôemail (autoris√© en mode test m√™me en admin)
if (!EMAIL_TEST_MODE) {
  await sendEmail(user);
}



selected = [];
document.getElementById("modal").classList.add("hidden");
updateStatsBar();


  alert(`‚úÖ R√©servation confirm√©e : ${nbAdult} adulte(s), ${nbChild} enfant(s), ${nbBaby} (-8 ans) ‚Äî Total ${amount} ‚Ç¨.`);
};


/* === Email + QR === */
async function sendEmail(user) {
  alert("üì® sendEmail() appel√©e");

  console.log("üì® Envoi EmailJS vers", user.email);

  const reservedSeats = Object.entries(seats)
    .filter(([_, v]) => v.email === user.email)
    .map(([id]) => id)
    .join(", ");

const maxScans = reservedSeats.split(",").length;

const qrData = JSON.stringify({
  id: user.reservationId,
  nom: user.name,
  email: user.email,
  tel: user.phone,
  sieges: reservedSeats,
  max: maxScans
});


const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrData)}`;


  const html = `
    <h2>üé≠ Confirmation de votre r√©servation ‚Äî Th√©√¢tre Saint Martin</h2>
    <p>Bonjour <strong>${user.name}</strong>,</p>
    <p>Merci pour votre r√©servation.</p>
    <p><strong>üìç Si√®ges r√©serv√©s :</strong> ${reservedSeats}</p>
    <p><strong>üí∞ Montant total :</strong> ${user.amount.toFixed(2)} ‚Ç¨</p>
    <p><strong>üí≥ Statut :</strong> ${user.paid ? "‚úÖ Pay√©" : "‚ùå Non pay√©"}</p>
    <p>Voici votre QR Code de confirmation :</p>
<img src="${qrUrl}" alt="QR Code" style="margin-top:8px;"/>

    <p>√Ä tr√®s bient√¥t au Th√©√¢tre Saint Martin üé≠</p>
  `;

  try {
  if (EMAIL_TEST_MODE) {
  console.log("üö´ [MODE TEST] Email non envoy√© ‚Äî aper√ßu ci-dessous :");
  console.log("Destinataire :", user.email);

  // üß© Affiche la modale de pr√©visualisation
  const previewModal = document.getElementById("emailPreviewModal");
  const previewContent = document.getElementById("emailPreviewContent");
  previewContent.innerHTML = html; // injecte le contenu HTML
  previewModal.classList.remove("hidden");

  // Bouton de fermeture
  document.getElementById("closeEmailPreview").onclick = () => {
    previewModal.classList.add("hidden");
  };

  alert(`üì© Mode test : aucun envoi, mais aper√ßu disponible`);
} else {
  await sendViaBrevo(
    user.email,
    "üé≠ Confirmation de votre r√©servation",
    html
  );
  console.log("‚úÖ Email Brevo envoy√© √†", user.email);
}


} catch (err) {
  console.error("‚ùå Erreur EmailJS :", err);
}
}
// ===================================================
// üîî EMAIL DE RAPPEL (billet + QR)
// ===================================================
async function sendReminderEmail(user) {

// üéüÔ∏è Si si√®ges fournis directement (participants), on les utilise
let reservedSeats = "";

if (Array.isArray(user.seats) && user.seats.length) {
  reservedSeats = user.seats.join(", ");
} else {
  reservedSeats = Object.entries(seats)
    .filter(([_, v]) => v.email === user.email)
    .map(([id]) => id)
    .join(", ");
}


  const qrData = JSON.stringify({
    nom: user.name,
    email: user.email,
    sieges: reservedSeats
  });

  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrData)}`;

  const html = `
    <h2>üîî Rappel : votre spectacle approche ‚Äî Th√©√¢tre Saint Martin</h2>
    <p>Bonjour <strong>${user.name}</strong>,</p>

<p>
Nous vous rappelons votre r√©servation pour le spectacle √† venir

</p>


<p><strong>üéüÔ∏è Si√®ges r√©serv√©s :</strong> ${reservedSeats}</p>

${user.isParticipant ? "" : `
  <p><strong>üí∞ Montant :</strong> ${user.amount.toFixed(2)} ‚Ç¨</p>
  <p><strong>üí≥ Statut :</strong> ${user.paid ? "Pay√©" : "‚ùå Non pay√©"}</p>
`}


    <p>Merci de pr√©senter ce QR Code √† l‚Äôentr√©e :</p>
    <img src="${qrUrl}" alt="QR Code" style="margin-top:8px;"/>

    <p style="margin-top:10px;">
      üìÖ <strong>24 janvier 2026 ‚Äì 20h30</strong><br>
      üìç Th√©√¢tre Saint Martin
    </p>

    <p>√Ä tr√®s bient√¥t üé≠</p>
  `;

  if (EMAIL_TEST_MODE) {
    document.getElementById("emailPreviewContent").innerHTML = html;
    document.getElementById("emailPreviewModal").classList.remove("hidden");
    return;
  }

await sendViaBrevo(
  user.email,
  "üîî Rappel ‚Äî Votre r√©servation (billet + QR)",
  html
);


}



async function notifyClientUpdate(email) {
  // ‚úÖ Si aucun email pass√©, on tente de le retrouver via le nom du client s√©lectionn√©
  if (!email && typeof groupClient !== "undefined" && groupClient) {
    const anySeat = Object.values(seats).find(s => s.name === groupClient);
    if (anySeat && anySeat.email) {
      email = anySeat.email;
      console.log(`üì© Email r√©cup√©r√© automatiquement pour ${groupClient} ‚Üí ${email}`);
    }
  }

  if (!email) {
    console.warn(`‚ö†Ô∏è Aucun email trouv√© pour "${groupClient || "?"}" (email pass√©: ${email || "aucun"})`);
    return;
  }


  const clientSeats = Object.entries(seats)
    .filter(([id, s]) => s.email && s.email.toLowerCase() === email.toLowerCase())
    .map(([id, s]) => ({ id, ...s }));

  if (!clientSeats.length) {
    console.warn("‚ùå Aucun si√®ge trouv√© pour ce client.");
    return;
  }

  const added = groupMode === "add" ? groupChanges.map(s => s.id) : [];
  const removed = groupMode === "remove" ? groupChanges : [];

  const client = clientSeats[0];
  const allSeats = clientSeats.map(s => s.id).join(", ");
  const totalAmount = clientSeats[0].amount || 0;
  const paye = clientSeats.every(s => s.paid);

  const qrData = JSON.stringify({
    nom: client.name,
    email: client.email,
    tel: client.tel || "",
    sieges: allSeats,
    paye
  });

  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrData)}`;

  const html = `
    <h2>üé≠ Mise √† jour de votre r√©servation ‚Äî Th√©√¢tre Saint Martin</h2>
    <p>Bonjour <strong>${client.name}</strong>,</p>
    <p>Votre r√©servation a √©t√© mise √† jour par notre √©quipe.</p>

    ${added.length ? `<p>üü¢ <strong>Si√®ges ajout√©s :</strong> ${added.join(", ")}</p>` : ""}
    ${removed.length ? `<p>üî¥ <strong>Si√®ges supprim√©s :</strong> ${removed.join(", ")}</p>` : ""}

    <p>üìç <strong>Si√®ges actuels r√©serv√©s :</strong> ${allSeats}</p>
       <p>üí≥ <strong>Statut :</strong> ${paye ? "‚úÖ Pay√©" : "‚ùå Non pay√©"}</p>

    <p>Voici votre QR Code mis √† jour :</p>
    <img src="${qrUrl}" alt="QR Code" style="margin-top:8px;"/>

    <p>Merci et √† bient√¥t au th√©√¢tre üé≠<br>‚Äî L‚Äô√©quipe Saint Martin</p>
  `;

  console.log("üìß Envoi du mail de mise √† jour √†", email);

  try {
  if (EMAIL_TEST_MODE) {
    console.log("üö´ [MODE TEST] Aucun envoi r√©el ‚Äî aper√ßu ci-dessous :");
    console.log("Destinataire :", email);

    // üíå Pr√©visualisation HTML
    const previewModal = document.getElementById("emailPreviewModal");
    const previewContent = document.getElementById("emailPreviewContent");
    previewContent.innerHTML = html;
    previewModal.classList.remove("hidden");

    document.getElementById("closeEmailPreview").onclick = () =>
      previewModal.classList.add("hidden");

    alert(`üì© Mode test : aucun email envoy√© √† ${email}`);
} else {
  await sendViaBrevo(
    email,
    "üé≠ Mise √† jour de votre r√©servation",
    html
  );
  console.log("‚úÖ Email Brevo envoy√© √†", email);
}

} catch (err) {
  console.error("‚ùå Erreur d‚Äôenvoi du mail :", err);
}
}

/* === Mode Admin === */
adminBtn.onclick = () => {
  const scanBtn = document.getElementById("scanTicket");
  const infoBtn = document.getElementById("info");

  if (!admin) {
    const p = prompt("Mot de passe admin :");
    if (p === "admin123") {
      admin = true;
      alert("‚úÖ Mode admin activ√©");
      resetBtn.style.display = "inline-block";
      document.getElementById("export").style.display = "inline-block";
      scanBtn.style.display = "none";
      infoBtn.style.display = "none";
      document.body.classList.add("admin");
      adminBtn.textContent = "üö™ Sortir du mode admin";
      updateTable();

      toggleAdminUI(); // ‚úÖ ajoute cette ligne ici aussi
    } else {
      alert("‚ùå Mot de passe incorrect.");
    }
  } else {
    admin = false;
    alert("üëã Mode admin d√©sactiv√©");
    resetBtn.style.display = "none";
    document.getElementById("export").style.display = "none";
    scanBtn.style.display = "inline-block";
    infoBtn.style.display = "inline-block";
    document.body.classList.remove("admin");
    adminBtn.textContent = "üîê Admin";
    updateTable();
    toggleAdminUI(); // ‚úÖ d√©j√† pr√©sent ici
  }
};



/* === R√©initialiser === */
resetBtn.onclick = () => {
  if (!admin) return alert("Activez le mode admin.");
  if (confirm("Effacer toutes les r√©servations ?")) {
    seats = {};
    save();
	updateStatsBar(); // ‚úÖ ajout ici
    alert("‚úÖ R√©initialisation compl√®te.");
  }
};

/* === Export CSV === */
document.getElementById("export").onclick = () => {
  const entries = Object.entries(seats)
    .sort(([a], [b]) => a.localeCompare(b, 'fr', { numeric: true }));
  const now = new Date().toLocaleString("fr-FR");
  let csv = `Export des r√©servations ‚Äì Th√©√¢tre Saint Martin (${now})\n\n`;
  csv += "RANG√âE;SI√àGE;NOM;EMAIL;T√âL√âPHONE;ADULTES;ENFANTS;MOINS_DE_X_ANS;TOTAL(‚Ç¨)\n";

  for (const [k, v] of entries) {
    const [r, s] = k.split("-");
csv += `${r};${s};${v.name};${v.email};${v.phone};${v.nbAdult||0};${v.nbChild||0};${v.nbBaby||0};${v.amount||0}\n`;
  }
  csv += `\nTOTAL R√âSERVATIONS;${entries.length}\n`;
  // ===============================
// üìß Liste des emails uniques
// ===============================
const emailsSet = new Set();

for (const v of Object.values(seats)) {
  if (v.email) {
    emailsSet.add(v.email.toLowerCase());
  }
}

csv += "\n\nLISTE DES EMAILS (SANS DOUBLONS)\n";
for (const email of emailsSet) {
  csv += `${email}\n`;
}

  const bom = "\uFEFF";
  const blob = new Blob([bom + csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `reservations_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
};

/* === Liste r√©servations === */

// ===============================
// üë• PARTICIPANTS (affichage dans la r√©servation)
// ===============================
function escapeHTML(str="") {
  return String(str)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}

async function loadParticipants(reservationId) {
  if (!reservationId) return;

  const box = document.getElementById(`participants-${reservationId}`);
  if (!box) return;

  try {
    const snap = await get(ref(db, `participants/${reservationId}`));
    const data = snap.val() || {};

    const list = Object.entries(data);

    if (!list.length) {
      box.innerHTML = `<div style="margin-top:10px;font-size:13px;color:#666;">üë• Aucun participant enregistr√©.</div>`;
      return;
    }

    // Tri par nom puis pr√©nom
    list.sort(([,a],[,b]) => ((a.name || `${a.nom||""} ${a.prenom||""}`).trim()).localeCompare(((b.name || `${b.nom||""} ${b.prenom||""}`).trim()), "fr", { sensitivity:"base" }));

    box.innerHTML = `
      <div style="margin-top:12px;padding:10px;border-radius:10px;background:#f6f7fb;border:1px solid #e1e3ee;">
        <div style="font-weight:700;margin-bottom:8px;">üë• Participants (${list.length})</div>
        <button
  class="add-participant-btn"
  data-resid="${reservationId}"
  style="
    background:#2e7d32;
    color:white;
    border:none;
    border-radius:6px;
    padding:6px 10px;
    cursor:pointer;
    font-weight:600;
    margin-bottom:8px;
  ">
  ‚ûï Ajouter un participant
</button>

        <div style="display:flex;flex-direction:column;gap:8px;">
${list.map(([pid,p]) => `
  <div style="
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    background:#fff;
    border:1px solid #eee;
    border-radius:8px;
    padding:8px 10px;
  ">
    <div style="font-size:13px;line-height:1.35;">
      <div style="font-weight:700;">${escapeHTML(p.name||"")}</div>
      <div>üìß ${escapeHTML(p.email||"‚Äî")}</div>
      <div>üì± ${escapeHTML(p.phone||"‚Äî")}</div>
    </div>

    <div style="display:flex;gap:6px;">
      <!-- ‚úèÔ∏è Modifier -->
      <button
        class="edit-participant-btn"
        data-resid="${reservationId}"
        data-pid="${pid}"
        style="background:#ffb300;color:#000;border:none;border-radius:6px;padding:6px 8px;cursor:pointer;">
        ‚úèÔ∏è
      </button>

      <!-- üñ®Ô∏è Envoyer billet -->
<button
  class="send-ticket-btn ${p.ticketSent ? "sent" : ""}"
  data-resid="${reservationId}"
  data-pid="${pid}"
  data-name="${escapeHTML(p.name||"")}"
  data-email="${escapeHTML(p.email||"")}"
  data-phone="${escapeHTML(p.phone||"")}"
>
  üñ®Ô∏è
</button>




      <!-- üóëÔ∏è Supprimer -->
      ${admin ? `
      <button
        class="delete-participant-btn"
        data-resid="${reservationId}"
        data-pid="${pid}"
        style="background:#d32f2f;color:white;border:none;border-radius:6px;padding:6px 8px;cursor:pointer;">
        ‚ùå
      </button>
      ` : ""}
    </div>
  </div>
`).join("")}

        </div>
      </div>
    `;
  } catch (err) {
    console.error("‚ùå Erreur chargement participants :", err);
    box.innerHTML = `<div style="margin-top:10px;color:#d32f2f;font-weight:600;">‚ùå Impossible de charger les participants.</div>`;
  }
}
window.loadParticipants = loadParticipants;

// Suppression participant (admin)
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".delete-participant-btn");
  if (!btn) return;

  if (!admin) return alert("‚ùå Mode admin requis");

  const reservationId = btn.dataset.resid;
  const pid = btn.dataset.pid;
  if (!reservationId || !pid) return;

  if (!confirm("Supprimer ce participant ?")) return;

  try {
    await set(ref(db, `participants/${reservationId}/${pid}`), null);
    await loadParticipants(reservationId);
    alert("‚úÖ Participant supprim√©");
  } catch (err) {
    console.error("‚ùå Erreur suppression participant :", err);
    alert("‚ùå Erreur suppression (voir console)");
  }
});
// ‚úèÔ∏è Modifier participant
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".edit-participant-btn");
  if (!btn) return;

  const reservationId = btn.dataset.resid;
  const pid = btn.dataset.pid;

  const snap = await get(ref(db, `participants/${reservationId}/${pid}`));
  if (!snap.exists()) return alert("Participant introuvable");

  const p = snap.val();

  const name = prompt("Nom du participant :", p.name || "");
  if (!name) return;

  const email = prompt("Email :", p.email || "");
  const phone = prompt("T√©l√©phone :", p.phone || "");

  await set(ref(db, `participants/${reservationId}/${pid}`), {
    ...p,
    name,
    email,
    phone
  });

  await loadParticipants(reservationId);
});
let sendingParticipantTicket = false;



document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".send-ticket-btn");
  if (!btn) return;

  if (sendingParticipantTicket) return;
  sendingParticipantTicket = true;

  const name = btn.dataset.name;
  const email = btn.dataset.email;
  const phone = btn.dataset.phone || "";
  const reservationId = btn.dataset.resid;

  if (!email) {
    sendingParticipantTicket = false;
    return alert("‚ùå Pas d'email pour ce participant");
  }

  const clientSeats = Object.entries(seats)
    .filter(([_, s]) => s.reservationId === reservationId)
    .map(([id]) => id)
    .join(", ");

  if (!clientSeats) {
    sendingParticipantTicket = false;
    return alert("‚ùå Aucun si√®ge trouv√©");
  }

  const qrData = JSON.stringify({
    name,
    email,
    phone,
    sieges: clientSeats
  });

  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrData)}`;
const mainClientName =
  Object.values(seats).find(s => s.reservationId === reservationId)?.name
  || "le r√©servant principal";

  const html = `
    <h2>üé≠ Votre billet nominatif ‚Äî Th√©√¢tre Saint Martin</h2>

  <p>
  Ce billet vous est transmis suite √† la r√©servation effectu√©e par
  <strong>${mainClientName}</strong>.

          <p style="font-size:14px;color:#555;">
          Merci de pr√©senter ce billet (imprim√© ou sur t√©l√©phone) √† l‚Äôentr√©e.
        </p>
</p>
    <p><strong>üéüÔ∏è Si√®ges :</strong> ${clientSeats}</p>
    <img src="${qrUrl}" style="margin-top:10px;" />
    <p>Merci et √† tr√®s bient√¥t üé≠</p>
  `;

  try {
    await sendViaBrevo(
  email,
  "üéüÔ∏è Votre billet ‚Äì Th√©√¢tre Saint Martin",
  html
);

// ‚úÖ MARQUE LE BILLET COMME ENVOY√â
const pid = btn.closest("[data-pid]")?.dataset.pid;
if (pid) {
  await set(
    ref(db, `participants/${reservationId}/${pid}/ticketSent`),
    true
  );
}

alert("‚úÖ Billet envoy√© √† " + email);
updateTable(); // üîÑ rafra√Æchit le badge

  } catch (err) {
    alert("‚ùå Erreur envoi billet");
  }

  sendingParticipantTicket = false;
});

  

function updateTable() {
  const container = document.getElementById("resBody");
  container.innerHTML = "";
  const entries = Object.entries(seats || {});
  if (!entries.length) return container.innerHTML = '<p>Aucune r√©servation.</p>';

  // === Regroupement des r√©servations par client ===
const grouped = {};

for (const [id, data] of entries) {
  const key = data.name || "Inconnu";

  if (!grouped[key]) {
    grouped[key] = {
      ...data,
      seats: [],
      emails: new Set(),
      allPaid: true,
    };
  }

  grouped[key].seats.push({
  id,
  paid: !!data.paid,
  type: data.type || null,   // üëà essentiel
});


  grouped[key].emails.add(data.email || "N/A");

  // ‚úÖ Si au moins un si√®ge n‚Äôest pas pay√© ‚Üí la ligne sera rose
  if (!data.paid) grouped[key].allPaid = false;
}



  const sorted = Object.entries(grouped).sort(([, a], [, b]) =>
    (a.name || "").localeCompare(b.name || "", "fr", { sensitivity: "base" })
  );

  for (const [name, info] of sorted) {
    let reservationId = info.reservationId || info.resId || info.reservationID || info.reservation_id || null;
    if (!reservationId) {
      // ‚ö†Ô∏è anciennes r√©servations : pas de reservationId stock√©
      reservationId = `legacy-${btoa(unescape(encodeURIComponent((info.email||name||"").toString()))).replace(/=+$/,"")}`;
    }
  const div = document.createElement("div");
  div.className = "accordion";
  const header = document.createElement("div");
header.className = `accordion-header ${
  info.free ? "free-line" : (info.allPaid ? "paid" : "unpaid")
}`;
// üßπ Supprime un √©ventuel ancien badge participant (√©vite doublons)
const oldBadge = header.querySelector(".participant-badge");
if (oldBadge) oldBadge.remove();

const hasFreeSeat = info.seats.some(
  s => s.type === "gratuit"
);



const freeBadge = hasFreeSeat
  ? '<span style="width:22px;height:22px;border-radius:50%;background:#8e24aa;color:white;font-weight:700;display:inline-flex;align-items:center;justify-content:center;font-size:13px;">G</span>'
  : '';


header.innerHTML = `
<div>
  üë§ ${name}
  ${
    info.free
      ? ""
      : `<br><span style="font-weight:600;color: red;">
           (${(Number(info.nbAdult || 0) + Number(info.nbChild || 0))} places)
         </span>`
  }
</div>



  <div class="badge-container" style="display:flex;align-items:center;gap:8px;">
    <span>${info.allPaid ? "üí∞" : "‚ùå Partiel / Non pay√©"}</span>
    ${freeBadge}
  </div>
`;

// üîî BADGE PARTICIPANTS NON ENVOY√âS (hors admin)
if (reservationId && !admin) {
  get(ref(db, `participants/${reservationId}`)).then(snap => {
    const participants = snap.val() || {};
    const notSent = Object.values(participants)
      .filter(p => !p.ticketSent)
      .length;

    if (notSent > 0) {
      const badge = document.createElement("span");
      badge.className = "participant-badge";
      badge.textContent = notSent;

      const container = header.querySelector(".badge-container");
      if (container) container.appendChild(badge);
    }
  });
}




  header.onclick = () => div.classList.toggle("open");

  const content = document.createElement("div");
  content.className = "accordion-content";
  // --- Ajout √† faire juste avant content.innerHTML = ...
  const adults = info.seats.filter(s => s.type === "adulte");
const children = info.seats.filter(s => s.type === "enfant");
const babies = info.seats.filter(s => s.type === "moins8");

content.innerHTML = `
  <p><strong>Email :</strong> ${info.email || "‚Äî"}</p>
  <p><strong>T√©l√©phone :</strong> ${info.phone || "‚Äî"}</p>

<button
  class="open-participants-btn"
  data-resid="${reservationId}"
  style="
    margin:6px 0;
    background:#6a1b9a;
    color:white;
    border:none;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
  ">
  üë• G√©rer les participants
</button>
<button
  class="send-participants-form-btn"
  data-resid="${reservationId}"
  data-email="${info.email}"
  style="
    margin:6px 0;
    background:#1976d2;
    color:white;
    border:none;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
  ">
  üì® Envoyer le formulaire participants
</button>

<div id="participants-${reservationId}"></div>


  <p><strong>üßç Adultes :</strong> ${adults.length} √ó ${PRICE_ADULT} ‚Ç¨ ‚Üí
    <span style="color:#1565c0;font-weight:600">
      ${adults.map(s => s.id).join(", ") || "‚Äî"}
    </span>
  </p>

  <p><strong>üßí Enfants :</strong> ${children.length} √ó ${PRICE_CHILD} ‚Ç¨ ‚Üí
    <span style="color:#0288d1;font-weight:600">
      ${children.map(s => s.id).join(", ") || "‚Äî"}
    </span>
  </p>

  <p><strong>üçº Moins de 8 ans :</strong> ${babies.length} ‚Üí
    <span style="color:#6a1b9a;font-weight:600">
      ${babies.map(s => s.id).join(", ") || "‚Äî"}
    </span>
  </p>

  <p><strong>Total :</strong> ${(
  (info.seats.filter(s => s.type === "adulte").length * PRICE_ADULT) +
  (info.seats.filter(s => s.type === "enfant").length * PRICE_CHILD)
).toFixed(2)} ‚Ç¨</p>

`;

content.innerHTML += `
  <div class="seat-list" style="margin-top:8px;">
    ${info.seats.map(s => {
      const icon =
s.type === "moins8" || s.type === "gratuit" ? "üéüÔ∏è GRATUIT" :
s.type === "adulte" ? "üßç" :
s.type === "enfant" ? "üßí" : "üéüÔ∏è";


      const paidIcon = s.paid ? "üí∞" : "‚ùå";

      return `
        <span class="badge-seat" style="
          background:${s.paid ? "#43a047" : "#ef5350"};
          color:white;border-radius:6px;padding:4px 8px;font-size:0.85rem;
        ">${icon} ${s.id} ${paidIcon}</span>
      `;
    }).join("")}
  </div>



<div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;flex-wrap:wrap;gap:6px;">
  <label>üí∂ Tout pay√© 
    <input type="checkbox" class="paid-toggle-client" data-name="${name}" ${info.allPaid ? "checked" : ""}>
  </label>

  ${admin ? `
  <div class="group-actions" data-client="${name}" style="display:flex;gap:6px;flex-wrap:wrap;">
    <button class="group-add-btn" data-name="${name}" style="background:#2e7d32;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">‚ûï Ajout group√©</button>
    <button class="group-remove-btn" data-name="${name}" style="background:#d32f2f;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">üóëÔ∏è Suppression group√©e</button>
    <button class="group-validate-btn" data-name="${name}" style="display:none;background:#1565c0;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">‚úÖ Valider</button>

    <!-- üìß NOUVEAU BOUTON -->
    <button
      class="resend-ticket-btn"
      data-name="${name}"
      data-email="${info.email}"
      style="background:#1976d2;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">
      üìß Renvoyer le billet
    </button>
  </div>
  ` : ""}
</div>


  `;

  div.append(header, content);
  container.append(div);
  // üë• charge la liste des participants si disponible

}



  // === Gestion stable de la case "Tout pay√©" (sans cumul) ===
    // === Gestion stable de la case "Tout pay√©" (sans cumul) ===
    document.querySelectorAll(".paid-toggle-client").forEach(cb => {
      cb.addEventListener("change", async e => {
    if (!admin) {
      alert("‚ö†Ô∏è Vous devez √™tre en mode admin pour modifier le paiement.");
      e.target.checked = !e.target.checked;
      return;
    }

    const clientName = e.target.dataset.name;
    const isPaid = e.target.checked;

    console.log(`üí∂ Mise √† jour du paiement pour ${clientName} ‚Üí ${isPaid}`);

    // ‚úÖ Met √† jour tous les si√®ges de ce client dans Firebase
    for (const [id, data] of Object.entries(seats)) {
      if (data.name === clientName) {
        data.paid = isPaid;
        await set(ref(db, `seats/${id}`), data);
      }
    }

    // üîÑ Rafra√Æchit les affichages
    render();
    updateTable();
    updateStatsBar();

    // üìß (Optionnel) Notifie le client
    const clientSeat = Object.values(seats).find(s => s.name === clientName);
    if (clientSeat?.email) {
      try {
        await notifyClientUpdate(clientSeat.email);
        console.log(`üì® Email envoy√© √† ${clientSeat.email}`);
      } catch (err) {
        console.error("Erreur d‚Äôenvoi d‚Äôe-mail :", err);
      }
    }
  });





}); // ‚Üê ferme cb.addEventListener
};   // ‚Üê ferme updateTable()

// ===================================================
// üéüÔ∏è G√©n√©ration HTML du billet (client principal)
// ===================================================
function generateBilletHTML(user) {
  const reservedSeats = Object.entries(seats)
    .filter(([_, s]) => s.email === user.email)
    .map(([id]) => id)
    .join(", ");

  const qrData = JSON.stringify({
    nom: user.name,
    email: user.email,
    tel: user.phone,
    sieges: reservedSeats
  });

  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrData)}`;

  return `
    <h2>üé≠ Votre billet ‚Äî Th√©√¢tre Saint Martin</h2>

    <p>
      Merci de votre r√©servation <strong>${user.name}</strong>,<br>
      Voici votre billet √† pr√©senter √† l‚Äôentr√©e du spectacle,
      soit <strong>imprim√©</strong>, soit sur <strong>votre t√©l√©phone</strong>.
    </p>

    <p><strong>üéüÔ∏è Si√®ges r√©serv√©s :</strong> ${reservedSeats}</p>

    <img src="${qrUrl}" alt="QR Code" style="margin-top:12px;" />

    <p style="margin-top:12px;">
      üìÖ <strong>24 janvier 2026 ‚Äì 20h30</strong><br>
      üìç Th√©√¢tre Saint Martin
    </p>

    <p>√Ä tr√®s bient√¥t üé≠</p>
  `;
}

// ===================================================
// üìß BOUTON ADMIN : RENVOYER LE BILLET AU CLIENT
// ===================================================
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".resend-ticket-btn");
  if (!btn) return;

  if (!admin) {
    alert("‚ùå Mode admin requis");
    return;
  }

  const email = btn.dataset.email;
  const name = btn.dataset.name;

  if (!email) {
    alert("‚ùå Aucun email pour ce client");
    return;
  }

  // üîç Retrouve tous les si√®ges du client
  const clientSeats = Object.entries(seats)
    .filter(([_, s]) => s.email === email);

  if (!clientSeats.length) {
    alert("‚ùå Aucune r√©servation trouv√©e");
    return;
  }

  const user = {
    name,
    email,
    phone: clientSeats[0][1].phone || "",
    paid: clientSeats.every(([_, s]) => s.paid),
    amount: clientSeats[0][1].amount || 0
  };

  if (!confirm(`üìß Renvoyer le billet √† ${email} ?`)) return;

const html = generateBilletHTML(user);

await sendViaBrevo(
  user.email,
  "üéüÔ∏è Votre billet ‚Äì Th√©√¢tre Saint-Martin (Salle)",
  html
);



  alert("‚úÖ Billet renvoy√© avec succ√®s");
});


// === Ajouter des si√®ges manuellement (mode admin) ===
document.querySelectorAll(".add-seat-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    if (!admin) return alert("‚ö†Ô∏è Activez le mode admin.");
    const clientName = btn.dataset.name;
    const clientSeat = Object.entries(seats).find(([_, d]) => d.name === clientName);
    if (!clientSeat) return alert("‚ùå Client introuvable.");

    const modal = document.getElementById("addSeatModal");
    const map = document.getElementById("miniSeatMap");
    const manualInput = document.getElementById("manualSeatInput");
    const paidBox = document.getElementById("addSeatPaid");
    const adultInput = document.getElementById("addSeatAdult");
    const childInput = document.getElementById("addSeatChild");
    const babyInput = document.getElementById("addSeatBaby");
    const totalDisplay = document.getElementById("addSeatTotal");

    document.getElementById("addSeatClient").textContent = `Client : ${clientName}`;
    map.innerHTML = "";
    manualInput.value = "";
    paidBox.checked = false;
    adultInput.value = 0;
    childInput.value = 0;
    babyInput.value = 0;
    totalDisplay.textContent = "Total : 0 ‚Ç¨";

    // üé® Affichage des si√®ges libres (mini version)
    const allSeats = Array.from(document.querySelectorAll(".seat.free"));
    allSeats.forEach(el => {
      const id = el.dataset.id;
      const seatBtn = document.createElement("button");
      seatBtn.textContent = id;
      seatBtn.className = "mini-seat";
      seatBtn.style.cssText = `
        width:45px;height:30px;
        border:none;
        border-radius:6px;
        background:#e0e0e0;
        color:#000;
        cursor:pointer;
        font-size:12px;
        font-weight:600;
      `;
      seatBtn.onclick = () => seatBtn.classList.toggle("selected");
      map.appendChild(seatBtn);
    });

    // üßÆ Recalcul du total
    function updateTotal() {
      const a = parseInt(adultInput.value) || 0;
      const c = parseInt(childInput.value) || 0;
      const b = parseInt(babyInput.value) || 0;
      totalDisplay.textContent = `Total : ${(a * PRICE_ADULT + c * PRICE_CHILD).toFixed(2)} ‚Ç¨`; // üë∂ Moins de 8 ans gratuit
    }
    adultInput.oninput = childInput.oninput = babyInput.oninput = updateTotal;

    modal.classList.remove("hidden");

    document.getElementById("addSeatCancel").onclick = () => modal.classList.add("hidden");

    document.getElementById("addSeatConfirm").onclick = async () => {
  const chosen = Array.from(map.querySelectorAll(".mini-seat.selected")).map(b => b.textContent);
  const typed = manualInput.value.split(",").map(s => s.trim().toUpperCase()).filter(Boolean);
  const allChosen = [...chosen, ...typed];
  const nbA = parseInt(adultInput.value) || 0;
  const nbC = parseInt(childInput.value) || 0;
  const nbB = parseInt(babyInput.value) || 0;
  const totalPeople = nbA + nbC + nbB;
  const totalAdd = nbA * PRICE_ADULT + nbC * PRICE_CHILD; // üë∂ moins de 8 ans gratuit

  if (!allChosen.length) return alert("‚ö†Ô∏è Aucun si√®ge s√©lectionn√©.");
  if (totalPeople !== allChosen.length)
    return alert(`‚ö†Ô∏è ${totalPeople} personne(s) pour ${allChosen.length} si√®ge(s).`);

  // üîç R√©cup√®re les anciens totaux du client
  let oldA = 0, oldC = 0, oldB = 0, oldTotal = 0;
  for (const [sid, data] of Object.entries(seats)) {
    if (data.name === clientName) {
      oldA = parseInt(data.nbAdult || 0);
      oldC = parseInt(data.nbChild || 0);
      oldB = parseInt(data.nbBaby  || 0);
      oldTotal = parseFloat(data.amount || 0);
      break;
    }
  }

  const newA = oldA + nbA;
  const newC = oldC + nbC;
  const newB = oldB + nbB;
  const newTotal = oldTotal + totalAdd;

  // ü™ë Ajout des nouveaux si√®ges
  let added = 0;
  for (let id of allChosen) {

    // ‚úÖ Correction : normalise les IDs pour les strapontins ("S15", "S16" ‚Üí "A-S15", etc.)
    if (/^S\d+$/i.test(id)) {
      id = `A-${id}`; // üü° tu peux changer la lettre de rang√©e ici si besoin
    }

    const seatEl = document.querySelector(`.seat[data-id="${id}"]`);
    console.log("Ajout manuel :", id, "‚Üí", seatEl ? "OK" : "non trouv√©");

    if (!seatEl) {
      alert(`‚ö†Ô∏è Le si√®ge ${id} n'existe pas dans le plan.`);
      continue;
    }

    if (!seatEl.classList.contains("free")) {
      alert(`‚ö†Ô∏è Le si√®ge ${id} est d√©j√† r√©serv√©.`);
      continue;
    }

    const type = added < nbA ? "adulte" : added < nbA + nbC ? "enfant" : "moins8";

    seats[id] = {
  name: groupClient,
  email: baseData.email,
  phone: baseData.phone,
  paid: baseData.paid || false,
  nbAdult: baseData.nbAdult,
  nbChild: baseData.nbChild,
  nbBaby: baseData.nbBaby,
  amount: baseData.amount,
  type: seatType, // ‚úÖ maintenant le bon type est gard√©
};

    added++;
  }

  // ‚úÖ Met √† jour TOUS les si√®ges du client avec les nouveaux totaux
  for (const [sid, data] of Object.entries(seats)) {
    if (data.name === clientName) {
      data.nbAdult = newA;
      data.nbChild = newC;
      data.nbBaby  = newB;
      data.amount  = newTotal;
    }
  }

  if (added > 0) {
    save();
    render();       // üü¢ met √† jour visuellement le plan
    updateTable();  // üü¢ met √† jour la liste de r√©servations
    updateStatsBar(); // üßÆ met √† jour la barre de stats

    // ‚ú® Ouvre automatiquement l‚Äôaccord√©on du client ajout√©
    setTimeout(() => {
      const accHeader = [...document.querySelectorAll('.accordion-header')]
        .find(h => h.textContent.includes(clientName));
      if (accHeader && accHeader.parentElement) {
        accHeader.parentElement.classList.add('open');
        accHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
        accHeader.style.transition = "background 0.4s";
        accHeader.style.background = "#fff59d";
        setTimeout(() => accHeader.style.background = "", 1200);
      }
    }, 300);
// üìß Envoi automatique d'un e-mail de mise √† jour avec QR code actualis√©
const clientData = Object.values(seats).find(s => s.name === clientName);
if (clientData) {
  await notifyClientUpdate(clientData.email); // ‚úÖ on envoie la version ‚Äúmise √† jour compl√®te‚Äù
  console.log(`üì® Email de mise √† jour envoy√© √† ${clientData.email} apr√®s ajout de si√®ge.`);
}

    alert(`‚úÖ ${added} si√®ge(s) ajout√©(s) √† ${clientName} (${newA} adultes, ${newC} enfants, ${newB} -8 ans).`);
  }

  modal.classList.add("hidden");
};


  });
});




// === ‚öôÔ∏è Gestion des ajouts/suppressions group√©s (version finale propre) ===
let groupMode = null;
let groupClient = null;
let groupChanges = [];

// === ‚öôÔ∏è Gestion des ajouts/suppressions group√©s ===
document.addEventListener("click", async (e) => {
  const addBtn = e.target.closest(".group-add-btn");
  const removeBtn = e.target.closest(".group-remove-btn");
  const validateBtn = e.target.closest(".group-validate-btn");

  // ‚ûï AJOUT GROUP√â
  if (addBtn) {
    groupMode = "add";
    groupClient = addBtn.dataset.name;
    groupChanges = [];
    addBtn.parentElement.querySelector(".group-validate-btn").style.display = "inline-block";
    alert(`üü¢ Mode AJOUT group√© activ√© pour ${groupClient}. S√©lectionnez les si√®ges libres √† ajouter.`);
    return;
  }

  // üóëÔ∏è SUPPRESSION GROUP√âE
  if (removeBtn) {
    groupMode = "remove";
    groupClient = removeBtn.dataset.name;
    groupChanges = [];
    removeBtn.parentElement.querySelector(".group-validate-btn").style.display = "inline-block";
    alert(`üî¥ Mode SUPPRESSION group√©e activ√© pour ${groupClient}. Cliquez sur les si√®ges r√©serv√©s √† supprimer.`);
    return;
  }

  // ‚úÖ VALIDATION
  if (validateBtn) {
    if (!groupClient || !groupChanges.length) {
      alert("Aucune modification d√©tect√©e.");
      return;
    }

    const action = groupMode === "add" ? "ajout√©s" : "supprim√©s";
    if (!confirm(`Confirmer ${groupChanges.length} si√®ge(s) ${action} pour ${groupClient} ?`)) return;

    // --- SUPPRESSION
if (groupMode === "remove") {
  for (const id of groupChanges) {
    if (seats[id]) delete seats[id];
  }

  // ‚úÖ Enregistre les changements et rafra√Æchit l‚Äôaffichage
  save();
  render();
  updateTable();
  updateStatsBar();

  const clientData = Object.values(seats).find(s => s.name === groupClient);
  if (clientData?.email) {
    const sendMail = await askEmailConfirmation(clientData.email);

    if (sendMail) await notifyClientUpdate(clientData.email);
  }
}

    // --- AJOUT
    if (groupMode === "add") {
      const baseData = Object.values(seats).find(s => s.name === groupClient);
      if (!baseData) {
        alert(`‚ùå Impossible d‚Äôajouter : aucune donn√©e trouv√©e pour ${groupClient}`);
      } else {
        let addAdult = 0, addChild = 0, addBaby = 0;

        for (const { id } of groupChanges) {
          const seatType = await askSeatType(id);
          if (!seatType) continue;

if (seatType === "adulte") addAdult++;
else if (seatType === "enfant") addChild++;
else if (seatType === "moins8" || seatType === "gratuit") addBaby++;


          seats[id] = {
            name: groupClient,
            email: baseData.email,
            phone: baseData.phone,
            paid: baseData.paid || false,
            nbAdult: baseData.nbAdult || 0,
            nbChild: baseData.nbChild || 0,
            nbBaby: baseData.nbBaby || 0,
            amount: baseData.amount || 0,
            type: seatType
          };
        }

        const newAdult = (baseData.nbAdult || 0) + addAdult;
        const newChild = (baseData.nbChild || 0) + addChild;
        const newBaby  = (baseData.nbBaby  || 0) + addBaby;
        const newAmount = newAdult * PRICE_ADULT + newChild * PRICE_CHILD;

        const refId = Object.entries(seats).find(([sid, s]) => s.name === groupClient)?.[0];
        if (refId && seats[refId]) {
          seats[refId].nbAdult = newAdult;
          seats[refId].nbChild = newChild;
          seats[refId].nbBaby  = newBaby;
          seats[refId].amount  = newAmount;
        }

        save();
        render();
        updateTable();
        updateStatsBar();

        const clientData = Object.values(seats).find(s => s.name === groupClient);
        if (clientData?.email) {
          const sendMail = await askEmailConfirmation(clientData.email);

          if (sendMail) await notifyClientUpdate(clientData.email);
        }

        alert(`‚úÖ Ajout termin√© : ${addAdult} adulte(s), ${addChild} enfant(s), ${addBaby} -8 ans`);
      }
    }

    // --- FIN ---
    alert(`‚úÖ ${groupChanges.length} si√®ge(s) ${groupMode === "add" ? "ajout√©(s)" : "supprim√©(s)"} pour ${groupClient}.`);

    groupMode = null;
    groupClient = null;
    groupChanges = [];
    document.querySelectorAll(".group-validate-btn").forEach(b => (b.style.display = "none"));
  }
}); // ‚úÖ plus aucune erreur ici


// === Clic sur un si√®ge pendant un mode group√© ===
hall.addEventListener("click", (e) => {
  const seatEl = e.target.closest(".seat");
  if (!seatEl || !groupMode || !groupClient) return;

  const id = seatEl.dataset.id;

  // === Mode AJOUT ===
  if (groupMode === "add" && seatEl.classList.contains("reserved")) {
    seatEl.classList.toggle("selected", !seatEl.classList.contains("selected"));
    if (seatEl.classList.contains("selected")) {
      seatEl.classList.add("add-mode");
      seatEl.style.backgroundColor = "#a5d6a7"; // vert clair

      groupChanges.push({ id, name: groupClient });
    } else {
      seatEl.classList.remove("add-mode");
      seatEl.style.backgroundColor = "";

      groupChanges = groupChanges.filter(s => s.id !== id);
    }
  }

  // === Mode SUPPRESSION ===
else if (
  groupMode === "remove" &&
  (
    seatEl.classList.contains("reserved") ||
    seatEl.classList.contains("paid") ||
    seatEl.classList.contains("free-ticket")
  )
) {


    seatEl.classList.toggle("selected", !seatEl.classList.contains("selected"));
    if (seatEl.classList.contains("selected")) {
      seatEl.classList.add("remove-mode");
      groupChanges.push(id);
    } else {
      seatEl.classList.remove("remove-mode");
      groupChanges = groupChanges.filter(x => x !== id);
    }
  }
});



/* === Scanner et Aide === */
document.getElementById("scanTicket").onclick = () => window.location.href = "scanner.html";
document.getElementById("info").onclick = () => window.open("mode_emploi.pdf", "_blank");

/* === Zoom/drag mobile (version fluide) === */
const wrapper = document.querySelector(".hall-wrapper");
let scale = 1;
let lastDist = 0;
let startMid = { x: 0, y: 0 };
let translate = { x: 0, y: 0 };

wrapper.addEventListener("touchstart", (e) => {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    lastDist = Math.hypot(dx, dy);
    startMid = {
      x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
      y: (e.touches[0].clientY + e.touches[1].clientY) / 2,
    };
  }
});

wrapper.addEventListener("touchmove", (e) => {
  if (e.touches.length === 2) {
    e.preventDefault(); // on bloque le scroll seulement pendant le zoom
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.hypot(dx, dy);

    if (lastDist) {
      const delta = dist / lastDist;
      scale = Math.max(0.8, Math.min(3, scale * delta));
      hall.style.transform = `scale(${scale})`;
    }

    lastDist = dist;
  }
});

wrapper.addEventListener("touchend", (e) => {
  if (e.touches.length < 2) lastDist = 0;
});


wrapper.addEventListener("touchend", e => {
  if (e.touches.length < 2) lastDist = 0;
  if (e.touches.length === 0) isDragging = false;
});


/* === üí∂ Gestion des tarifs personnalisables === */
const editPricesBtn = document.getElementById("editPrices");
const priceModal = document.getElementById("priceModal");
const priceAdultInput = document.getElementById("priceAdult");
const priceChildInput = document.getElementById("priceChild");

// === Valeurs par d√©faut ou charg√©es du localStorage ===


/* === Affiche les tarifs actuels dans les labels === */
function updatePriceLabels() {
  const mainAdult = document.getElementById("labelPriceAdult");
  const mainChild = document.getElementById("labelPriceChild");
  const addAdult = document.getElementById("labelAddSeatPriceAdult");
  const addChild = document.getElementById("labelAddSeatPriceChild");

  if (mainAdult) mainAdult.textContent = PRICE_ADULT.toFixed(2);
  if (mainChild) mainChild.textContent = PRICE_CHILD.toFixed(2);
  if (addAdult) addAdult.textContent = PRICE_ADULT.toFixed(2);
  if (addChild) addChild.textContent = PRICE_CHILD.toFixed(2);
}

/* === Ouvrir/Fermer la modale === */
function openPriceModal() {
  priceAdultInput.value = PRICE_ADULT;
  priceChildInput.value = PRICE_CHILD;
  priceModal.classList.remove("hidden");
}
document.getElementById("cancelPrices").onclick = () => priceModal.classList.add("hidden");

/* === Enregistrer les nouveaux tarifs === */
document.getElementById("savePrices").onclick = () => {
  const newAdult = parseFloat(priceAdultInput.value);
  const newChild = parseFloat(priceChildInput.value);
  if (isNaN(newAdult) || isNaN(newChild)) {
    alert("‚ö†Ô∏è Les tarifs doivent √™tre des nombres valides.");
    return;
  }

  const oldAdult = PRICE_ADULT;
  const oldChild = PRICE_CHILD;

  PRICE_ADULT = newAdult;
  PRICE_CHILD = newChild;

  localStorage.setItem("PRICE_ADULT", PRICE_ADULT);
  localStorage.setItem("PRICE_CHILD", PRICE_CHILD);

  updatePriceLabels();
  render();
  updateTable();

  const msg = document.getElementById("priceMessage");
  if (msg) {
    msg.textContent = `‚úîÔ∏è Tarifs mis √† jour :
    Adulte : ${oldAdult.toFixed(2)} ‚Ç¨ ‚Üí ${PRICE_ADULT.toFixed(2)} ‚Ç¨ |
    Enfant : ${oldChild.toFixed(2)} ‚Ç¨ ‚Üí ${PRICE_CHILD.toFixed(2)} ‚Ç¨`;
    msg.style.display = "block";
    msg.style.opacity = 1;

    setTimeout(() => {
      msg.style.transition = "opacity 0.5s";
      msg.style.opacity = 0;
      setTimeout(() => {
        msg.style.display = "none";
        priceModal.classList.add("hidden");
      }, 600);
    }, 1800);
  }
};

// === üíå Bouton de test Email (avec sauvegarde persistante) ===
const emailTestBtn = document.getElementById("toggleEmailTest");

// üîÑ Charge la pr√©f√©rence sauvegard√©e dans le navigateur
// D√©sactiv√© par d√©faut, activ√© uniquement si "true" est enregistr√©



// ‚öôÔ∏è Fonction pour mettre √† jour l‚Äôapparence du bouton
function updateEmailTestButton() {
  const banner = document.getElementById("emailModeBanner");

  // Met √† jour le texte et la couleur du bouton admin
  emailTestBtn.textContent = EMAIL_TEST_MODE
    ? "‚úâÔ∏è Mode email : TEST"
    : "‚úâÔ∏è Mode email : R√âEL";
  emailTestBtn.style.background = EMAIL_TEST_MODE ? "#607d8b" : "#2e7d32";

  // üí° Affiche le bandeau uniquement quand le mode TEST est actif
  if (EMAIL_TEST_MODE) {
    banner.textContent = "‚úâÔ∏è Mode email : TEST (aucun envoi)";
    banner.style.background = "#607d8b";
    banner.style.display = "block";
  } else {
    banner.style.display = "none";
  }
}



// üß© Clique sur le bouton pour basculer le mode
emailTestBtn.onclick = () => {
  EMAIL_TEST_MODE = !EMAIL_TEST_MODE;

  // üíæ Sauvegarde la pr√©f√©rence dans localStorage
  localStorage.setItem("EMAIL_TEST_MODE", EMAIL_TEST_MODE);

  // üîÑ Met √† jour le bouton
  updateEmailTestButton();

alert(
  `üîß Mode email ${EMAIL_TEST_MODE ? "TEST (aucun envoi)" : "R√âEL (Brevo actif)"}`
);

};

// ‚ûï Affiche le bouton seulement en mode admin
function toggleAdminUI() {
  const isAdmin = document.body.classList.contains("admin");

  editPricesBtn.style.display = isAdmin ? "inline-block" : "none";
  emailTestBtn.style.display = isAdmin ? "inline-block" : "none";
  document.getElementById("bulkReminder").style.display =
    isAdmin ? "inline-block" : "none";
}


// üîπ Initialisation de l‚Äôinterface
editPricesBtn.onclick = openPriceModal;
updatePriceLabels();
toggleAdminUI();

// üß© Met √† jour le texte du bouton au d√©marrage
updateEmailTestButton();


  // üîπ Regroupe par client
  const grouped = {};
  for (const [id, data] of Object.entries(seats)) {
    if (!grouped[data.name]) grouped[data.name] = [];
    grouped[data.name].push(data);
  }

// üîÑ Nouvelle logique : on compte chaque si√®ge pay√© individuellement
function updateStatsBar() {
  let totalAmount = 0;
  let totalAdult = 0;
  let totalChild = 0;
  let totalBaby = 0;
  const soldSeats = Object.keys(seats).length;

  // üîπ Regroupe les si√®ges par client
  const grouped = {};
  for (const data of Object.values(seats)) {
    if (!grouped[data.name]) grouped[data.name] = [];
    grouped[data.name].push(data);
  }

  // üîπ Pour chaque client : si tous ses si√®ges sont pay√©s ‚Üí on recalcule son total
  for (const client of Object.values(grouped)) {
    const allPaid = client.every(s => s.paid);
    if (allPaid) {
      const nbAdult = client.filter(s => s.type === "adulte").length;
      const nbChild = client.filter(s => s.type === "enfant").length;
      const nbBaby  = client.filter(s => s.type === "moins8").length;

      totalAmount += nbAdult * PRICE_ADULT + nbChild * PRICE_CHILD;
      totalAdult  += nbAdult;
      totalChild  += nbChild;
      totalBaby   += nbBaby;
    }
  }

  // üîÑ Mise √† jour visuelle
  document.getElementById("stat-total").textContent =
    `üí∞ Total encaiss√© : ${totalAmount.toFixed(2)} ‚Ç¨`;
  document.getElementById("stat-adult").textContent =
    `üßç Adultes : ${totalAdult}`;
  document.getElementById("stat-child").textContent =
    `üë∂ Enfants : ${totalChild}`;
  document.getElementById("stat-baby").textContent =
    `üçº Moins de 8 ans : ${totalBaby}`;
  document.getElementById("stat-sold").textContent =
    `üéüÔ∏è Places r√©serv√©es : ${soldSeats}`;
}


async function askEmailConfirmation(email) {
  return new Promise(resolve => {
    const modal = document.getElementById("emailConfirmModal");
    const text = document.getElementById("emailConfirmText");
    text.textContent = `Souhaitez-vous envoyer un e-mail de mise √† jour √† ${email} ?`;

    modal.classList.remove("hidden");

    const yesBtn = document.getElementById("emailConfirmYes");
    const noBtn = document.getElementById("emailConfirmNo");

    function cleanup(result) {
      modal.classList.add("hidden");
      yesBtn.removeEventListener("click", onYes);
      noBtn.removeEventListener("click", onNo);
      resolve(result);
    }

    function onYes() { cleanup(true); }
    function onNo() { cleanup(false); }

    yesBtn.addEventListener("click", onYes);
    noBtn.addEventListener("click", onNo);
  });
}

// ===================================================
// üîî OUVERTURE MODALE RAPPEL (choix des clients)
// ===================================================
document.getElementById("bulkReminder").onclick = () => {
  if (!admin) return alert("‚ùå Mode admin requis");

  const modal = document.getElementById("bulkSelectModal");
  const list = document.getElementById("clientCheckboxList");
  const selectAll = document.getElementById("selectAllClients");

  list.innerHTML = "";
  selectAll.checked = false;

  // Regroupe par email
  const clients = {};
  for (const [id, s] of Object.entries(seats)) {
    if (!s.email) continue;
    if (!clients[s.email]) {
      clients[s.email] = {
        name: s.name,
        email: s.email
      };
    }
  }

  // Cr√©e les checkbox
  Object.values(clients).forEach(c => {
    const div = document.createElement("div");
    div.style.marginBottom = "6px";
    div.innerHTML = `
      <label>
        <input type="checkbox" class="client-check" value="${c.email}">
        <strong>${c.name}</strong>
        <span style="font-size:12px;color:#666;">(${c.email})</span>
      </label>
    `;
    list.appendChild(div);
  });

  // ‚úîÔ∏è Tous / aucun
  selectAll.onchange = () => {
    document.querySelectorAll(".client-check")
      .forEach(cb => cb.checked = selectAll.checked);
  };

  modal.classList.remove("hidden");
};

// ===================================================
// ‚ùå √âTAPE 4 ‚Äî BOUTON ANNULER (FERMETURE MODALE RAPPEL)
// ===================================================
document.getElementById("bulkCancel").onclick = () => {
  document.getElementById("bulkSelectModal").classList.add("hidden");
};
// ===================================================
// üìß √âTAPE 5 ‚Äî ENVOI RAPPEL AUX CLIENTS S√âLECTIONN√âS
// ===================================================
document.getElementById("bulkSendSelected").onclick = async () => {
  if (!admin) {
    alert("‚ùå Mode admin requis");
    return;
  }

  const checked = [...document.querySelectorAll(".client-check:checked")];

  if (!checked.length) {
    alert("‚ö†Ô∏è Aucun destinataire s√©lectionn√©");
    return;
  }

  if (!confirm(`üìß Envoyer un rappel √† ${checked.length} client(s) ?`)) return;

  for (const cb of checked) {
    const email = cb.value;

    // üîç R√©cup√®re tous les si√®ges de ce client
    const clientSeats = Object.entries(seats)
      .filter(([_, s]) => s.email === email);

    if (!clientSeats.length) continue;

// üîç Nom du r√©servant principal
let mainClientName = clientSeats[0][1].name;

const user = {
  name: clientSeats[0][1].name,
  email,
  phone: clientSeats[0][1].phone || "",
  paid: clientSeats.every(([_, s]) => s.paid),
  amount: clientSeats[0][1].amount || 0,
  reservationId: clientSeats[0][1].reservationId || null,
  mainClientName // üëà ON LE PASSE ICI
};


    try {
      await sendReminderEmail(user); // ‚úÖ billet + QR code
      // ===============================
// üë• ENVOI DU RAPPEL AUX PARTICIPANTS
// ===============================
try {
  const snap = await get(ref(db, `participants/${user.reservationId || ""}`));
  const participants = snap.val() || {};

  for (const p of Object.values(participants)) {
    if (!p.email) continue;

const participantUser = {
  name: p.name,
  email: p.email,
  phone: p.phone || "",
  seats: clientSeats.map(([id]) => id),
  isParticipant: true,

};



    await sendReminderEmail(participantUser);
    console.log("üì® Rappel envoy√© au participant :", p.email);
  }
} catch (err) {
  console.error("‚ùå Erreur rappel participants :", err);
}

      console.log("üì® Rappel envoy√© √†", email);
    } catch (err) {
      console.error("‚ùå Erreur envoi", email, err);
    }
  }

  alert("‚úÖ Rappel envoy√© aux clients s√©lectionn√©s");
  document.getElementById("bulkSelectModal").classList.add("hidden");
};


// üë• (SUPPRIM√â) Ancien affichage global des participants




</script>



<!-- üßÆ Fen√™tre admin : saisie adultes/enfants -->
<div id="adminPaymentModal" class="modal hidden">
  <div class="modal-content">
    <h3>üí∞ Saisie du paiement</h3>
    <p id="adminClientName" style="font-weight:600;margin-bottom:10px;"></p>

    <label for="adminAdult">Nombre d‚Äôadultes (14 ‚Ç¨)</label>
    <input id="adminAdult" type="number" min="0" value="0" step="1">

    <label for="adminChild">Nombre d‚Äôenfants (10 ‚Ç¨)</label>
    <input id="adminChild" type="number" min="0" value="0" step="1">
	<label for="adminBaby">Nombre de moins de 8 ans</label>
<input id="adminBaby" type="number" min="0" value="0" step="1">


    <p id="adminTotal" style="font-weight:600;color:#2e7d32;margin-top:8px;">Total : 0 ‚Ç¨</p>

    <div style="margin-top:12px;">
      <button id="adminSavePayment">Valider</button>
      <button id="adminCancelPayment">Annuler</button>
    </div>
  </div>
</div>
<!-- üÜï Modale ajout manuel de si√®ges -->
<!-- üÜï Modale ajout manuel de si√®ges -->
<div id="addSeatModal" class="modal hidden">
  <div class="modal-content" style="max-width:480px;">
    <h3>‚ûï Ajouter des si√®ges</h3>
    <p id="addSeatClient" style="font-weight:600;margin-bottom:10px;"></p>

    <!-- üß≠ Mini plan des si√®ges -->
    <div id="miniSeatMap" style="
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap:5px;
      justify-items:center;
      margin-bottom:10px;
      max-height:250px;
      overflow-y:auto;
      padding:8px;
      background:#fafafa;
      border-radius:8px;
      border:1px solid #ddd;
    "></div>

    <p style="font-weight:600;">saisir manuellement :</p>
    <input id="manualSeatInput" type="text" placeholder="Ex : A-12, B-3, Stapontin: A-S15," style="width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:6px;margin-bottom:10px;">

    <div class="payment-group">
      <div class="payment-line">
        <label for="addSeatAdult">Adultes (${PRICE_ADULT} ‚Ç¨)</label>
        <input id="addSeatAdult" type="number" min="0" value="0" step="1" style="width:60px;">
      </div>
	  <div class="payment-line">
  <label for="addSeatBaby">Moins de 8 ans</label>
  <input id="addSeatBaby" type="number" min="0" value="0" step="1" style="width:60px;">
</div>

      <div class="payment-line">
        <label for="addSeatChild">Enfants (${PRICE_CHILD} ‚Ç¨)</label>
        <input id="addSeatChild" type="number" min="0" value="0" step="1" style="width:60px;">
      </div>
      <p id="addSeatTotal" style="margin-top:8px;text-align:right;font-weight:600;color:#2e7d32;">Total : 0 ‚Ç¨</p>
    </div>

    <label style="display:flex;align-items:center;gap:6px;margin:10px 0;">
      <input type="checkbox" id="addSeatPaid">
      üí∂ Si√®ges pay√©s
    </label>

    <div style="margin-top:12px;">
      <button id="addSeatConfirm">Valider</button>
      <button id="addSeatCancel">Annuler</button>
    </div>
  </div>
</div>


<!-- üí∂ Fen√™tre modale de modification des tarifs -->
<div id="priceModal" class="modal hidden">
  <div class="modal-content">
    <h3>üí∂ Modifier les tarifs</h3>

<label for="priceAdult">Tarif adulte (‚Ç¨)</label>
<input id="priceAdult" type="number" min="0" step="0.5" value="14">
<span id="labelPriceAdult" style="display:none;"></span>

<label for="priceChild">Tarif enfant (‚Ç¨)</label>
<input id="priceChild" type="number" min="0" step="0.5" value="10">
<span id="labelPriceChild" style="display:none;"></span>


    <div style="margin-top:12px;">
      <button id="savePrices">Enregistrer</button>
      <button id="cancelPrices">Annuler</button>
    </div>
  </div>
</div>
<!-- === Modal choix du type de billet === -->
<div id="typeModal" class="hidden" style="
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999;">
  <div style="background: white; padding: 20px 30px; border-radius: 12px; text-align: center;">
    <h3>üé´ Type de billet pour les si√®ges ajout√©s</h3>
    <p>S√©lectionnez le type appliqu√© √† tous les nouveaux si√®ges :</p>
    <button class="type-btn" data-type="adulte" style="margin:6px;padding:10px 16px;border:none;border-radius:8px;background:#1565c0;color:white;">üßç Adulte</button>
    <button class="type-btn" data-type="enfant" style="margin:6px;padding:10px 16px;border:none;border-radius:8px;background:#2e7d32;color:white;">üßí Enfant</button>
    <button class="type-btn" data-type="moins8" style="margin:6px;padding:10px 16px;border:none;border-radius:8px;background:#f57c00;color:white;">üçº Moins de 8 ans</button>
  </div>
</div>
<!-- üé´ Modal de choix du type de billet -->
<div id="ticketTypeModal" class="modal hidden">
  <div class="modal-content" style="max-width: 360px; text-align: center;">
    <h3>üé´ Type de billet</h3>
    <p id="ticketTypeSeat" style="font-weight:600; color:#0d47a1;"></p>
    <p>Choisis le type de place √† attribuer :</p>
    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
      <button class="ticket-type-btn" data-type="adulte" style="background:#1565c0;color:#fff;">üßç Adulte</button>
      <button class="ticket-type-btn" data-type="enfant" style="background:#2e7d32;color:#fff;">üßí Enfant</button>
      <button class="ticket-type-btn" data-type="moins8" style="background:#f57c00;color:#fff;">üçº Moins de 8 ans</button>
      <button class="ticket-type-btn" data-type="gratuit"
  style="background:#ff9800;color:#fff;">
  üéüÔ∏è Gratuit
</button>

      <button id="cancelTicketType" style="background:#757575;color:#fff;">‚ùå Annuler</button>
    </div>
  </div>
</div>

<!-- üîî Modale de confirmation d'envoi d'email -->
<div id="emailConfirmModal" class="modal hidden">
  <div class="modal-content" style="text-align:center; max-width:400px;">
    <h3>üì© Envoi d‚Äôe-mail de mise √† jour</h3>
    <p id="emailConfirmText" style="margin:15px 0;">Souhaitez-vous envoyer un e-mail √† cet utilisateur ?</p>
    <div style="display:flex;justify-content:center;gap:15px;margin-top:10px;">
      <button id="emailConfirmYes" style="background:#1565c0;color:white;">‚úÖ Oui</button>
      <button id="emailConfirmNo" style="background:#9e9e9e;color:white;">‚ùå Non</button>
    </div>
  </div>
</div>


<!-- üíå Modale de pr√©visualisation d‚Äôemail -->
<div id="emailPreviewModal" class="modal hidden">
  <div class="modal-content" style="max-width:600px;max-height:80vh;overflow:auto;text-align:left;">
    <h3>üìß Aper√ßu de l‚Äôemail</h3>
    <div id="emailPreviewContent" style="border:1px solid #ccc;padding:10px;margin-top:10px;background:#fff;"></div>
    <div style="text-align:center;margin-top:12px;">
      <button id="closeEmailPreview" style="background:#1565c0;color:white;">Fermer</button>
    </div>
  </div>
</div>
<script>
  document.getElementById("retour-dashboard").addEventListener("click", () => {
    window.location.href = "index.html";
  });
  // ===================================================
// ‚ùå Bouton FERMER ‚Äì aper√ßu email
// ===================================================
document.addEventListener("click", (e) => {
  if (e.target.id === "closeEmailPreview") {
    document.getElementById("emailPreviewModal").classList.add("hidden");
  }
});
async function sendViaBrevo(to, subject, html) {

  // üö´ MODE TEST ‚Üí AUCUN ENVOI
  if (window.EMAIL_TEST_MODE === true) {
    console.warn("üö´ [MODE TEST] Envoi Brevo bloqu√©");
    console.log("üìß Destinataire :", to);
    console.log("üì® Sujet :", subject);
    return;
  }

  const res = await fetch("https://brevo-mailer.theatre-sm-03.workers.dev/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ to, subject, html })
  });

  if (!res.ok) {
    throw new Error("Erreur Brevo");
  }
}





// üë• Toggle affichage participants
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".open-participants-btn");
  if (!btn) return;

  const reservationId = btn.dataset.resid;
  const box = document.getElementById(`participants-${reservationId}`);
  if (!box) return;

  if (box.innerHTML.trim() !== "") {
    box.innerHTML = "";
  } else {
    await loadParticipants(reservationId);
  }
});

// ‚ûï Ajout participant
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".add-participant-btn");
  if (!btn) return;

  const reservationId = btn.dataset.resid;
  if (!reservationId) return;

  const name = prompt("Nom du participant :");
  if (!name) return;

  const email = prompt("Email :") || "";
  const phone = prompt("T√©l√©phone :") || "";

  const pid = crypto.randomUUID();

  await set(ref(db, `participants/${reservationId}/${pid}`), {
    name,
    email,
    phone
  });

  await loadParticipants(reservationId);
});
// üì® Envoi formulaire participants
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".send-participants-form-btn");
  if (!btn) return;

  const email = btn.dataset.email;
  const reservationId = btn.dataset.resid;

  if (!email || !reservationId) {
    return alert("‚ùå Email ou r√©servation manquante");
  }

const formLink = `https://orleanne03.github.io/theatre-saint-martin/participants.html?resId=${encodeURIComponent(reservationId)}&salle=salle`;


const html = `
  <h2>üë• Informations des participants ‚Äî Th√©√¢tre Saint Martin</h2>

  <p>
    Bonjour.
  </p>

  <p>
    Vous avez r√©serv√© plusieurs places places pour le spectacle √† la Salle de Bessay
    Mais tout le monde n‚Äôarrive pas en m√™me temps ? Pas de souci üòä,
  </p>
<p>Par contre, chaque groupe devra simplement pr√©senter son QR code personnel √† l‚Äôentr√©e. Le QR code √©tant identique 1 seul par groupe suffira.</p>
  <p>
Il vous suffit de compl√©ter le formulaire ci-dessous pour que les QR codes soient envoy√©s directement √† une personne responsable du groupe suivant:
  </p>
<p>Une fois le formulaire compl√©t√©, nous pourrons envoyer les billets √† chaque personne concern√©e.</p>
  <p>
    üëâ <a href="${formLink}" target="_blank"
      style="font-weight:600;color:#1976d2;">
      Remplir le formulaire participants
    </a>
  </p>

  <p style="font-size:14px;color:#555;">
    Ce lien est personnel et li√© √† votre r√©servation.
  </p>

  <p>Merci et √† tr√®s bient√¥t üé≠</p>
`;



  try {
    await sendViaBrevo(
      email,
      "üë• Formulaire participants ‚Äì Th√©√¢tre Saint Martin",
      html
    );
    alert("‚úÖ Formulaire envoy√©");
  } catch (err) {
    alert("‚ùå Erreur envoi formulaire");
  }
});

</script>

<!-- üì® Indicateur visuel du mode email -->
<div id="emailModeBanner" style="
  position: fixed;
  top: 10px;
  left: 10px;
  background: #607d8b;
  color: white;
  font-weight: 600;
  padding: 8px 14px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 10000;
  display: none;
">
  ‚úâÔ∏è Mode email : TEST
</div>
<!-- üìß Modale choix destinataires rappel -->
<div id="bulkSelectModal" class="modal hidden">
  <div class="modal-content" style="max-width:520px;">
    <h3>üîî Rappel r√©servation</h3>
    <p>Choisissez les destinataires :</p>

    <div style="margin-bottom:10px;">
      <label style="font-weight:600;">
        <input type="checkbox" id="selectAllClients">
        ‚úîÔ∏è Tous les r√©servants
      </label>
    </div>

    <div id="clientCheckboxList"
         style="max-height:260px;overflow:auto;border:1px solid #ddd;
                padding:8px;border-radius:6px;margin-bottom:12px;">
      <!-- rempli dynamiquement -->
    </div>

    <div style="display:flex;justify-content:flex-end;gap:10px;">
      <button id="bulkCancel" style="background:#9e9e9e;">Annuler</button>
      <button id="bulkSendSelected" style="background:#1976d2;">üìß Envoyer</button>
    </div>
  </div>
</div>

</body>
</html>








<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>üéüÔ∏è Scanner ‚Äî Th√©√¢tre Saint Martin</title>

<!-- Librairie QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    margin: 0;
    padding: 16px;
    text-align: center;
    background: linear-gradient(180deg, #f9f9f9, #e3f2fd);
  }
  h1 { color: #0d47a1; margin: 6px 0; font-size: 1.3em; }
  p { margin: 4px 0 10px; }
  #reader {
    width: 90%;
    max-width: 320px;
    margin: 12px auto;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
  }
  .panel {
    max-width: 500px;
    margin: 16px auto;
    background: #fff;
    padding: 16px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, .12);
    text-align: center;
  }
  .ok { color: #2e7d32; font-weight: 700; margin: 0; }
  .err { color: #d32f2f; font-weight: 700; margin: 0; }
  button {
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    color: #fff;
    cursor: pointer;
    margin: 6px;
    font-size: 15px;
  }
  .violet { background: #8e24aa; }
  .violet:hover { background: #6a1b9a; }
  .green { background: #2e7d32; }
  .green:hover { background: #1b5e20; }
  #counter { font-weight: 700; color: #0d47a1; }
  #details {
    margin-top: 10px;
    text-align: left;
    font-size: 15px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
  }
  #newScanBtn { display: none; margin-top: 10px; }
  #resetScanBtn { background: #f57c00; }
  #resetScanBtn:hover { background: #e65100; }

  table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 8px; }
  th, td { border: 1px solid #ccc; padding: 6px; }
  th { background: #e3f2fd; }

  /* --- Am√©lioration mobile --- */
  @media (max-width: 600px) {
    body { padding: 8px; }
    .panel { padding: 10px; }
    table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
      font-size: 13px;
    }
    button { font-size: 14px; padding: 8px 10px; }
    #details { font-size: 14px; }
  }
</style>
</head>

<body>
  <h1>üé≠ Th√©√¢tre Saint Martin ‚Äî Scanner</h1>
  <p>Alignez le QR dans le carr√© pour valider un billet.</p>

  <div id="reader"></div>

  <div class="panel">
    <p id="status">Pr√™t √† scanner.</p>
    <p id="counter">Billets scann√©s : 0</p>
    <div id="details" style="display:none;"></div>

    <button id="newScanBtn" class="green">üé¨ Nouveau scan</button>
    <button id="resetScanBtn" class="violet">‚ôªÔ∏è R√©initialiser</button>
  </div>

  <!-- === Tableau visible sur toutes tailles d‚Äô√©cran === -->
  <div class="panel">
    <h2>üìã Historique des billets scann√©s</h2>
    <div style="overflow-x:auto;">
      <table id="scanTable">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Si√®ges</th>
            <th>Date</th>
            <th>üóëÔ∏è</th>
          </tr>
        </thead>
        <tbody id="scanTableBody">
          <tr><td colspan="4" style="padding:10px;color:#777;">Aucun billet scann√©</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
let scanner;
let scanning = false;
let lastScanText = "";
let lastScanTime = 0;

const statusEl = document.getElementById("status");
const counterEl = document.getElementById("counter");
const detailsEl = document.getElementById("details");
const newScanBtn = document.getElementById("newScanBtn");
const scanTableBody = document.getElementById("scanTableBody");

// --- Fonction s√©curis√©e localStorage (iOS friendly) ---
function safeStorageGet(key){
  try { return JSON.parse(localStorage.getItem(key) || "[]"); }
  catch(e){ return []; }
}
function safeStorageSet(key, val){
  try { localStorage.setItem(key, JSON.stringify(val)); }
  catch(e){ console.warn("Stockage d√©sactiv√© sur cet appareil."); }
}

// === Compteur ===
function updateCounter(){
  const scanned = safeStorageGet("scannedTickets");
  counterEl.textContent = "Billets scann√©s : " + scanned.length;
}

// === Scanner ===
async function startScanner(){
  if (scanning) return;
  scanning = true;
  scanner = new Html5Qrcode("reader");

  const config = {
    fps: 10,
    qrbox: (vw, vh) => {
      const minEdge = Math.min(vw, vh);
      const size = Math.floor(minEdge * 0.8);
      return { width: size, height: size };
    }
  };

  try {
    await scanner.start({ facingMode: { ideal: "environment" } }, config, onScanSuccess);
    updateCounter();
    newScanBtn.style.display = "none";
  } catch (err) {
    statusEl.innerHTML = "<span class='err'>Impossible d'acc√©der √† la cam√©ra : "+err+"</span>";
  }
}

async function stopScanner(){
  if (!scanner) return;
  try { await scanner.stop(); scanning = false; } catch(e){ console.error(e); }
}

function safeDecode(str){
  try { if (/%[0-9A-Fa-f]{2}/.test(str)) return decodeURIComponent(str); } catch(e){}
  return str;
}

// === Quand un QR est scann√© ===
async function onScanSuccess(text){
  const now = Date.now();
  if (text === lastScanText && now - lastScanTime < 3000) return;
  lastScanText = text; lastScanTime = now;

  await stopScanner();

  const scanned = safeStorageGet("scannedTickets");
  const decoded = safeDecode(text);
  let data = null;
  try { data = JSON.parse(decoded); } catch(e){ data = null; }

  const nom = data?.nom || "(inconnu)";
  const sieges = data?.sieges || "(non pr√©cis√©)";
  const date = new Date().toLocaleString("fr-FR");
  const already = scanned.some(item => item.raw === text);

  if (already) {
    statusEl.innerHTML = "<span class='err'>‚ö†Ô∏è Billet d√©j√† valid√©</span>";
    flash("red");
  } else {
    scanned.push({ raw: text, nom, sieges, date });
    safeStorageSet("scannedTickets", scanned);
    updateCounter();
    statusEl.innerHTML = "<span class='ok'>‚úÖ Billet lu avec succ√®s</span>";
    flash("lime");
  }

  detailsEl.style.display = "block";
  detailsEl.innerHTML = `
    <strong>Nom :</strong> ${nom}<br>
    <strong>Si√®ges :</strong> ${sieges}<br>
    <strong>Date :</strong> ${date}
  `;

  setTimeout(() => {
    newScanBtn.style.display = "inline-block";
    statusEl.textContent = "Pr√™t pour un nouveau scan.";
  }, 5000);

  loadDashboard();
}

// === Effet flash ===
function flash(color){
  const overlay = document.createElement("div");
  Object.assign(overlay.style, {
    position:"fixed", inset:"0", background:color, opacity:"0.25", zIndex:"99",
  });
  document.body.append(overlay);
  setTimeout(()=>overlay.remove(),150);
}

// === Nouveau scan ===
newScanBtn.onclick = () => {
  detailsEl.style.display = "none";
  statusEl.textContent = "Pr√™t √† scanner.";
  newScanBtn.style.display = "none";
  startScanner();
};

// === R√©initialiser ===
document.getElementById("resetScanBtn").onclick = () => {
  const pwd = prompt("üîê Entrez le mot de passe administrateur pour r√©initialiser :");
  if (pwd === "admin123") {
    if (confirm("Voulez-vous vraiment effacer tous les billets scann√©s ?")) {
      localStorage.removeItem("scannedTickets");
      updateCounter();
      detailsEl.style.display = "none";
      statusEl.innerHTML = "<span class='ok'>‚úÖ Liste des scans r√©initialis√©e.</span>";
      newScanBtn.style.display = "none";
      flash("lime");
      loadDashboard();
    }
  } else if (pwd !== null) {
    alert("‚ùå Mot de passe incorrect.");
    flash("red");
  }
};

// === Tableau dynamique ===
function loadDashboard(){
  const scanned = safeStorageGet("scannedTickets");
  scanTableBody.innerHTML = "";

  if (!Array.isArray(scanned) || scanned.length === 0) {
    scanTableBody.innerHTML = "<tr><td colspan='4' style='padding:10px;color:#777;'>Aucun billet scann√©</td></tr>";
    return;
  }

  const sorted = [...scanned].sort((a,b)=> new Date(b.date) - new Date(a.date));
  sorted.forEach((item, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.nom}</td>
      <td>${item.sieges}</td>
      <td>${item.date}</td>
      <td style="text-align:center;">
        <button class="violet" style="padding:4px 8px;font-size:12px;" onclick="deleteScan(${index})">‚úñ</button>
      </td>
    `;
    scanTableBody.appendChild(tr);
  });
}

function deleteScan(index){
  const scanned = safeStorageGet("scannedTickets");
  scanned.splice(index,1);
  safeStorageSet("scannedTickets", scanned);
  updateCounter();
  loadDashboard();
}

window.addEventListener("load", () => {
  startScanner();
  loadDashboard();
});
</script>
</body>
</html>

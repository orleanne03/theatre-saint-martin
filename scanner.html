<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸŸï¸ Scanner â€” ThÃ©Ã¢tre Saint Martin</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:system-ui;margin:0;padding:16px;text-align:center;background:linear-gradient(180deg,#f9f9f9,#e3f2fd)}
h1{color:#0d47a1}
#reader{width:320px;margin:12px auto;border-radius:10px;overflow:hidden}
.panel{max-width:500px;margin:16px auto;background:#fff;padding:16px;border-radius:10px}
.ok{color:#2e7d32;font-weight:700}
.err{color:#d32f2f;font-weight:700}
button{padding:10px 14px;border-radius:8px;border:none;color:#fff;cursor:pointer;margin:6px}
.violet{background:#8e24aa}
.green{background:#2e7d32}
#counter{font-weight:700;color:#0d47a1}
#details{margin-top:10px;text-align:left;background:#f9f9f9;padding:10px;border-radius:8px;border:1px solid #ddd}
.accordion{background:#1976d2;color:white;padding:10px;border-radius:8px;width:100%}
.panel-acc{display:none;background:#fff;border-radius:0 0 10px 10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd}
.trash{cursor:pointer;color:#d32f2f;font-weight:bold}
</style>
</head>

<body>

<h1>ğŸ­ ThÃ©Ã¢tre Saint Martin â€” Scanner</h1>
<p>Alignez le QR dans le carrÃ© pour valider un billet.</p>

<div id="reader"></div>

<div class="panel">
  <p id="status">PrÃªt Ã  scanner.</p>
  <p id="counter">Billets scannÃ©s : 0</p>
  <div id="details" style="display:none;"></div>

  <button id="resetScanBtn" class="violet">â™»ï¸ RÃ©initialiser</button>
  <button id="gotoHome" class="violet">ğŸ  Tableau de bord</button>
</div>

<button class="accordion">ğŸ“œ Historique des scans</button>
<div class="panel-acc" id="historyPanel">
  <table>
    <thead>
      <tr><th>Nom</th><th>SiÃ¨ges</th><th>Date</th><th></th></tr>
    </thead>
    <tbody id="historyTable"></tbody>
  </table>
</div>

<script type="module">
/* ğŸ”¥ CONFIG FIREBASE â€” REMPLACE ICI */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, runTransaction, get, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBzHCn3c-7oz9XyEqhQilz3bGbVJErMULw",
  authDomain: "theatre-saint-martin.firebaseapp.com",
  databaseURL: "https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "theatre-saint-martin",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* === LOGIQUE SCANNER === */
let scanner;
let scanning = false;

const statusEl = document.getElementById("status");
const counterEl = document.getElementById("counter");
const detailsEl = document.getElementById("details");

function getScanned(){ return JSON.parse(localStorage.getItem("scannedTickets") || "[]"); }
function setScanned(v){ localStorage.setItem("scannedTickets", JSON.stringify(v)); }

function updateCounter(){
  const list = getScanned();
  counterEl.textContent = "Billets scannÃ©s : " + list.length;
}


function renderHistory(){
  const list = getScanned();
  const tbody = document.getElementById("historyTable");
  tbody.innerHTML = "";

  const grouped = {};
  list.forEach(item => {
    if (!grouped[item.ticketId]) {
      grouped[item.ticketId] = { nom: item.nom, sieges: item.sieges, count: 0, lastDate: item.date };
    }
    grouped[item.ticketId].count++;
    grouped[item.ticketId].lastDate = item.date;
  });

  Object.entries(grouped).forEach(([ticketId, item]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.nom}</td>
      <td>${item.sieges}</td>
      <td>${item.lastDate}</td>
      <td>
        <strong>${item.count}</strong>
        <span class="trash" style="margin-left:8px;">ğŸ—‘ï¸</span>
      </td>
    `;
    tbody.appendChild(tr);

    // ğŸ—‘ï¸ supprime 1 scan (dÃ©crÃ©mente)
    tr.querySelector(".trash").onclick = async () => {
      // 1) local : enlÃ¨ve le dernier scan de CE ticket
      const local = getScanned();
      const idx = local.map(s => s.ticketId).lastIndexOf(ticketId);
      if (idx !== -1) {
        local.splice(idx, 1);
        setScanned(local);
      }

      // 2) firebase : dÃ©crÃ©mente count (et supprime le node si count=0)
      const ticketRef = ref(db, "scans/" + ticketId);
      await runTransaction(ticketRef, (current) => {
        if (!current) return null;
        const c = Number(current.count || 0);
        if (c <= 1) return null;  // supprime le billet si plus aucun scan
        current.count = c - 1;
        current.lastScan = Date.now();
        return current;
      });

      renderHistory();
      updateCounter();
    };
  });
}


async function startScanner(){
  if (scanning) return;
  scanning = true;
  scanner = new Html5Qrcode("reader");
  await scanner.start({facingMode:"environment"},{fps:10,qrbox:250},onScanSuccess);
}

async function stopScanner(){
  if(scanner){ await scanner.stop(); scanning=false; }
}

async function onScanSuccess(text){
  await stopScanner();

  let data=null;
  try{ data=JSON.parse(text); }catch(e){}

  const ticketId = data?.sieges?.replace(/\s+/g,"") || text;
  const sieges = data?.sieges || "";
  const maxScans = sieges.split(",").filter(Boolean).length || 1;

  const ticketRef = ref(db,"scans/"+ticketId);

  runTransaction(ticketRef,(current)=>{
    if(!current){
return {
  count: 1,
  nom: data?.nom || "Participant",
  sieges,
  lastScan: Date.now()
};

    }
    if(current.count>=maxScans) return;
    if(data?.nom && current.nom==="Participant") current.nom=data.nom;
current.count++;
current.lastScan = Date.now();
return current;

  }).then(res=>{

if (!res.committed) {
  statusEl.innerHTML="<span class='err'>â›” Billet dÃ©jÃ  utilisÃ©</span>";
  startScanner();
  return;
}



    const v = res.snapshot.val();

    // âœ… HISTORIQUE LOCAL (UI COMME AVANT)
    const list = getScanned();
    list.push({
      ticketId,
      nom: v.nom,
      sieges: v.sieges,
      date: new Date().toLocaleString()
    });
    setScanned(list);
    renderHistory();
    updateCounter();

    statusEl.innerHTML = `<span class='ok'>âœ… Scan ${v.count}/${maxScans}</span>`;
    detailsEl.style.display="block";
    detailsEl.innerHTML = `
      <strong>RÃ©servation au nom de :</strong><br>
      <b>${v.nom}</b><hr>
      <strong>ğŸŸï¸ SiÃ¨ges :</strong> ${v.sieges}
    `;

    setTimeout(startScanner,1200);
  });
}

document.querySelector(".accordion").onclick=()=>{
  const p=document.getElementById("historyPanel");
  p.style.display=p.style.display==="block"?"none":"block";
};



document.getElementById("resetScanBtn").onclick = async () => {
  const pwd = prompt("ğŸ” Entrez le mot de passe administrateur pour rÃ©initialiser :");
  if (pwd !== "admin123") return alert("âŒ Mot de passe incorrect.");

  if (!confirm("Tout effacer (Firebase + historique local) ?")) return;

  await set(ref(db, "scans"), null);              // âœ… vide Firebase
  localStorage.removeItem("scannedTickets");      // âœ… vide local

  renderHistory();
  updateCounter();
};



async function syncFromFirebase() {
  const snap = await get(ref(db, "scans"));
  if (!snap.exists()) {
    localStorage.removeItem("scannedTickets");
    return;
  }

  const data = snap.val();
  const list = [];

  Object.entries(data).forEach(([ticketId, v]) => {
    const count = Number(v.count || 0);
    for (let i = 0; i < count; i++) {
      list.push({
        ticketId,
        nom: v.nom || "Participant",
        sieges: v.sieges || "",
        date: new Date(v.lastScan || Date.now()).toLocaleString()
      });
    }
  });

  setScanned(list);
}


window.onload = async () => {
  await syncFromFirebase(); // ğŸ”¥ rÃ©cupÃ¨re Firebase
  renderHistory();         // affiche la liste
  updateCounter();         // met le bon nombre
  startScanner();          // dÃ©marre la camÃ©ra
};

</script>
</body>
</html>

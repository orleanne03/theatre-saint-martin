<!-- === Tableau de bord en accord√©on === -->
<div class="panel">
  <button id="toggleDashboard" class="violet" style="width:100%;text-align:left;font-size:16px;">
    üìã Historique des billets scann√©s ‚ñº
  </button>

  <div id="dashboardPanel" style="display:none;margin-top:10px;">
    <table id="scanTable" style="width:100%;border-collapse:collapse;font-size:14px;">
      <thead>
        <tr style="background:#e3f2fd;">
          <th style="padding:8px;border:1px solid #ccc;">Nom</th>
          <th style="padding:8px;border:1px solid #ccc;">Si√®ges</th>
          <th style="padding:8px;border:1px solid #ccc;">Date</th>
          <th style="padding:8px;border:1px solid #ccc;">üóëÔ∏è</th>
        </tr>
      </thead>
      <tbody id="scanTableBody"></tbody>
    </table>
  </div>
</div>

<script>
// === ACCORD√âON TABLEAU DE BORD ===
const dashboardPanel = document.getElementById("dashboardPanel");
const scanTableBody = document.getElementById("scanTableBody");
const toggleDashboard = document.getElementById("toggleDashboard");

toggleDashboard.onclick = () => {
  const open = dashboardPanel.style.display === "block";
  dashboardPanel.style.display = open ? "none" : "block";
  toggleDashboard.textContent = open 
    ? "üìã Historique des billets scann√©s ‚ñº" 
    : "üìã Historique des billets scann√©s ‚ñ≤";
};

function loadDashboard(){
  const scanned = JSON.parse(localStorage.getItem("scannedTickets") || "[]");
  scanTableBody.innerHTML = "";

  if (scanned.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" style="padding:10px;text-align:center;color:#999;">Aucun billet scann√©</td>`;
    scanTableBody.appendChild(tr);
    return;
  }

  scanned.forEach((raw, index) => {
    let data, decoded;
    try { decoded = safeDecode(raw); data = JSON.parse(decoded); } catch(e){ data = {}; }
    const dateStr = new Date().toLocaleString("fr-FR");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="border:1px solid #ccc;padding:6px;">${data.nom || "(inconnu)"}</td>
      <td style="border:1px solid #ccc;padding:6px;">${data.sieges || "-"}</td>
      <td style="border:1px solid #ccc;padding:6px;">${dateStr}</td>
      <td style="border:1px solid #ccc;padding:6px;text-align:center;">
        <button class="violet" style="padding:4px 8px;font-size:12px;" onclick="deleteScan(${index})">‚úñ</button>
      </td>
    `;
    scanTableBody.appendChild(tr);
  });
}

function deleteScan(index){
  if (!confirm("Supprimer ce scan ?")) return;
  const scanned = JSON.parse(localStorage.getItem("scannedTickets") || "[]");
  scanned.splice(index,1);
  localStorage.setItem("scannedTickets", JSON.stringify(scanned));
  updateCounter();
  loadDashboard();
}

// recharge le tableau apr√®s chaque scan
const originalOnScanSuccess = onScanSuccess;
onScanSuccess = async function(text) {
  await originalOnScanSuccess(text);
  loadDashboard();
};

// affiche le tableau au chargement
window.addEventListener("load", loadDashboard);
</script>

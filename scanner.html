<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üéüÔ∏è Contr√¥le des billets ‚Äî Th√©√¢tre Saint Martin</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(180deg, #f9f9f9, #e3f2fd);
  color: #212121;
  text-align: center;
  margin: 0;
  padding: 20px;
  transition: background-color 0.6s ease;
}
h1 { color: #0d47a1; margin: 6px 0; }
#reader {
  width: 320px;
  margin: 12px auto;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
}
#result {
  max-width: 720px;
  margin: 18px auto;
  background: #fff;
  padding: 14px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,.12);
  text-align: left;
}
.valid { color: #2e7d32; font-weight: 700; }
.error { color: #d32f2f; font-weight: 700; }
.controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 14px;
}
button {
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: #fff;
}
.btn-reset { background: #d32f2f; }
.btn-home { background: #8e24aa; }
small { display: block; margin-top: 8px; color: #666; }
#counter {
  margin-top: 10px;
  font-weight: bold;
  color: #0d47a1;
}
@media(max-width:420px){#reader{width:260px}}
</style>
</head>
<body>
<h1>üé≠ Th√©√¢tre Saint Martin ‚Äî Contr√¥le des billets</h1>
<p>Alignez le QR code dans le carr√© pour v√©rifier la validit√© du billet.</p>

<div id="reader"></div>

<div id="result">
  <p>Scannez un QR code pour v√©rifier le billet.</p>
</div>

<div id="counter">Billets scann√©s : 0</div>

<div class="controls">
  <button id="clearScans" class="btn-reset">‚ôªÔ∏è R√©initialiser les scans</button>
  <button id="gotoHome" class="btn-home">üè† Retour √† l'accueil</button>
</div>
<small>Chaque appareil garde sa propre liste de billets valid√©s.</small>

<script>
let scanner;
let lastScanText = "";
let lastScanTime = 0;
const beepOk = new Audio("data:audio/wav;base64,UklGRkQAAABXQVZFZm10IBAAAAABAAEAIlYAAB9AAACABAAZGF0YQAAAAA=");
const beepErr = new Audio("data:audio/wav;base64,UklGRpAAAABXQVZFZm10IBAAAAABAAEAIlYAAB9AAACABAAZGF0YQAAAAA=");

function updateCounter() {
  const scanned = JSON.parse(localStorage.getItem("scannedTickets") || "[]");
  document.getElementById("counter").textContent =
    "Billets scann√©s : " + scanned.length;
}

function startScanner() {
  try {
    scanner = new Html5Qrcode("reader");

    const config = {
      fps: 10,
      qrbox: (viewfinderWidth, viewfinderHeight) => {
        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
        const boxSize = Math.floor(minEdge * 0.8);
        return { width: boxSize, height: boxSize };
      }
    };

    scanner.start(
      { facingMode: "environment" },
      config,
      onScanSuccess,
      onScanError
    )
    .then(() => console.log("‚úÖ Cam√©ra d√©marr√©e"))
    .catch(err => {
      document.getElementById("result").innerHTML =
        '<p class="error">Impossible d\'acc√©der √† la cam√©ra : ' + err + '</p>';
      console.error("Erreur cam√©ra :", err);
    });

  } catch (error) {
    console.error("Erreur au d√©marrage du scanner :", error);
  }

  updateCounter();
}

function flash(color) {
  document.body.style.backgroundColor = color;
  setTimeout(() => (document.body.style.backgroundColor = ""), 500);
}

function onScanSuccess(decodedText) {
  const now = Date.now();
  if (decodedText === lastScanText && now - lastScanTime < 3000) return;
  lastScanText = decodedText;
  lastScanTime = now;

  const out = document.getElementById("result");
  try {
    // ‚úÖ d√©codage correct du texte encod√©
    const decoded = decodeURIComponent(decodedText);
    const data = JSON.parse(decoded);
    const scanned = JSON.parse(localStorage.getItem("scannedTickets") || "[]");

    if (scanned.includes(decodedText)) {
      out.innerHTML = `
        <p class="error">‚ö†Ô∏è Billet d√©j√† valid√© !</p>
        <p><b>Nom :</b> ${data.nom || "‚Äî"}</p>
        <p><b>Email :</b> ${data.email || "‚Äî"}</p>
        <p><b>Si√®ges :</b> ${data.sieges || "‚Äî"}</p>
        <p><b>Date :</b> ${data.date_reservation || "‚Äî"}</p>`;
      flash("#ffebee");
      beepErr.play();
      return;
    }

    scanned.push(decodedText);
    localStorage.setItem("scannedTickets", JSON.stringify(scanned));
    updateCounter();

    out.innerHTML = `
      <p class="valid">‚úÖ Billet valide</p>
      <p><b>Nom :</b> ${data.nom || "‚Äî"}</p>
      <p><b>Email :</b> ${data.email || "‚Äî"}</p>
      <p><b>T√©l√©phone :</b> ${data.tel || "‚Äî"}</p>
      <p><b>Si√®ges :</b> ${data.sieges || "‚Äî"}</p>
      <p><b>Date :</b> ${data.date_reservation || "‚Äî"}</p>`;
    flash("#e8f5e9");
    beepOk.play();
  } catch (err) {
    console.error("Erreur d√©codage QR :", err, decodedText);
    out.innerHTML = '<p class="error">‚ùå QR Code invalide (format non reconnu)</p>';
    flash("#ffebee");
    beepErr.play();
  }
}

function onScanError(error) {
  // Ignore les erreurs mineures
}

document.getElementById("clearScans").onclick = () => {
  if (!confirm("Effacer la liste des billets scann√©s sur cet appareil ?")) return;
  localStorage.removeItem("scannedTickets");
  document.getElementById("result").innerHTML =
    "<p>Liste des scans effac√©e. Pr√™t √† scanner.</p>";
  updateCounter();
};

document.getElementById("gotoHome").onclick = () => {
  window.location.href = "index.html";
};

window.addEventListener("load", startScanner);
</script>
</body>
</html>

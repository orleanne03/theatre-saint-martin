<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>🎟️ Contrôle des billets – Théâtre Saint Martin</title>

<!-- Librairie pour scanner les QR codes -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(180deg, #f9f9f9, #e3f2fd);
  margin: 0;
  text-align: center;
  color: #212121;
}
h1 {
  color: #0d47a1;
  margin: 20px 0;
}
#reader {
  width: 300px;
  margin: 20px auto;
}
#result {
  margin-top: 20px;
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  width: 90%;
  max-width: 400px;
}
.valid { color: #2e7d32; font-weight: bold; }
.error { color: #d32f2f; font-weight: bold; }
button {
  margin-top: 15px;
  padding: 10px 15px;
  border: none;
  border-radius: 6px;
  background: #1976d2;
  color: #fff;
  cursor: pointer;
  font-size: 15px;
}
button:hover { background: #0d47a1; }
</style>
</head>
<body>

<h1>🎭 Théâtre Saint Martin</h1>
<h3>Scanner le billet à l’entrée</h3>

<div id="reader"></div>
<div id="result">Scannez un QR code pour vérifier le billet.</div>

<button onclick="window.location.href='index.html'">← Retour à l'accueil</button>

<script>
let scanner;
let lastScanText = "";
let lastScanTime = 0;

function startScanner() {
  scanner = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };
  scanner.start(
    { facingMode: "environment" },
    config,
    onScanSuccess,
    onScanError
  ).catch(err => {
    document.getElementById("result").innerHTML =
      '<p class="error">Impossible d\'accéder à la caméra : ' + err + '</p>';
  });
}

function onScanSuccess(decodedText) {
  const now = Date.now();
  // Empêche plusieurs déclenchements du même QR en 3 secondes
  if (decodedText === lastScanText && now - lastScanTime < 5000) {
    return;
  }
  lastScanText = decodedText;
  lastScanTime = now;

  const out = document.getElementById("result");
  try {
    const data = JSON.parse(decodedText);
    const scanned = JSON.parse(localStorage.getItem("scannedTickets") || "[]");

    if (scanned.includes(decodedText)) {
      out.innerHTML = `
        <p class="error">⚠️ Billet déjà validé !</p>
        <p><b>Nom :</b> ${data.nom || "—"}</p>
        <p><b>Email :</b> ${data.email || "—"}</p>
        <p><b>Sièges :</b> ${data.sieges || "—"}</p>
        <p><b>Date :</b> ${data.date_reservation || "—"}</p>
      `;
      return;
    }

    scanned.push(decodedText);
    localStorage.setItem("scannedTickets", JSON.stringify(scanned));

    out.innerHTML = `
      <p class="valid">✅ Billet valide</p>
      <p><b>Nom :</b> ${data.nom || "—"}</p>
      <p><b>Email :</b> ${data.email || "—"}</p>
      <p><b>Téléphone :</b> ${data.tel || "—"}</p>
      <p><b>Sièges :</b> ${data.sieges || "—"}</p>
      <p><b>Date :</b> ${data.date_reservation || "—"}</p>
    `;
  } catch (err) {
    out.innerHTML = '<p class="error">❌ QR Code invalide</p>';
  }
}

function onScanError(error) {
  // on ignore les erreurs silencieuses
}

document.getElementById("clearScans").onclick = () => {
  if (!confirm("Effacer la liste des billets scannés sur cet appareil ?")) return;
  localStorage.removeItem("scannedTickets");
  document.getElementById("result").innerHTML =
    "<p>Liste des scans effacée. Prêt à scanner.</p>";
};

document.getElementById("gotoHome").onclick = () => {
  window.location.href = "index.html";
};

window.addEventListener("load", startScanner);
</script>


</body>
</html>

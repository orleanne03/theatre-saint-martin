<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ­ Salle de Bessay â€“ RÃ©servations</title>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body {
  font-family:"Segoe UI",sans-serif;
  background:#fff8e1; color:#212121;
  margin:0; padding:20px; text-align:center;
  transition:background .3s ease;
}
body.admin-mode { background:#ffe4ec; }

h1 { color:#d32f2f; margin-bottom:5px; }
h2 { color:#424242; font-weight:600; font-style:italic; margin-bottom:20px; }

form {
  background:#fff; max-width:400px; margin:0 auto; padding:20px;
  border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,.15);
  text-align:left;
}
form input, form button {
  width:95%; margin:8px auto; padding:10px; border:1px solid #ccc;
  border-radius:8px; font-size:15px; display:block;
}
form button {
  background:#d32f2f; color:#fff; border:none; font-weight:bold;
  cursor:pointer; transition:0.3s;
}
form button:hover { background:#b71c1c; }
#totalPrice { font-weight:bold; color:#388e3c; margin-top:10px; text-align:center; }

#list { margin-top:30px; max-width:700px; margin-left:auto; margin-right:auto; }

.accordion-card {
  background:#fff;
  border-radius:10px;
  margin:12px auto;
  padding:12px 15px;
  max-width:600px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  transition:background 0.3s ease, border-color .3s ease;
}
.accordion-card.present-card {
  background-color:#e8f5e9 !important;
  border:2px solid #2e7d32 !important;
}
.accordion-header {
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #f0f0f0;
  padding-bottom:6px;
  cursor:pointer;
}
.accordion-body {
  display:none;
  margin-top:10px;
  text-align:left;
  font-size:0.95rem;
}
.accordion-body.open { display:block; }
.paid { color:#2e7d32; font-weight:600; }
.unpaid { color:#e91e63; font-weight:600; }

.delete-btn, .action-btn {
  width:90%;
  display:block;
  margin:8px auto;
  border:none;
  border-radius:8px;
  color:white;
  padding:10px;
  font-weight:bold;
  cursor:pointer;
}
.action-btn { background:#2e7d32; }
.action-btn:hover { background:#1b5e20; }
.delete-btn { background:#e53935; }
.delete-btn:hover { background:#b71c1c; }

.admin-btn {
  background:#1565c0;
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 16px;
  font-weight:600;
  margin:10px 5px;
  cursor:pointer;
}
.admin-btn:hover { background:#0d47a1; }

#emailModal {
  position:fixed; inset:0; display:none; justify-content:center; align-items:center;
  background:rgba(0,0,0,0.5); backdrop-filter:blur(6px);
  z-index:1000; transition:opacity 0.3s ease;
}
#emailModal.show { display:flex!important; }
#emailModalContent {
  background:#fff; border-radius:10px; padding:25px 30px; max-width:600px; width:90%;
  text-align:left; box-shadow:0 5px 12px rgba(0,0,0,0.3);
}
#emailPreview { font-size:0.95rem; line-height:1.5; }

#testNotice, #adminNotice {
  position:fixed; top:15px; font-weight:600; padding:10px 18px;
  border-radius:30px; box-shadow:0 3px 8px rgba(0,0,0,0.25); color:white; display:none;
}
#testNotice { left:15px; background:#2196f3; }
#adminNotice { right:15px; background:#d81b60; }
</style>
</head>

<body>

<h1>ğŸŸï¸ Salle de Bessay â€“ RÃ©servations</h1>
<h2>ğŸ­ Spectacle du 23 janvier 2026</h2>

<form id="resForm">
  <input id="name" placeholder="Nom et PrÃ©nom" required>
  <input id="email" placeholder="Email" type="email" required>
  <input id="phone" placeholder="TÃ©lÃ©phone" required>
  <input id="adult" type="number" min="0" placeholder="Adulte(s)">
  <input id="child" type="number" min="0" placeholder="Enfant(s) -12 ans">
  <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <input type="checkbox" id="paid" style="width:auto;">
    <span>Paiement reÃ§u ğŸ’¶</span>
  </label>
  <p id="totalPrice">Total : 0 â‚¬</p>
  <button type="submit">âœ… Confirmer la rÃ©servation</button>
</form>

<div id="list"></div>

<div style="margin-top:25px;">
  <button class="admin-btn" id="adminToggle">ğŸ” Mode Admin</button>
  <div style="text-align:center; margin-top:15px;">
    <a href="accueil.html"
       style="display:inline-block; background-color:#6d4c41; color:#fff; text-decoration:none;
              padding:8px 16px; border-radius:8px; font-weight:600; font-size:0.9rem;">
      ğŸ  Accueil
    </a>
  </div>
  <button class="admin-btn" id="priceBtn" style="display:none;">ğŸ’µ Modifier les tarifs</button>
  <button class="admin-btn" id="testEmailBtn" style="display:none;">âœ‰ï¸ Mode Email : TEST</button>
  <button class="admin-btn" id="exportBtn" style="display:none;">ğŸ’¾ Enregistrer les rÃ©servations</button>
</div>

<div id="testNotice">âœ‰ï¸ Mode TEST activÃ©</div>
<div id="adminNotice">ğŸ‘‘ Vous Ãªtes en mode administrateur</div>

<!-- Modale dâ€™aperÃ§u email -->
<div id="emailModal">
  <div id="emailModalContent">
    <h3 style="text-align:center;">ğŸ“§ AperÃ§u de lâ€™e-mail</h3>
    <div id="emailPreview"></div>
    <button id="closeModalBtn" style="display:block;margin:20px auto 0;background:#d32f2f;color:white;border:none;border-radius:8px;padding:10px 20px;font-weight:600;cursor:pointer;">Fermer</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* EmailJS */
emailjs.init("E4g_UFzGYQZBNH07m");

/* Firebase */
const app = initializeApp({
  apiKey:"AIzaSyXXXX_TON_API_KEY",
  authDomain:"theatre-saint-martin.firebaseapp.com",
  databaseURL:"https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"theatre-saint-martin",
  storageBucket:"theatre-saint-martin.appspot.com",
  messagingSenderId:"1234567890",
  appId:"1:1234567890:web:abcd1234efgh"
});
const db = getDatabase(app);
const refSpectacle = ref(db, "spectacles/salle_bessay");

/* Ã‰tat */
let reservations = {};
let adminMode = false;
let emailTestMode = false;
let priceAdult = 22, priceChild = 15;

/* DOM refs */
const list = document.getElementById("list");
const adminToggleBtn = document.getElementById("adminToggle");
const priceBtn = document.getElementById("priceBtn");
const testEmailBtn = document.getElementById("testEmailBtn");
const exportBtn = document.getElementById("exportBtn");
const testNotice = document.getElementById("testNotice");
const adminNotice = document.getElementById("adminNotice");
const resForm = document.getElementById("resForm");
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const phoneInput = document.getElementById("phone");
const aI = document.getElementById("adult");
const cI = document.getElementById("child");
const totalEl = document.getElementById("totalPrice");
const closeModalBtn = document.getElementById("closeModalBtn");

/* Formatage entrÃ©es */
nameInput.addEventListener("input",()=>nameInput.value=nameInput.value.toUpperCase());
emailInput.addEventListener("input",()=>emailInput.value=emailInput.value.toLowerCase());
phoneInput.addEventListener("input",()=>{
  let d=phoneInput.value.replace(/\D/g,'');
  if(d.startsWith("33"))d="0"+d.slice(2);
  if(d.startsWith("0033"))d="0"+d.slice(4);
  phoneInput.value=d.slice(0,10).replace(/(\d{2})(?=\d)/g,'$1 ').trim();
});

/* Total */
function updateTotal(){
  const a=+aI.value||0, c=+cI.value||0;
  totalEl.textContent = `Total : ${(a*priceAdult + c*priceChild).toFixed(2)} â‚¬`;
}
aI.addEventListener("input",updateTotal);
cI.addEventListener("input",updateTotal);
updateTotal();

/* Live data */
onValue(refSpectacle, snap => {
  reservations = snap.val() || {};
  renderList();
});

/* Email HTML (avec bouton Imprimer) */
function buildEmailHTML(data){
  return `
  <div style="font-family:'Segoe UI',Arial,sans-serif; background-color:#f9f9f9; padding:20px;">
    <div style="max-width:600px; margin:0 auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); overflow:hidden;">
      <div style="background-color:#d32f2f; color:white; text-align:center; padding:18px;">
        <h2 style="margin:0;">ğŸ­ ThÃ©Ã¢tre Saint-Martin</h2>
        <p style="margin:0; font-size:14px;">Salle de Bessay â€“ Spectacle du 23 janvier 2026</p>
      </div>
      <div style="padding:35px 30px 40px 30px; line-height:1.65;">

        <h3 style="color:#d32f2f; margin-top:0;">Confirmation de rÃ©servation</h3>
        <p>Bonjour <b>${data.name}</b>,</p>
        <p>Merci pour votre rÃ©servation ! Voici le rÃ©capitulatif Ã  imprimer et prÃ©senter :</p>
        <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:15px;">
          <tr><td style="padding:6px 0;">ğŸ« <b>Adultes :</b></td><td style="text-align:right;">${data.nbAdult}</td></tr>
          <tr><td style="padding:6px 0;">ğŸ‘§ <b>Enfants -12 ans :</b></td><td style="text-align:right;">${data.nbChild}</td></tr>
          <tr style="border-top:1px solid #eee;"><td style="padding:8px 0; font-weight:bold;">Total de places</td><td style="text-align:right; font-weight:bold;">${data.nbPlaces}</td></tr>
          <tr><td style="padding:8px 0; font-weight:bold; color:#388e3c;">Montant total</td><td style="text-align:right; font-weight:bold; color:#388e3c;">${data.amount.toFixed(2)} â‚¬</td></tr>
        </table>
<div style="margin-top:32px; padding:22px; background:#fff8e1; border-radius:8px;">
          <p style="margin:0; font-size:14px;">
            ğŸ“ <b>Lieu :</b> Salle de Bessay<br>
            ğŸ“… <b>Date :</b> Vendredi 23 janvier 2026 â€“ 20h30
          </p>
        </div>

        <div style="text-align:center; margin-top:20px;">
          <!-- Ce bouton lancera l'impression dans la modale / navigateur. 
               Dans un client mail, l'impression auto peut Ãªtre bloquÃ©e mais le bouton reste visible. -->
<a href="https://orleanne03.github.io/theatre-saint-martin/billet.html?id=${data.id}"
   style="background:#388e3c; color:white; text-decoration:none; padding:10px 18px; border-radius:6px; font-weight:bold; display:inline-block;">
   ğŸ–¨ï¸ Imprimer mon billet
</a>
        </div>

        <p style="font-size:14px; color:#555; margin-top:20px;">Pour toute question : 06.09.12.11.59</p>
        <p style="font-size:13px; color:#777;">Ã€ trÃ¨s bientÃ´t au thÃ©Ã¢tre ğŸ­</p>
      </div>
      <div style="background-color:#f0f0f0; text-align:center; padding:10px; font-size:12px; color:#777;">
        ThÃ©Ã¢tre Saint-Martin â€“ Salle de Bessay<br>Â© 2025 â€“ Tous droits rÃ©servÃ©s
      </div>
    </div>
  </div>`;
}

/* Envoi / aperÃ§u email */
async function sendEmail(data){
  const htmlContent = buildEmailHTML(data);
  if (emailTestMode){
    document.getElementById("emailPreview").innerHTML = htmlContent;
    document.getElementById("emailModal").classList.add("show");
    return;
  }
  await emailjs.send("service_0lqs9k7","template_w2j3pqp",{
    to_email:data.email,
    to_name:data.name,
    nbAdult:data.nbAdult,
    nbChild:data.nbChild,
    nbPlaces:data.nbPlaces,
    amount:data.amount.toFixed(2),
    html_message:htmlContent
  });
  alert("âœ‰ï¸ E-mail de confirmation envoyÃ© !");
}
closeModalBtn.addEventListener("click",()=>document.getElementById("emailModal").classList.remove("show"));

/* Formulaire */
resForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = nameInput.value.trim().toUpperCase();
  const email = emailInput.value.trim().toLowerCase();
  const phone = phoneInput.value.trim();
  const nbAdult = +aI.value||0, nbChild = +cI.value||0;
  const nbPlaces = nbAdult + nbChild;
  if (!name || !email || !phone || nbPlaces===0) return alert("âŒ Formulaire incomplet !");
  const data = {
    name, email, phone,
    nbAdult, nbChild, nbPlaces,
    amount: (nbAdult*priceAdult + nbChild*priceChild),
    paid: document.getElementById("paid").checked,
    present: false
  };
  const newRef = push(ref(db, "spectacles/salle_bessay"));
await set(newRef, { ...data, id:newRef.key });

alert("âœ… RÃ©servation enregistrÃ©e !");
sendEmail({ ...data, id:newRef.key });

resForm.reset();
updateTotal();

});

/* Rendu liste + event delegation */
function renderList(){
  const entries = Object.entries(reservations);
  if (!entries.length){
    list.innerHTML = "<p>Aucune rÃ©servation.</p>";
    return;
  }
  /* --- AJOUT : Calcul des totaux --- */
let totalAdult = 0, totalChild = 0, totalAmount = 0;
for (const r of Object.values(reservations)){
  totalAdult += Number(r.nbAdult||0);
  totalChild += Number(r.nbChild||0);
  totalAmount += Number(r.amount||0);
}

/* Affichage rÃ©sumÃ© */
let summary = `
  <div style="max-width:600px;margin:0 auto 15px auto;padding:12px;
              background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);
              font-weight:600;font-size:1rem;text-align:center;">
    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Adultes : ${totalAdult} &nbsp; | &nbsp; ğŸ‘§ Enfants : ${totalChild} <br>
    ğŸ’¶ Total encaissÃ© (si tous payÃ©s) : ${totalAmount.toFixed(2)} â‚¬
  </div>
`;

  let html = summary + "<h3>ğŸ“‹ RÃ©servations</h3>";

  for (const [id, r] of entries){
    const payClass = r.paid ? "paid" : "unpaid";
    const payTxt   = r.paid ? "âœ… PayÃ©" : "âŒ";
    const presClass= r.present ? "paid" : "unpaid";
    const presTxt  = r.present ? "ğŸŸï¸ PrÃ©sent" : "ğŸš« Absent";
    html += `
      <div class="accordion-card ${r.present ? 'present-card' : ''}" data-card="${id}">
        <div class="accordion-header" data-toggle="${id}">
          <span><b>${r.name}</b> â€“ ${r.nbPlaces} places</span>
          <span class="${payClass}">${payTxt}</span>
        </div>
        <div class="accordion-body" id="body-${id}">
          <p>ğŸ“ ${r.phone}</p>
          <p>ğŸ“§ ${r.email}</p>
          <p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ${r.nbAdult} adulte(s), ${r.nbChild} enfant(s)</p>
          <p><b>ğŸ’¶ Montant :</b> ${Number(r.amount||0).toFixed(2)} â‚¬</p>

          <p><b>ğŸŸï¸ Statut :</b> <span class="${presClass}">${presTxt}</span></p>
          ${adminMode ? `
            <button class="action-btn" data-action="toggle-paid" data-id="${id}" data-next="${!r.paid}">ğŸ’¶ Basculer paiement</button>
            <button class="action-btn" style="background:#8e24aa;" data-action="toggle-present" data-id="${id}" data-next="${!r.present}">ğŸŸï¸ Valider billet</button>
            <button class="delete-btn" data-action="delete" data-id="${id}">ğŸ—‘ Supprimer</button>
          ` : ""}
        </div>
      </div>`;
  }
  list.innerHTML = html;
}
list.addEventListener("click", async (e)=>{
  const header = e.target.closest("[data-toggle]");
  if (header){
    const id = header.getAttribute("data-toggle");
    document.getElementById(`body-${id}`).classList.toggle("open");
    return;
  }
  const btn = e.target.closest("[data-action]");
  if (!btn) return;
  const action = btn.getAttribute("data-action");
  const id = btn.getAttribute("data-id");
  if (action==="toggle-paid"){
    const next = btn.getAttribute("data-next")==="true";
    const r = reservations[id];
    await set(ref(db,`spectacles/salle_bessay/${id}`), { ...r, paid: next });
  } else if (action==="toggle-present"){
    const next = btn.getAttribute("data-next")==="true";
    const r = reservations[id];
    await set(ref(db,`spectacles/salle_bessay/${id}`), { ...r, present: next });
  } else if (action==="delete"){
    if (confirm("Supprimer ?")){
      await remove(ref(db,`spectacles/salle_bessay/${id}`));
    }
  }
});

/* Bouton Admin + boutons admin */
adminToggleBtn.addEventListener("click", ()=>{
  if (!adminMode){
    const pass = prompt("Mot de passe admin :");
    if (pass !== "admin123") { alert("Mot de passe incorrect !"); return; }
    adminMode = true;
    document.body.classList.add("admin-mode");
    adminNotice.style.display = "block";
    adminToggleBtn.textContent = "ğŸšª Sortir du mode admin";
    [priceBtn,testEmailBtn,exportBtn].forEach(b=>b.style.display="inline-block");
  } else {
    adminMode = false;
    emailTestMode = false;
    document.body.classList.remove("admin-mode");
    adminNotice.style.display = "none";
    adminToggleBtn.textContent = "ğŸ” Mode Admin";
    [priceBtn,testEmailBtn,exportBtn].forEach(b=>b.style.display="none");
    testNotice.style.display = "none";
  }
  renderList();
});

priceBtn.addEventListener("click", ()=>{
  const a = parseFloat(prompt("Tarif adulte (â‚¬)", priceAdult));
  const c = parseFloat(prompt("Tarif enfant (â‚¬)", priceChild));
  if (!isNaN(a)) priceAdult = a;
  if (!isNaN(c)) priceChild = c;
  alert(`Tarifs mis Ã  jour :\nAdulte = ${priceAdult} â‚¬\nEnfant = ${priceChild} â‚¬`);
  updateTotal();
});

testEmailBtn.addEventListener("click", ()=>{
  emailTestMode = !emailTestMode;
  testNotice.style.display = emailTestMode ? "block" : "none";
  testEmailBtn.textContent = emailTestMode ? "âœ‰ï¸ Mode Email : RÃ‰EL" : "âœ‰ï¸ Mode Email : TEST";
});

function safeCell(v){return v==null?"":String(v).replace(/\r?\n/g," ").trim();}
function exportReservationsCSV(obj){
  try{
    if(!obj||!Object.keys(obj).length){alert("Aucune rÃ©servation Ã  exporter.");return;}
    const header=["Nom","Email","TÃ©lÃ©phone","Adultes","Enfants","Total places","Montant (â‚¬)","PayÃ©","PrÃ©sent"];
    const rows=[header];
    Object.values(obj).forEach(r=>{
      const amountNum=Number(r?.amount||0);
      rows.push([safeCell(r?.name),safeCell(r?.email),safeCell(r?.phone),
        Number(r?.nbAdult||0),Number(r?.nbChild||0),Number(r?.nbPlaces||0),
        amountNum.toFixed(2),r?.paid?"Oui":"Non",r?.present?"Oui":"Non"]);
    });
    const csv="\uFEFF"+rows.map(l=>l.join(";")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const date=new Date().toISOString().split("T")[0];
    const filename=`reservations_bessay_${date}.csv`;
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download=filename;a.style.display="none";
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }catch(err){console.error("[EXPORT] Erreur:",err);alert("Erreur pendant lâ€™export CSV.");}
}
exportBtn.addEventListener("click", ()=>exportReservationsCSV(reservations));
</script>
</body>
</html>

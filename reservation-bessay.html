<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ­ Cabaret de Printemps â€“ RÃ©servations</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
body {font-family:"Segoe UI",sans-serif;background:#fff8e1;margin:0;text-align:center;color:#212121;padding:20px;}
h1{color:#d32f2f;margin-bottom:5px;display:flex;justify-content:center;align-items:center;gap:8px;}
h1::before{content:"ğŸ­";}
h2{color:#424242;font-weight:500;margin-bottom:20px;}
form{background:#fff;max-width:400px;margin:0 auto;padding:20px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.15);}
input,button{width:90%;margin:8px auto;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:15px;display:block;text-align:center;}
button{background:#d32f2f;color:white;font-weight:600;border:none;cursor:pointer;transition:0.3s;}
button:hover{background:#b71c1c;}
#remaining{font-size:1.2rem;color:#2e7d32;font-weight:700;margin-bottom:10px;}
#progressContainer{width:90%;max-width:400px;margin:10px auto 20px;background:#eee;border-radius:8px;height:20px;overflow:hidden;}
#progressBar{height:100%;width:0%;background:linear-gradient(90deg,#81c784,#388e3c);transition:width 0.5s;}
#list{margin-top:25px;max-width:700px;margin-left:auto;margin-right:auto;background:#fafafa;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:15px;text-align:left;}
.res-item{border-bottom:1px solid #eee;padding:6px 0;font-size:0.95rem;display:flex;justify-content:space-between;align-items:center;}
.paid{color:#2e7d32;font-weight:600;}
.unpaid{color:#e91e63;font-weight:600;}
.delete-btn{background:#ef5350;border:none;color:white;border-radius:6px;padding:4px 8px;cursor:pointer;}
.delete-btn:hover{background:#c62828;}
.admin-btn{background:#1565c0;margin-top:20px;}
.admin-btn:hover{background:#0d47a1;}
.export-btn{background:#00796b;margin:10px 0;}
.export-btn:hover{background:#004d40;}
.clearall-btn{background:#8e24aa;}
.clearall-btn:hover{background:#6a1b9a;}
.capacity-btn{background:#f57c00;}
.capacity-btn:hover{background:#e65100;}
#totalPrice{font-weight:bold;color:#388e3c;margin-top:10px;}
</style>
</head>
<body>
<h1>Cabaret de Printemps</h1>
<h2>RÃ©servation (<span id="capacityLabel">100</span> places maximum)</h2>
<p>Places restantes : <span id="remaining">â€”</span></p>
<div id="progressContainer"><div id="progressBar"></div></div>

<form id="resForm">
  <input id="name" placeholder="Nom complet" required>
  <input id="email" placeholder="Email" type="email" required>
  <input id="phone" placeholder="TÃ©lÃ©phone" required>
  <input id="adult" value="Adulte" type="text">
  <input id="child" value="Enfant" type="text">
  <p id="totalPrice">Total : 0 â‚¬</p>
  <label style="display:flex;align-items:center;gap:8px;justify-content:center;">
    <input type="checkbox" id="paid"> Paiement reÃ§u ğŸ’¶
  </label>
  <button type="submit">âœ… Confirmer la rÃ©servation</button>
</form>

<!-- Boutons admin -->
<button class="admin-btn" id="priceBtn" style="display:none;">ğŸ’µ Modifier les tarifs</button>
<button class="export-btn" id="exportBtn" style="display:none;">â¬‡ï¸ Export CSV</button>
<button class="clearall-btn" id="clearAllBtn" style="display:none;">ğŸ—‘ Supprimer toutes les rÃ©servations</button>
<button class="capacity-btn" id="capacityBtn" style="display:none;">ğŸ§® Modifier la capacitÃ© maximale</button>

<div id="list"></div>

<button class="admin-btn" id="adminToggle">ğŸ” Mode Admin</button>
<button class="admin-btn" onclick="window.location.href='index.html'">ğŸ  Retour</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyXXXX_TON_API_KEY",
  authDomain:"theatre-saint-martin.firebaseapp.com",
  databaseURL:"https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"theatre-saint-martin",
  storageBucket:"theatre-saint-martin.appspot.com",
  messagingSenderId:"1234567890",
  appId:"1:1234567890:web:abcd1234efgh"
});
const db=getDatabase(app);
const refSpectacle=ref(db,"spectacles/cabaret_printemps");

let maxPlaces=100;
let reservations={};
let adminMode=false;
let priceAdult=15;
let priceChild=10;

const adultInput=document.getElementById("adult");
const childInput=document.getElementById("child");
const totalPriceEl=document.getElementById("totalPrice");

function clearFieldOnFocus(input,label){
  input.addEventListener("focus",()=>{if(input.value===label)input.value="";});
  input.addEventListener("blur",()=>{if(input.value.trim()==="")input.value=label;});
}
clearFieldOnFocus(adultInput,"Adulte");
clearFieldOnFocus(childInput,"Enfant");

function updateTotal(){
  const nbA=isNaN(parseInt(adultInput.value))?0:parseInt(adultInput.value);
  const nbC=isNaN(parseInt(childInput.value))?0:parseInt(childInput.value);
  totalPriceEl.textContent=`Total : ${(nbA*priceAdult+nbC*priceChild).toFixed(2)} â‚¬`;
}
adultInput.addEventListener("input",updateTotal);
childInput.addEventListener("input",updateTotal);

onValue(refSpectacle,snap=>{
  const data=snap.val()||{};
  reservations=data.reservations||{};
  maxPlaces=data.maxPlaces||100;
  document.getElementById("capacityLabel").textContent=maxPlaces;
  updateUI();
});

function sendEmail(data){
  emailjs.init("E4g_UFzGYQZBNH07m");
  emailjs.send("service_0lqs9k7","template_hzfgnxs",{
    to_email:data.email,
    subject:"ğŸ­ RÃ©servation â€“ Cabaret de Printemps",
    message_html:`<h2>ğŸ­ Confirmation</h2><p>Bonjour ${data.name},</p>
      <p>Adultes : ${data.nbAdult}<br>Enfants : ${data.nbChild}<br>
      Total : ${data.amount.toFixed(2)} â‚¬<br>Statut : ${data.paid?"âœ… PayÃ©":"âŒ Non payÃ©"}</p>`
  });
}

// âœ… Correction ici
document.getElementById("resForm").onsubmit=async e=>{
  e.preventDefault();
  const name=document.getElementById("name").value.trim().toUpperCase();
  const email=document.getElementById("email").value.trim().toLowerCase();
  const phone=document.getElementById("phone").value.trim();
  const nbA=parseInt(adultInput.value)||0;
  const nbC=parseInt(childInput.value)||0;
  const total=nbA+nbC;
  const paid=document.getElementById("paid").checked;
  if(!name||!email||!phone||total===0)return alert("Remplissez tous les champs !");
  const totalRes=Object.values(reservations).reduce((s,r)=>s+(r.nbPlaces||0),0);
  if(totalRes+total>maxPlaces)return alert("âŒ Plus assez de places.");
  const id=Date.now();
  const amount=nbA*priceAdult+nbC*priceChild;
  const newRes={name,email,phone,nbAdult:nbA,nbChild:nbC,nbPlaces:total,amount,paid};
  // âœ… set() direct vers la rÃ©servation
  await set(ref(db, `spectacles/cabaret_printemps/reservations/${id}`), newRes);
  sendEmail(newRes);
  alert("âœ… RÃ©servation enregistrÃ©e !");
  e.target.reset();adultInput.value="Adulte";childInput.value="Enfant";updateTotal();
};

function updateUI(){
  const total=Object.values(reservations).reduce((s,r)=>s+(r.nbPlaces||0),0);
  const remaining=maxPlaces-total;
  document.getElementById("capacityLabel").textContent=maxPlaces;
  document.getElementById("remaining").textContent=remaining;
  document.getElementById("progressBar").style.width=(total/maxPlaces*100)+"%";
  renderList();
}

function renderList(){
  const container=document.getElementById("list");
  const entries=Object.entries(reservations);
  if(!entries.length){container.innerHTML="<p>Aucune rÃ©servation.</p>";return;}
  container.innerHTML="<h3>ğŸ“‹ RÃ©servations</h3>";
  entries.sort((a,b)=>b[0]-a[0]).forEach(([id,r])=>{
    container.innerHTML+=`
      <div class="res-item">
        <span><strong>${r.name}</strong> â€“ ${r.nbPlaces} places (${r.amount.toFixed(2)} â‚¬)
          â€“ <span class="${r.paid?"paid":"unpaid"}">${r.paid?"PayÃ©":"Non payÃ©"}</span></span>
        ${adminMode?`<button class="delete-btn" onclick="deleteRes('${id}')">ğŸ—‘</button>`:""}
      </div>`;
  });
}
window.deleteRes=async id=>{
  if(confirm("Supprimer cette rÃ©servation ?"))
    await remove(ref(db,`spectacles/cabaret_printemps/reservations/${id}`));
};

// --- Mode Admin ---
document.getElementById("adminToggle").onclick=()=>{
  if(!adminMode){
    const pass=prompt("Mot de passe admin :");
    if(pass!=="admin123")return alert("Mot de passe incorrect !");
    adminMode=true;
    ["exportBtn","priceBtn","clearAllBtn","capacityBtn"].forEach(id=>{
      document.getElementById(id).style.display="inline-block";
    });
  }else{
    adminMode=false;
    ["exportBtn","priceBtn","clearAllBtn","capacityBtn"].forEach(id=>{
      document.getElementById(id).style.display="none";
    });
  }
  renderList();
};

// --- Modifier tarifs ---
document.getElementById("priceBtn").onclick=()=>{
  if(!adminMode)return;
  const pA=prompt("Tarif adulte (â‚¬)",priceAdult);
  const pC=prompt("Tarif enfant (â‚¬)",priceChild);
  if(pA&&pC){priceAdult=parseFloat(pA);priceChild=parseFloat(pC);
    alert(`Tarifs mis Ã  jour : Adultes ${priceAdult} â‚¬, Enfants ${priceChild} â‚¬`);
    updateTotal();
  }
};

// --- Modifier capacitÃ© ---
document.getElementById("capacityBtn").onclick=async ()=>{
  if(!adminMode)return;
  const newCap=prompt("Nouvelle capacitÃ© maximale :",maxPlaces);
  if(newCap && !isNaN(newCap)){
    maxPlaces=parseInt(newCap);
    await update(refSpectacle,{maxPlaces:maxPlaces});
    document.getElementById("capacityLabel").textContent=maxPlaces;
    alert(`CapacitÃ© mise Ã  jour : ${maxPlaces} places maximum`);
    updateUI();
  }
};

// --- Supprimer toutes les rÃ©servations ---
document.getElementById("clearAllBtn").onclick=async ()=>{
  if(!adminMode)return;
  if(confirm("âš ï¸ Supprimer TOUTES les rÃ©servations ?")){
    await remove(ref(db,`spectacles/cabaret_printemps/reservations`));
    alert("Toutes les rÃ©servations ont Ã©tÃ© supprimÃ©es !");
  }
};

// --- Export CSV ---
document.getElementById("exportBtn").onclick=()=>{
  const rows=[["Nom","Email","TÃ©lÃ©phone","Adultes","Enfants","Total places","Montant (â‚¬)","PayÃ©"]];
  Object.values(reservations).forEach(r=>{
    rows.push([r.name,r.email,r.phone,r.nbAdult,r.nbChild,r.nbPlaces,r.amount.toFixed(2),r.paid?"OUI":"NON"]);
  });
  const csv=rows.map(r=>r.join(";")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="cabaret_printemps_reservations.csv";
  a.click();
};
</script>
</body>
</html>

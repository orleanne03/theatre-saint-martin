<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ‰ Salle de Bessay â€“ RÃ©servations</title>

<!-- Librairies externes -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body {
  font-family:"Segoe UI",sans-serif;
  background:#fff8e1;
  margin:0;text-align:center;color:#212121;padding:20px;
  transition: background 0.3s ease;
}
body.admin-mode {background:#ffe4ec;}
h1 {color:#d32f2f;margin-bottom:5px;}
h2 {color:#424242;font-weight:600;margin-bottom:20px;font-style:italic;}
form {
  background:#fff;max-width:400px;margin:0 auto;padding:20px;
  border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.15);
}
input,button {
  width:90%;margin:8px auto;padding:10px;border:1px solid #ccc;
  border-radius:8px;font-size:15px;display:block;text-align:center;
}
button {
  background:#d32f2f;color:white;font-weight:600;border:none;
  cursor:pointer;transition:0.3s;
}
button:hover {background:#b71c1c;}
#list {margin-top:25px;max-width:700px;margin-left:auto;margin-right:auto;
  background:transparent;border-radius:10px;padding:15px;text-align:left;}
.paid {color:#2e7d32;font-weight:600;}
.unpaid {color:#e91e63;font-weight:600;}
.delete-btn {
  background:#ef5350;border:none;color:white;border-radius:6px;
  padding:5px 10px;cursor:pointer;margin-top:8px;
}
.delete-btn:hover {background:#c62828;}
.admin-btn {background:#1565c0;margin-top:20px;}
.admin-btn:hover {background:#0d47a1;}
.clearall-btn {background:#8e24aa;}
.clearall-btn:hover {background:#6a1b9a;}
#totalPrice {font-weight:bold;color:#388e3c;margin-top:10px;}
.accordion-card {background:#fff;border-radius:10px;margin:10px auto;
  padding:10px 15px;max-width:600px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.accordion-header {
  font-size:1rem;font-weight:600;cursor:pointer;
  display:flex;justify-content:space-between;align-items:center;
  color:#333;border-bottom:1px solid #f0f0f0;padding-bottom:6px;
}
.accordion-header:hover {color:#d32f2f;}
.accordion-body {display:none;font-size:0.95rem;margin-top:10px;
  border-top:1px solid #eee;padding-top:10px;text-align:left;}
.accordion-body.open {display:block;}
#adminNotice {
  position:fixed;top:20px;right:20px;background:#d81b60;color:white;
  font-weight:600;padding:10px 16px;border-radius:50px;
  box-shadow:0 3px 8px rgba(0,0,0,0.2);
  z-index:9999;display:none;
}
body.admin-mode #adminToggle {background:#d32f2f !important;}
</style>
</head>
<body>

<div id="adminNotice">ğŸ‘‘ Vous Ãªtes en mode administrateur</div>

<h1>ğŸ‰ Salle de Bessay â€“ RÃ©servations</h1>
<h2>ğŸŸï¸ Spectacle du 23 janvier 2026</h2>

<form id="resForm">
  <input id="name" placeholder="Nom complet" required>
  <input id="email" placeholder="Email" type="email" required>
  <input id="phone" placeholder="TÃ©lÃ©phone" required>
  <input id="adult" type="number" min="0" step="1" placeholder="Adulte">
  <input id="child" type="number" min="0" step="1" placeholder="Enfant">
  <input id="infant" type="number" min="0" step="1" placeholder="Moins de 8 ans">
  <p id="totalPrice">Total : 0 â‚¬</p>
  <label style="display:flex;align-items:center;gap:8px;justify-content:center;">
    <input type="checkbox" id="paid"> Paiement reÃ§u ğŸ’¶
  </label>
  <button type="submit">âœ… Confirmer la rÃ©servation</button>
</form>

<div id="list"></div>

<!-- Boutons admin -->
<button class="admin-btn" id="priceBtn" style="display:none;">ğŸ’µ Modifier les tarifs</button>
<button class="admin-btn clearall-btn" id="clearAllBtn" style="display:none;">ğŸ—‘ Supprimer toutes les rÃ©servations</button>
<button class="admin-btn" id="emailTestBtn" style="display:none;">âœ‰ï¸ Mode email : TEST</button>

<button class="admin-btn" id="adminToggle">ğŸ” Mode Admin</button>
<button class="admin-btn" onclick="window.location.href='index.html'">ğŸ  Retour</button>

<!-- âœ… Script principal -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

emailjs.init("E4g_UFzGYQZBNH07m");

// ğŸ”¥ Config Firebase
const app = initializeApp({
  apiKey:"AIzaSyXXXX_TON_API_KEY",
  authDomain:"theatre-saint-martin.firebaseapp.com",
  databaseURL:"https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"theatre-saint-martin",
  storageBucket:"theatre-saint-martin.appspot.com",
  messagingSenderId:"1234567890",
  appId:"1:1234567890:web:abcd1234efgh"
});
const db = getDatabase(app);
const refSpectacle = ref(db, "spectacles/salle_bessay");

let reservations={},adminMode=false,emailTestMode=false;
let priceAdult=15,priceChild=10,priceInfant=0;

// âœï¸ Formatage
const nameInput=document.getElementById("name"),emailInput=document.getElementById("email"),phoneInput=document.getElementById("phone");
nameInput.addEventListener("input",()=>nameInput.value=nameInput.value.toUpperCase());
emailInput.addEventListener("input",()=>emailInput.value=emailInput.value.toLowerCase());
phoneInput.addEventListener("input",()=>{let d=phoneInput.value.replace(/\D/g,'');if(d.startsWith("33"))d="0"+d.slice(2);if(d.startsWith("0033"))d="0"+d.slice(4);phoneInput.value=d.slice(0,10).replace(/(\d{2})(?=\d)/g,'$1 ').trim();});

// ğŸ’¶ Total
const aI=document.getElementById("adult"),cI=document.getElementById("child"),iI=document.getElementById("infant"),totalEl=document.getElementById("totalPrice");
function updateTotal(){const a=+aI.value||0,c=+cI.value||0,i=+iI.value||0;totalEl.textContent=`Total : ${(a*priceAdult+c*priceChild+i*priceInfant).toFixed(2)} â‚¬`;}
[aI,cI,iI].forEach(e=>e.addEventListener("input",updateTotal));

onValue(refSpectacle,snap=>{reservations=snap.val()||{};renderList();});

// âœ… Envoi email + QR + modal TEST
async function sendEmailTicket(data){
  try{
    if(!window.QRCode || !window.QRCode.toCanvas){
      await new Promise((resolve)=>{
        const existing=document.querySelector("script[data-qrcode]");
        if(existing)return existing.addEventListener("load",resolve);
        const s=document.createElement("script");
        s.src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";
        s.async=false;
        s.dataset.qrcode="true";
        s.onload=resolve;
        document.head.appendChild(s);
      });
    }

    if(!window.QRCode || !window.QRCode.toCanvas){
      alert("âš ï¸ Impossible de charger la librairie QRCode.");
      return;
    }

    const canvas=document.createElement("canvas");
    await window.QRCode.toCanvas(canvas,`Nom:${data.name}\nEmail:${data.email}\nPlaces:${data.nbPlaces}`,{width:150});
    const qr=canvas.toDataURL();

    const msg=`
Bonjour ${data.name},<br><br>
Merci pour votre rÃ©servation Ã  la Salle de Bessay !<br>
Voici votre ticket pour le spectacle du <b>23 janvier 2026</b>.<br><br>
ğŸŸï¸ <b>Places :</b> ${data.nbPlaces}<br><br>
<img src="${qr}" style="width:150px;margin-top:10px;"/><br><br>
Ã€ bientÃ´t !<br>
â€” ThÃ©Ã¢tre Saint Martin`;

    if(emailTestMode){window.showEmailModal(msg);return;}

    await emailjs.send("service_0lqs9k7","template_hzfgnxs",{to_email:data.email,to_name:data.name,subject:"ğŸ‰ Salle de Bessay â€“ RÃ©servations",message:msg});
    alert("âœ‰ï¸ Ticket envoyÃ© !");
  }catch(err){
    console.error("Erreur Email:",err);
    alert("Erreur pendant lâ€™envoi.");
  }
}

// ğŸ§¾ Soumission
document.getElementById("resForm").onsubmit=async e=>{
  e.preventDefault();
  const name=nameInput.value.trim().toUpperCase(),email=emailInput.value.trim().toLowerCase(),phone=phoneInput.value.trim();
  const nbA=+aI.value||0,nbC=+cI.value||0,nbI=+iI.value||0,total=nbA+nbC+nbI,paid=document.getElementById("paid").checked;
  if(!name||!email||!phone||total===0)return alert("âŒ Formulaire incomplet !");
  const id=Date.now(),amount=nbA*priceAdult+nbC*priceChild+nbI*priceInfant;
  const data={name,email,phone,nbAdult:nbA,nbChild:nbC,nbInfant:nbI,nbPlaces:total,amount,paid};
  await set(ref(db,`spectacles/salle_bessay/${id}`),data);
  alert("âœ… RÃ©servation enregistrÃ©e !");
  sendEmailTicket(data);
  e.target.reset();updateTotal();
};

// ğŸ”½ Liste
window.toggleAccordion=id=>document.getElementById(`body-${id}`).classList.toggle("open");
function renderList(){
  const c=document.getElementById("list"),entries=Object.entries(reservations);
  if(!entries.length){c.innerHTML="<p>Aucune rÃ©servation.</p>";return;}
  c.innerHTML="<h3>ğŸ“‹ RÃ©servations</h3>";
  entries.sort((a,b)=>b[0]-a[0]).forEach(([id,r])=>{
    const p=r.paid?"paid":"unpaid",txt=r.paid?"âœ… PayÃ©":"âŒ Non payÃ©";
    c.innerHTML+=`
<div class="accordion-card">
 <div class="accordion-header" onclick="toggleAccordion('${id}')"><span><b>${r.name}</b> â€“ ${r.nbPlaces} places</span><span class="${p}">${txt}</span></div>
 <div class="accordion-body" id="body-${id}">
  <p>ğŸ“ ${r.phone}</p><p>ğŸ“§ ${r.email}</p>
  <p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ${r.nbAdult} adulte(s), ${r.nbChild} enfant(s), ${r.nbInfant} -8 ans</p>
  ${adminMode?`<button class="toggle-paid-btn" onclick="togglePaid('${id}',${!r.paid})">ğŸ’¶ Basculer paiement</button><button class="delete-btn" onclick="deleteRes('${id}')">ğŸ—‘ Supprimer</button>`:""}
 </div></div>`;
  });
}

// âš™ï¸ Admin
window.togglePaid=async(id,s)=>{const r=reservations[id];await set(ref(db,`spectacles/salle_bessay/${id}`),{...r,paid:s});renderList();};
window.deleteRes=async id=>{if(confirm("Supprimer ?"))await remove(ref(db,`spectacles/salle_bessay/${id}`));};
document.getElementById("adminToggle").onclick=()=>{
  const n=document.getElementById("adminNotice");
  if(!adminMode){
    const pass=prompt("Mot de passe admin :");if(pass!=="admin123")return alert("Mot de passe incorrect !");
    adminMode=true;document.body.classList.add("admin-mode");n.style.display="block";
    document.getElementById("adminToggle").textContent="ğŸšª Sortir du mode admin";
    ["priceBtn","clearAllBtn","emailTestBtn"].forEach(i=>document.getElementById(i).style.display="inline-block");
  }else{
    adminMode=false;document.body.classList.remove("admin-mode");n.style.display="none";
    document.getElementById("adminToggle").textContent="ğŸ” Mode Admin";
    ["priceBtn","clearAllBtn","emailTestBtn"].forEach(i=>document.getElementById(i).style.display="none");
    window.toggleEmailTestIndicator(false);
  }
  renderList();
};
document.getElementById("emailTestBtn").onclick=()=>{if(!adminMode)return;emailTestMode=!emailTestMode;document.getElementById("emailTestBtn").textContent=emailTestMode?"âœ‰ï¸ Mode email : RÃ‰EL":"âœ‰ï¸ Mode email : TEST";window.toggleEmailTestIndicator(emailTestMode);};
</script>

<!-- âœ… Modal aperÃ§u dâ€™e-mail -->
<div id="emailModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
 background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;">
 <div style="background:#fff;border-radius:10px;padding:20px 25px;max-width:500px;width:90%;
 max-height:80vh;overflow:auto;text-align:left;position:relative;">
  <button id="closeModal" style="position:absolute;top:10px;right:10px;background:#d32f2f;color:white;
  border:none;border-radius:5px;padding:5px 10px;cursor:pointer;">âœ–</button>
  <h3>ğŸ“§ AperÃ§u de lâ€™e-mail</h3>
  <div id="emailPreview" style="font-size:0.95rem;line-height:1.4;"></div>
 </div>
</div>

<!-- âœ… Bulle mode test -->
<div id="testNotice" style="display:none;position:fixed;top:20px;left:20px;background:#2196f3;
 color:white;font-weight:600;padding:10px 16px;border-radius:50px;
 box-shadow:0 3px 8px rgba(0,0,0,0.2);z-index:9999;">âœ‰ï¸ Mode TEST email activÃ©</div>

<script>
window.showEmailModal=function(html){document.getElementById("emailPreview").innerHTML=html;document.getElementById("emailModal").style.display="flex";};
document.getElementById("closeModal").onclick=()=>{document.getElementById("emailModal").style.display="none";};
window.toggleEmailTestIndicator=function(active){document.getElementById("testNotice").style.display=active?"block":"none";};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ­ Salle de Bessay â€“ RÃ©servations</title>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body {
  font-family:"Segoe UI",sans-serif;
  background:#fff8e1;
  color:#212121;
  margin:0;
  padding:20px;
  text-align:center;
  transition:background 0.3s ease;
}
body.admin-mode { background:#ffe4ec; }
h1 { color:#d32f2f; margin-bottom:5px; }
h2 { color:#424242; font-weight:600; font-style:italic; margin-bottom:20px; }

form {
  background:#fff;
  max-width:400px;
  margin:0 auto;
  padding:20px;
  border-radius:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
  text-align:left;
}
form input, form button {
  width:95%;
  margin:8px auto;
  padding:10px;
  border:1px solid #ccc;
  border-radius:8px;
  font-size:15px;
  display:block;
}
form input { text-align:left; }
form button {
  background:#d32f2f;
  color:white;
  border:none;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
  text-align:center;
}
form button:hover { background:#b71c1c; }
#totalPrice { font-weight:bold; color:#388e3c; margin-top:10px; text-align:center; }

#list { margin-top:30px; max-width:700px; margin-left:auto; margin-right:auto; }

.accordion-card {
  background:#fff;
  border-radius:10px;
  margin:12px auto;
  padding:12px 15px;
  max-width:600px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.accordion-header {
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #f0f0f0;
  padding-bottom:6px;
  cursor:pointer;
}
.accordion-body {
  display:none;
  margin-top:10px;
  text-align:left;
  font-size:0.95rem;
}
.accordion-body.open { display:block; }
.paid { color:#2e7d32; font-weight:600; }
.unpaid { color:#e91e63; font-weight:600; }

.delete-btn, .toggle-paid-btn {
  width:90%;
  display:block;
  margin:8px auto;
  border:none;
  border-radius:8px;
  color:white;
  padding:10px;
  font-weight:bold;
  cursor:pointer;
}
.toggle-paid-btn { background:#2e7d32; }
.delete-btn { background:#e53935; }
.toggle-paid-btn:hover { background:#1b5e20; }
.delete-btn:hover { background:#b71c1c; }

.admin-btn {
  background:#1565c0;
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 16px;
  font-weight:600;
  margin:10px 5px;
  cursor:pointer;
}
.admin-btn:hover { background:#0d47a1; }

#emailModal {
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,0.5);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  z-index:1000;
  opacity:0;
  visibility:hidden;
  transition:opacity 0.3s ease;
}
#emailModal.show { display:flex!important; opacity:1!important; visibility:visible!important; }

#emailModalContent {
  background:#fff;
  border-radius:10px;
  padding:25px 30px;
  max-width:600px;
  width:90%;
  text-align:left;
  box-shadow:0 5px 12px rgba(0,0,0,0.3);
}
#emailPreview { font-size:0.95rem; line-height:1.5; }

#testNotice {
  position:fixed;
  top:15px;
  left:15px;
  background:#2196f3;
  color:white;
  padding:10px 20px;
  border-radius:30px;
  display:none;
  font-weight:600;
  box-shadow:0 3px 8px rgba(0,0,0,0.25);
}
#adminNotice {
  position:fixed;
  top:15px;
  right:15px;
  background:#d81b60;
  color:white;
  padding:10px 18px;
  border-radius:30px;
  display:none;
  font-weight:600;
  box-shadow:0 3px 8px rgba(0,0,0,0.25);
}
</style>
</head>

<body>

<h1>ğŸŸï¸ Salle de Bessay â€“ RÃ©servations</h1>
<h2>ğŸ­ Spectacle du 23 janvier 2026</h2>

<form id="resForm">
  <input id="name" placeholder="Nom complet" required>
  <input id="email" placeholder="Email" type="email" required>
  <input id="phone" placeholder="TÃ©lÃ©phone" required>
  <input id="adult" type="number" min="0" placeholder="Adulte(s)">
  <input id="child" type="number" min="0" placeholder="Enfant(s)">
  <p id="totalPrice">Total : 0 â‚¬</p>
  <button type="submit">âœ… Confirmer la rÃ©servation</button>
</form>

<div id="list"></div>

<!-- Boutons admin -->
<div style="margin-top:25px;">
  <button class="admin-btn" id="adminToggle">ğŸ” Mode Admin</button>
  <button class="admin-btn" id="priceBtn" style="display:none;">ğŸ’µ Modifier les tarifs</button>
  <button class="admin-btn" id="testEmailBtn" style="display:none;">âœ‰ï¸ Mode Email : TEST</button>
  <button class="admin-btn" id="exportBtn" style="display:none;">ğŸ’¾ Enregistrer les rÃ©servations</button>
</div>

<div id="testNotice">âœ‰ï¸ Mode TEST activÃ©</div>
<div id="adminNotice">ğŸ‘‘ Vous Ãªtes en mode administrateur</div>

<!-- FenÃªtre modale -->
<div id="emailModal">
  <div id="emailModalContent">
    <h3 style="text-align:center;">ğŸ“§ AperÃ§u de lâ€™e-mail</h3>
    <div id="emailPreview"></div>
    <button style="display:block;margin:20px auto 0;background:#d32f2f;color:white;border:none;border-radius:8px;padding:10px 20px;font-weight:600;cursor:pointer;" onclick="closeModal()">Fermer la fenÃªtre</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

emailjs.init("E4g_UFzGYQZBNH07m");

// Firebase config
const app = initializeApp({
  apiKey:"AIzaSyXXXX_TON_API_KEY",
  authDomain:"theatre-saint-martin.firebaseapp.com",
  databaseURL:"https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"theatre-saint-martin",
  storageBucket:"theatre-saint-martin.appspot.com",
  messagingSenderId:"1234567890",
  appId:"1:1234567890:web:abcd1234efgh"
});
const db = getDatabase(app);
const refSpectacle = ref(db, "spectacles/salle_bessay");

let reservations={}, adminMode=false, emailTestMode=false;
let priceAdult=15, priceChild=10;

// Formatage entrÃ©es
const nameInput=document.getElementById("name"),
      emailInput=document.getElementById("email"),
      phoneInput=document.getElementById("phone");

nameInput.addEventListener("input",()=>nameInput.value=nameInput.value.toUpperCase());
emailInput.addEventListener("input",()=>emailInput.value=emailInput.value.toLowerCase());
phoneInput.addEventListener("input",()=>{
  let d=phoneInput.value.replace(/\D/g,'');
  if(d.startsWith("33"))d="0"+d.slice(2);
  if(d.startsWith("0033"))d="0"+d.slice(4);
  phoneInput.value=d.slice(0,10).replace(/(\d{2})(?=\d)/g,'$1 ').trim();
});

// Total
const aI=document.getElementById("adult"),cI=document.getElementById("child"),totalEl=document.getElementById("totalPrice");
function updateTotal(){const a=+aI.value||0,c=+cI.value||0;totalEl.textContent=`Total : ${(a*priceAdult+c*priceChild).toFixed(2)} â‚¬`;}
[aI,cI].forEach(e=>e.addEventListener("input",updateTotal));

onValue(refSpectacle,snap=>{reservations=snap.val()||{};renderList();});

// Envoi Email
async function sendEmail(data){
  if(emailTestMode){showEmailPreview(`
    <div style="font-family:'Segoe UI',sans-serif;color:#222;">
      <h2 style="color:#d32f2f;text-align:center;">ğŸ­ ThÃ©Ã¢tre Saint Martin</h2>
      <p style="text-align:center;color:#555;">Salle de Bessay â€“ Spectacle du 23 janvier 2026</p>
      <hr style="border:1px solid #d32f2f;margin:10px 0;">
      <p>Bonjour <strong>${data.name}</strong>,</p>
      <p>Merci pour votre rÃ©servation Ã  la <strong>Salle de Bessay</strong> !</p>
      <p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Adulte(s) : ${data.nbAdult}<br>ğŸ§’ Enfant(s) : ${data.nbChild}<br>ğŸ’º Total places : ${data.nbPlaces}<br>ğŸ’¶ Montant : <strong>${data.amount.toFixed(2)} â‚¬</strong></p>
      <p>Veuillez prÃ©senter cet e-mail le soir du spectacle (imprimÃ© ou sur votre tÃ©lÃ©phone).</p>
      <p style="margin-top:20px;">Ã€ trÃ¨s bientÃ´t,<br><strong>Lâ€™Ã©quipe du ThÃ©Ã¢tre Saint Martin</strong></p>
    </div>`);return;}

  await emailjs.send("service_0lqs9k7","template_w2j3pqp",{
    to_email:data.email,to_name:data.name,
    nbAdult:data.nbAdult,nbChild:data.nbChild,
    nbPlaces:data.nbPlaces,amount:data.amount.toFixed(2)
  });
  alert("âœ‰ï¸ E-mail envoyÃ© !");
}

// Formulaire
document.getElementById("resForm").onsubmit=async e=>{
  e.preventDefault();
  const name=nameInput.value.trim().toUpperCase(),email=emailInput.value.trim().toLowerCase(),phone=phoneInput.value.trim();
  const nbA=+aI.value||0,nbC=+cI.value||0,total=nbA+nbC;
  if(!name||!email||!phone||total===0)return alert("âŒ Formulaire incomplet !");
  const data={name,email,phone,nbAdult:nbA,nbChild:nbC,nbPlaces:total,amount:(nbA*priceAdult+nbC*priceChild),paid:false};
  await set(ref(db,`spectacles/salle_bessay/${Date.now()}`),data);
  alert("âœ… RÃ©servation enregistrÃ©e !");
  sendEmail(data);
  e.target.reset();updateTotal();
};

// Liste
function renderList(){
  const c=document.getElementById("list"),entries=Object.entries(reservations);
  if(!entries.length){c.innerHTML="<p>Aucune rÃ©servation.</p>";return;}
  c.innerHTML="<h3>ğŸ“‹ RÃ©servations</h3>";
  entries.sort((a,b)=>b[0]-a[0]).forEach(([id,r])=>{
    const p=r.paid?"paid":"unpaid",txt=r.paid?"âœ… PayÃ©":"âŒ Non payÃ©";
    c.innerHTML+=`
<div class="accordion-card">
 <div class="accordion-header" onclick="document.getElementById('body-${id}').classList.toggle('open')">
   <span><b>${r.name}</b> â€“ ${r.nbPlaces} places</span>
   <span class="${p}">${txt}</span>
 </div>
 <div class="accordion-body" id="body-${id}">
   <p>ğŸ“ ${r.phone}</p><p>ğŸ“§ ${r.email}</p>
   <p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ${r.nbAdult} adulte(s), ${r.nbChild} enfant(s)</p>
   ${adminMode?`<button class="toggle-paid-btn" onclick="togglePaid('${id}',${!r.paid})">ğŸ’¶ Basculer paiement</button><button class="delete-btn" onclick="deleteRes('${id}')">ğŸ—‘ Supprimer</button>`:""}
 </div></div>`;
  });
}

// Fonctions admin
window.togglePaid=async(id,s)=>{const r=reservations[id];await set(ref(db,`spectacles/salle_bessay/${id}`),{...r,paid:s});renderList();};
window.deleteRes=async id=>{if(confirm("Supprimer ?"))await remove(ref(db,`spectacles/salle_bessay/${id}`));};

document.getElementById("adminToggle").onclick=()=>{
  const notice=document.getElementById("adminNotice");
  if(!adminMode){
    const pass=prompt("Mot de passe admin :");
    if(pass!=="admin123")return alert("Mot de passe incorrect !");
    adminMode=true;
    document.body.classList.add("admin-mode");
    notice.style.display="block";
    document.getElementById("adminToggle").textContent="ğŸšª Sortir du mode admin";
    ["priceBtn","testEmailBtn","exportBtn"].forEach(i=>document.getElementById(i).style.display="inline-block");
  }else{
    adminMode=false;
    emailTestMode=false;
    document.body.classList.remove("admin-mode");
    notice.style.display="none";
    document.getElementById("adminToggle").textContent="ğŸ” Mode Admin";
    ["priceBtn","testEmailBtn","exportBtn"].forEach(i=>document.getElementById(i).style.display="none");
    document.getElementById("testNotice").style.display="none";
  }
  renderList();
};

document.getElementById("priceBtn").onclick=()=>{
  const a=parseFloat(prompt("Tarif adulte (â‚¬)",priceAdult))||priceAdult;
  const c=parseFloat(prompt("Tarif enfant (â‚¬)",priceChild))||priceChild;
  priceAdult=a;priceChild=c;alert("Tarifs mis Ã  jour !");updateTotal();
};

document.getElementById("testEmailBtn").onclick=()=>{
  emailTestMode=!emailTestMode;
  document.getElementById("testNotice").style.display=emailTestMode?"block":"none";
  document.getElementById("testEmailBtn").textContent=emailTestMode?"âœ‰ï¸ Mode Email : RÃ‰EL":"âœ‰ï¸ Mode Email : TEST";
};

// === Export CSV des rÃ©servations ===
document.getElementById("exportBtn").onclick = () => {
  if (!Object.keys(reservations).length) {
    alert("Aucune rÃ©servation Ã  exporter.");
    return;
  }

  const lignes = [
    ["Nom", "Email", "TÃ©lÃ©phone", "Adultes", "Enfants", "Total places", "Montant (â‚¬)", "PayÃ©"]
  ];

  Object.values(reservations).forEach(r => {
    lignes.push([
      r.name,
      r.email,
      r.phone,
      r.nbAdult,
      r.nbChild,
      r.nbPlaces,
      r.amount.toFixed(2),
      r.paid ? "Oui" : "Non"
    ]);
  });

  const contenu = lignes.map(l => l.join(";")).join("\n");
  const blob = new Blob([contenu], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  const date = new Date().toISOString().split("T")[0];
  a.download = `reservations_bessay_${date}.csv`;
  a.click();

  URL.revokeObjectURL(url);
};

// Modale
window.showEmailPreview=html=>{const m=document.getElementById("emailModal");document.getElementById("emailPreview").innerHTML=html;m.classList.add("show");};
window.closeModal=()=>document.getElementById("emailModal").classList.remove("show");
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ­ Salle de Bessay â€“ RÃ©servations</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
body {
  font-family:"Segoe UI",sans-serif;
  background:#fff8e1;
  margin:0;text-align:center;color:#212121;padding:20px;
}
h1{color:#d32f2f;margin-bottom:5px;}
form{
  background:#fff;max-width:400px;margin:0 auto;padding:20px;
  border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.15);
}
input,button{
  width:90%;margin:8px auto;padding:10px;border:1px solid #ccc;
  border-radius:8px;font-size:15px;display:block;text-align:center;
}
button{
  background:#d32f2f;color:white;font-weight:600;border:none;
  cursor:pointer;transition:0.3s;
}
button:hover{background:#b71c1c;}
#list{
  margin-top:25px;max-width:700px;margin-left:auto;margin-right:auto;
  background:#fafafa;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);
  padding:15px;text-align:left;
}
.res-item{
  border-bottom:1px solid #eee;padding:6px 0;font-size:0.95rem;
  display:flex;justify-content:space-between;align-items:center;
}
.paid{color:#2e7d32;font-weight:600;}
.unpaid{color:#e91e63;font-weight:600;}
.delete-btn{
  background:#ef5350;border:none;color:white;border-radius:6px;
  padding:4px 8px;cursor:pointer;
}
.delete-btn:hover{background:#c62828;}
.admin-btn{background:#1565c0;margin-top:20px;}
.admin-btn:hover{background:#0d47a1;}
.export-btn{background:#00796b;margin:10px 0;}
.export-btn:hover{background:#004d40;}
.clearall-btn{background:#8e24aa;}
.clearall-btn:hover{background:#6a1b9a;}
#totalPrice{font-weight:bold;color:#388e3c;margin-top:10px;}
</style>
</head>
<body>
<h1>ğŸ­ Salle de Bessay</h1>
<h2>RÃ©servations sans limitation de places</h2>

<form id="resForm">
  <input id="name" placeholder="Nom complet" required>
  <input id="email" placeholder="Email" type="email" required>
  <input id="phone" placeholder="TÃ©lÃ©phone" required>
  <input id="adult" type="number" min="0" step="1" placeholder="Adulte">
  <input id="child" type="number" min="0" step="1" placeholder="Enfant">
  <p id="totalPrice">Total : 0 â‚¬</p>
  <label style="display:flex;align-items:center;gap:8px;justify-content:center;">
    <input type="checkbox" id="paid"> Paiement reÃ§u ğŸ’¶
  </label>
  <button type="submit">âœ… Confirmer la rÃ©servation</button>
</form>

<button class="admin-btn" id="priceBtn" style="display:none;">ğŸ’µ Modifier les tarifs</button>
<button class="export-btn" id="exportBtn" style="display:none;">â¬‡ï¸ Export CSV</button>
<button class="clearall-btn" id="clearAllBtn" style="display:none;">ğŸ—‘ Supprimer toutes les rÃ©servations</button>

<div id="list"></div>

<button class="admin-btn" id="adminToggle">ğŸ” Mode Admin</button>
<button class="admin-btn" onclick="window.location.href='index.html'">ğŸ  Retour</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// âœ… Configuration Firebase
const app = initializeApp({
  apiKey:"AIzaSyXXXX_TON_API_KEY",
  authDomain:"theatre-saint-martin.firebaseapp.com",
  databaseURL:"https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"theatre-saint-martin",
  storageBucket:"theatre-saint-martin.appspot.com",
  messagingSenderId:"1234567890",
  appId:"1:1234567890:web:abcd1234efgh"
});
const db = getDatabase(app);
const refSpectacle = ref(db, "spectacles/salle_bessay");

let reservations = {};
let adminMode = false;
let priceAdult = 15;
let priceChild = 10;

// --- Normalisation des saisies ---
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const phoneInput = document.getElementById("phone");

nameInput.addEventListener("input",()=>{ nameInput.value = nameInput.value.toUpperCase(); });
emailInput.addEventListener("input",()=>{ emailInput.value = emailInput.value.toLowerCase(); });
phoneInput.addEventListener("input",()=>{
  let digits = phoneInput.value.replace(/\D/g,'');
  if (digits.startsWith("33")) digits = "0" + digits.slice(2);
  if (digits.startsWith("0033")) digits = "0" + digits.slice(4);
  digits = digits.slice(0,10);
  phoneInput.value = digits.replace(/(\d{2})(?=\d)/g,'$1 ').trim();
});

const adultInput=document.getElementById("adult");
const childInput=document.getElementById("child");
const totalPriceEl=document.getElementById("totalPrice");

function updateTotal(){
  const nbA = Number(adultInput.value) || 0;
  const nbC = Number(childInput.value) || 0;
  totalPriceEl.textContent = `Total : ${(nbA*priceAdult + nbC*priceChild).toFixed(2)} â‚¬`;
}
adultInput.addEventListener("input", updateTotal);
childInput.addEventListener("input", updateTotal);

// --- Lecture des rÃ©servations en direct ---
onValue(refSpectacle, snap=>{
  reservations = snap.val() || {};
  renderList();
});

// --- Enregistrement d'une rÃ©servation ---
document.getElementById("resForm").onsubmit = async (e) =>{
  e.preventDefault();

  const name = nameInput.value.trim().toUpperCase();
  const email = emailInput.value.trim().toLowerCase();
  const phone = phoneInput.value.trim();
  const nbA = Number(adultInput.value) || 0;
  const nbC = Number(childInput.value) || 0;
  const total = nbA + nbC;
  const paid = document.getElementById("paid").checked;

  if(!name || !email || !phone || total === 0){
    alert("âŒ Veuillez remplir tous les champs correctement !");
    return;
  }

  const id = Date.now();
  const amount = nbA*priceAdult + nbC*priceChild;
  const data = { name, email, phone, nbAdult: nbA, nbChild: nbC, nbPlaces: total, amount, paid };

  try {
    await set(ref(db, `spectacles/salle_bessay/${id}`), data);
    alert("âœ… RÃ©servation enregistrÃ©e !");
    e.target.reset();
    updateTotal();
  } catch (err) {
    console.error("Erreur Firebase:", err);
    alert(`âŒ Erreur lors de lâ€™enregistrement : ${err.message}`);
  }
};

// --- Affichage des rÃ©servations ---
function renderList(){
  const container=document.getElementById("list");
  const entries=Object.entries(reservations);
  if(!entries.length){
    container.innerHTML="<p>Aucune rÃ©servation pour lâ€™instant.</p>";
    return;
  }
  container.innerHTML="<h3>ğŸ“‹ RÃ©servations</h3>";
  entries.sort((a,b)=>b[0]-a[0]).forEach(([id,r])=>{
    container.innerHTML+=`
      <div class="res-item">
        <span><strong>${r.name}</strong> â€“ ${r.nbPlaces} places (${r.amount.toFixed(2)} â‚¬)
        â€“ <span class="${r.paid?"paid":"unpaid"}">${r.paid?"PayÃ©":"Non payÃ©"}</span></span>
        ${adminMode?`<button class="delete-btn" onclick="deleteRes('${id}')">ğŸ—‘</button>`:""}
      </div>`;
  });
}

window.deleteRes = async id=>{
  if(confirm("Supprimer cette rÃ©servation ?"))
    await remove(ref(db,`spectacles/salle_bessay/${id}`));
};

// --- Mode admin ---
document.getElementById("adminToggle").onclick = ()=>{
  if(!adminMode){
    const pass=prompt("Mot de passe admin :");
    if(pass!=="admin123")return alert("Mot de passe incorrect !");
    adminMode=true;
    ["exportBtn","priceBtn","clearAllBtn"].forEach(id=>document.getElementById(id).style.display="inline-block");
  }else{
    adminMode=false;
    ["exportBtn","priceBtn","clearAllBtn"].forEach(id=>document.getElementById(id).style.display="none");
  }
  renderList();
};

// --- Modifier tarifs ---
document.getElementById("priceBtn").onclick = ()=>{
  if(!adminMode)return;
  const pA=prompt("Tarif adulte (â‚¬)",priceAdult);
  const pC=prompt("Tarif enfant (â‚¬)",priceChild);
  if(pA&&pC){
    priceAdult=parseFloat(pA);
    priceChild=parseFloat(pC);
    alert(`Tarifs mis Ã  jour : Adultes ${priceAdult} â‚¬, Enfants ${priceChild} â‚¬`);
    updateTotal();
  }
};

// --- Supprimer toutes les rÃ©servations ---
document.getElementById("clearAllBtn").onclick = async ()=>{
  if(!adminMode)return;
  if(confirm("âš ï¸ Supprimer TOUTES les rÃ©servations ?")){
    await remove(refSpectacle);
    alert("Toutes les rÃ©servations ont Ã©tÃ© supprimÃ©es !");
  }
};

// --- Export CSV ---
document.getElementById("exportBtn").onclick = ()=>{
  const rows=[["Nom","Email","TÃ©lÃ©phone","Adultes","Enfants","Total places","Montant (â‚¬)","PayÃ©"]];
  Object.values(reservations).forEach(r=>{
    rows.push([r.name,r.email,r.phone,r.nbAdult,r.nbChild,r.nbPlaces,r.amount.toFixed(2),r.paid?"OUI":"NON"]);
  });
  const csv=rows.map(r=>r.join(";")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="salle_bessay_reservations.csv";
  a.click();
};
</script>
</body>
</html>

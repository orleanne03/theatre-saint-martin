<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ­ Salle de Bessay â€“ RÃ©servations</title>



<style>
body {
  font-family:"Segoe UI",sans-serif;
  background:#fff8e1; color:#212121;
  margin:0; padding:20px; text-align:center;
  transition:background .3s ease;
}
body.admin-mode { background:#ffe4ec; }

h1 { color:#d32f2f; margin-bottom:5px; }
h2 { color:#424242; font-weight:600; font-style:italic; margin-bottom:20px; }

form {
  background:#fff; max-width:400px; margin:0 auto; padding:20px;
  border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,.15);
  text-align:left;
}
form input, form button {
  width:95%; margin:8px auto; padding:10px; border:1px solid #ccc;
  border-radius:8px; font-size:15px; display:block;
}
form button {
  background:#d32f2f; color:#fff; border:none; font-weight:bold;
  cursor:pointer; transition:0.3s;
}
form button:hover { background:#b71c1c; }
#totalPrice { font-weight:bold; color:#388e3c; margin-top:10px; text-align:center; }

#list { margin-top:30px; max-width:700px; margin-left:auto; margin-right:auto; }

.accordion-card {
  background:#fff;
  border-radius:10px;
  margin:12px auto;
  padding:12px 15px;
  max-width:600px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  transition:background 0.3s ease, border-color .3s ease;
}
.accordion-card.present-card {
  background-color:#e8f5e9 !important;
  border:2px solid #2e7d32 !important;
}
.accordion-header {
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #f0f0f0;
  padding-bottom:6px;
  cursor:pointer;
}
.accordion-body {
  display:none;
  margin-top:10px;
  text-align:left;
  font-size:0.95rem;
}
.accordion-body.open { display:block; }
.paid { color:#2e7d32; font-weight:600; }
.unpaid { color:#e91e63; font-weight:600; }

.delete-btn, .action-btn {
  width:90%;
  display:block;
  margin:8px auto;
  border:none;
  border-radius:8px;
  color:white;
  padding:10px;
  font-weight:bold;
  cursor:pointer;
}
.action-btn { background:#2e7d32; }
.action-btn:hover { background:#1b5e20; }
.delete-btn { background:#e53935; }
.delete-btn:hover { background:#b71c1c; }

.admin-btn {
  background:#1565c0;
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 16px;
  font-weight:600;
  margin:10px 5px;
  cursor:pointer;
}
.admin-btn:hover { background:#0d47a1; }

#emailModal {
  position:fixed; inset:0; display:none; justify-content:center; align-items:center;
  background:rgba(0,0,0,0.5); backdrop-filter:blur(6px);
  z-index:1000; transition:opacity 0.3s ease;
}
#emailModal.show { display:flex!important; }
#emailModalContent {
  background:#fff; border-radius:10px; padding:25px 30px; max-width:600px; width:90%;
  text-align:left; box-shadow:0 5px 12px rgba(0,0,0,0.3);
}
#emailPreview { font-size:0.95rem; line-height:1.5; }

#testNotice, #adminNotice {
  position:fixed; top:15px; font-weight:600; padding:10px 18px;
  border-radius:30px; box-shadow:0 3px 8px rgba(0,0,0,0.25); color:white; display:none;
}
#testNotice { left:15px; background:#2196f3; }
#adminNotice { right:15px; background:#d81b60; }
div#bulkRecipients label {
    text-align: left;
}
/* ğŸŸï¸ RÃ©servation gratuite */
.free-line {
  background: #ffe0b2 !important;
  border-left: 6px solid #fb8c00;
}
.free-badge {
  background: #fb8c00;
  color: white;
  padding: 2px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 6px;
}

</style>
</head>

<body>

<h1>ğŸŸï¸ Salle de Bessay â€“ RÃ©servations</h1>
<h2>ğŸ­ Spectacle du 23 janvier 2026</h2>
<br>Adulte : 22â‚¬ / Enfant - 12 ans : 15â‚¬</br>
<form id="resForm">
  <input id="name" placeholder="Nom et PrÃ©nom" required>
  <input id="email" placeholder="Email" type="email" required>
  <input id="phone" placeholder="TÃ©lÃ©phone" required>
  <input id="adult" type="number" min="0" placeholder="Adulte(s)">
  <input id="child" type="number" min="0" placeholder="Enfant(s) -12 ans">
  <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <input type="checkbox" id="paid" style="width:auto;">
    <span>Paiement reÃ§u ğŸ’¶</span>
  </label>
  <label style="display:flex;align-items:center;gap:8px;margin-top:6px;">
  <input type="checkbox" id="free" style="width:auto;">
  <span>ğŸŸï¸ RÃ©servation gratuite</span>
</label>

  <p id="totalPrice">Total : 0 â‚¬</p>
  <button type="submit">âœ… Confirmer la rÃ©servation</button>
</form>

<div id="list"></div>

<div style="margin-top:25px;">
  <button class="admin-btn" id="adminToggle">ğŸ” Mode Admin</button>
  <div style="text-align:center; margin-top:15px;">
    <a href="accueil.html"
       style="display:inline-block; background-color:#6d4c41; color:#fff; text-decoration:none;
              padding:8px 16px; border-radius:8px; font-weight:600; font-size:0.9rem;">
      ğŸ  Accueil
    </a>
  </div>
  <button class="admin-btn" id="priceBtn" style="display:none;">ğŸ’µ Modifier les tarifs</button>
  <button class="admin-btn" id="testEmailBtn" style="display:none;">âœ‰ï¸ Mode Email : TEST</button>
  <button class="admin-btn" id="exportBtn" style="display:none;">ğŸ’¾ Enregistrer les rÃ©servations</button>
  <button class="admin-btn" id="exportEmailsBtn" style="display:none;">ğŸ“§ Exporter tous les emails</button>

  <button id="sendBulkEmail" style="display:none;background:#ff9800;">
  ğŸ“¢ Email groupÃ© (erratum)
</button>
<button id="sendAllTickets" style="display:none;background:#2e7d32;color:white;padding:10px 15px;border:none;border-radius:6px;cursor:pointer;">
ğŸ“¬ Renvoyer TOUS les billets (Bessay)
</button>



</div>

<div id="testNotice">âœ‰ï¸ Mode TEST activÃ©</div>
<div id="adminNotice">ğŸ‘‘ Vous Ãªtes en mode administrateur</div>

<!-- Modale dâ€™aperÃ§u email -->
<div id="emailModal">
  <div id="emailModalContent">
    <h3 style="text-align:center;">ğŸ“§ AperÃ§u de lâ€™e-mail</h3>
    <div id="emailPreview"></div>
    <button id="closeModalBtn" style="display:block;margin:20px auto 0;background:#d32f2f;color:white;border:none;border-radius:8px;padding:10px 20px;font-weight:600;cursor:pointer;">Fermer</button>
  </div>
</div>
<!-- ğŸ“¢ Modale Email groupÃ© (erratum) -->
<div id="bulkEmailModal" style="
  position:fixed; inset:0;
  background:rgba(0,0,0,0.5);
  display:none; justify-content:center; align-items:center;
  z-index:2000;
">
  <div style="
    background:white; border-radius:12px;
    padding:25px 30px; max-width:500px; width:90%;
    box-shadow:0 5px 12px rgba(0,0,0,0.3);
  ">
    <h3 style="margin-top:0;">ğŸ“¢ Email groupÃ© (erratum)</h3>

    <input id="bulkSubject"
      placeholder="Sujet de lâ€™email"
      style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;">

    <textarea id="bulkMessage"
      placeholder="Message Ã  envoyer"
      style="width:100%;height:140px;padding:10px;border-radius:8px;border:1px solid #ccc;"></textarea>

    <!-- ğŸŸ¢ LISTE DES DESTINATAIRES -->
    <div id="bulkRecipients"
      style="margin:15px 0; max-height:160px; overflow:auto;
             border:1px solid #ddd; border-radius:8px; padding:10px;
             font-size:0.9rem;">
    </div>

    <div style="margin-top:15px;text-align:right;">
      <button id="bulkCancel" style="margin-right:10px;">Annuler</button>
      <button id="bulkSend"
        style="background:#ff9800;color:white;border:none;
               border-radius:8px;padding:10px 16px;font-weight:600;">
        Envoyer
      </button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, push, get } 
from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";



/* Firebase */
const app = initializeApp({
  apiKey:"AIzaSyXXXX_TON_API_KEY",
  authDomain:"theatre-saint-martin.firebaseapp.com",
  databaseURL:"https://theatre-saint-martin-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"theatre-saint-martin",
  storageBucket:"theatre-saint-martin.appspot.com",
  messagingSenderId:"1234567890",
  appId:"1:1234567890:web:abcd1234efgh"
});
const db = getDatabase(app);
const refSpectacle = ref(db, "spectacles/salle_bessay");

/* Ã‰tat */
let reservations = {};
let adminMode = false;
let emailTestMode = false;
let singleTargetEmail = null;

let priceAdult = 22, priceChild = 15;
let participantsTargetReservationId = null;

// ğŸ”¢ Compte les participants dont le billet n'est PAS encore envoyÃ©
async function countPendingParticipants(resId) {
  const snap = await get(ref(db, `participants/${resId}`));
  if (!snap.exists()) return 0;

  return Object.values(snap.val()).filter(
    p => p.ticketSent !== true
  ).length;
}

/* DOM refs */
const list = document.getElementById("list");
const adminToggleBtn = document.getElementById("adminToggle");
const priceBtn = document.getElementById("priceBtn");
const testEmailBtn = document.getElementById("testEmailBtn");
const exportBtn = document.getElementById("exportBtn");
const exportEmailsBtn = document.getElementById("exportEmailsBtn");

const testNotice = document.getElementById("testNotice");
const adminNotice = document.getElementById("adminNotice");
const resForm = document.getElementById("resForm");
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const phoneInput = document.getElementById("phone");
const aI = document.getElementById("adult");
const cI = document.getElementById("child");
const totalEl = document.getElementById("totalPrice");
const closeModalBtn = document.getElementById("closeModalBtn");

/* Formatage entrÃ©es */
nameInput.addEventListener("input",()=>nameInput.value=nameInput.value.toUpperCase());
emailInput.addEventListener("input",()=>emailInput.value=emailInput.value.toLowerCase());
phoneInput.addEventListener("input",()=>{
  let d=phoneInput.value.replace(/\D/g,'');
  if(d.startsWith("33"))d="0"+d.slice(2);
  if(d.startsWith("0033"))d="0"+d.slice(4);
  phoneInput.value=d.slice(0,10).replace(/(\d{2})(?=\d)/g,'$1 ').trim();
});

/* Total */
function updateTotal(){
  const a=+aI.value||0, c=+cI.value||0;
  totalEl.textContent = `Total : ${(a*priceAdult + c*priceChild).toFixed(2)} â‚¬`;
}
aI.addEventListener("input",updateTotal);
cI.addEventListener("input",updateTotal);
updateTotal();

/* Live data */
onValue(refSpectacle, snap => {
  reservations = snap.val() || {};
  renderList();
});

/* Email HTML (avec bouton Imprimer) */
function buildEmailHTML(data){
  return `
  <div style="font-family:'Segoe UI',Arial,sans-serif; background-color:#f9f9f9; padding:20px;">
    <div style="max-width:600px; margin:0 auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); overflow:hidden;">
      <div style="background-color:#d32f2f; color:white; text-align:center; padding:18px;">
        <h2 style="margin:0;">ğŸ­ ThÃ©Ã¢tre Saint-Martin</h2>
        <p style="margin:0; font-size:14px;">Salle de Bessay â€“ Spectacle du 23 janvier 2026</p>
      </div>
      <div style="padding:35px 30px 40px 30px; line-height:1.65;">
<h3 style="color:#d32f2f; margin-top:0;">
  ${data.free ? "ğŸŸï¸ Invitation gratuite" : "Confirmation de rÃ©servation"}
</h3>

<p>Bonjour <b>${data.name}</b>,</p>

<p>
  ${data.free
    ? "Vous bÃ©nÃ©ficiez dâ€™une <b>invitation gratuite</b>. Voici votre billet Ã  prÃ©senter Ã  lâ€™entrÃ©e :"
    : "Merci pour votre rÃ©servation ! Voici le rÃ©capitulatif Ã  imprimer et prÃ©senter :"
  }
</p>

        <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:15px;">
          <tr><td style="padding:6px 0;">ğŸ« <b>Adultes :</b></td><td style="text-align:right;">${data.nbAdult}</td></tr>
          <tr><td style="padding:6px 0;">ğŸ‘§ <b>Enfants -12 ans :</b></td><td style="text-align:right;">${data.nbChild}</td></tr>
          <tr style="border-top:1px solid #eee;"><td style="padding:8px 0; font-weight:bold;">Total de places</td><td style="text-align:right; font-weight:bold;">${data.nbPlaces}</td></tr>
          ${data.free ? "" : `
<tr>
  <td style="padding:8px 0; font-weight:bold; color:#388e3c;">Montant total</td>
  <td style="text-align:right; font-weight:bold; color:#388e3c;">
    ${data.amount.toFixed(2)} â‚¬
  </td>
</tr>
`}

        </table>
<div style="margin-top:32px; padding:22px; background:#fff8e1; border-radius:8px;">
          <p style="margin:0; font-size:14px;">
            ğŸ“ <b>Lieu :</b> Salle de Bessay<br>
            ğŸ“… <b>Date :</b> Vendredi 23 janvier 2026<br>
            ğŸ“¢ <b>Heure : PrÃ©sence impÃ©rative Ã  19h00 - dÃ©but du spectacle Ã  20h30<br>
          </p>
        </div>

        <div style="text-align:center; margin-top:20px;">
          <!-- Ce bouton lancera l'impression dans la modale / navigateur. 
               Dans un client mail, l'impression auto peut Ãªtre bloquÃ©e mais le bouton reste visible. -->
<a href="https://orleanne03.github.io/theatre-saint-martin/billet.html?id=${data.id}${data.participantEmail ? `&email=${encodeURIComponent(data.participantEmail)}` : ""}"

   style="background:#388e3c; color:white; text-decoration:none; padding:10px 18px; border-radius:6px; font-weight:bold; display:inline-block;">
   ğŸ–¨ï¸ Imprimer mon billet
</a>
        </div>

        <p style="font-size:14px; color:#555; margin-top:20px;">Pour toute question : 06.09.12.11.59</p>
        <p style="font-size:13px; color:#777;">Ã€ trÃ¨s bientÃ´t au thÃ©Ã¢tre ğŸ­</p>
      </div>
      <div style="background-color:#f0f0f0; text-align:center; padding:10px; font-size:12px; color:#777;">
        ThÃ©Ã¢tre Saint-Martin â€“ Salle de Bessay<br>Â© 2025 â€“ Tous droits rÃ©servÃ©s
      </div>
    </div>
  </div>`;
}

async function sendEmail(data){
  const htmlContent = buildEmailHTML(data);

  if (emailTestMode){
    document.getElementById("emailPreview").innerHTML = htmlContent;
    document.getElementById("emailModal").classList.add("show");
    return;
  }

  await sendViaBrevo(
    data.email,
    "ğŸŸï¸ Confirmation de rÃ©servation â€“ Salle de Bessay",
    htmlContent
  );

  alert("âœ‰ï¸ E-mail de confirmation envoyÃ© !");
}

closeModalBtn.addEventListener("click",()=>document.getElementById("emailModal").classList.remove("show"));

/* Formulaire */
resForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = nameInput.value.trim().toUpperCase();
  const email = emailInput.value.trim().toLowerCase();
  const phone = phoneInput.value.trim();
  const nbAdult = +aI.value||0, nbChild = +cI.value||0;
  const nbPlaces = nbAdult + nbChild;
  if (!name || !email || !phone || nbPlaces===0) return alert("âŒ Formulaire incomplet !");
const isFree = document.getElementById("free").checked;

const data = {
  name, email, phone,
  nbAdult, nbChild, nbPlaces,
  amount: isFree ? 0 : (nbAdult*priceAdult + nbChild*priceChild),
  paid: isFree ? true : document.getElementById("paid").checked,
  free: isFree,
  present: false
};

  const newRef = push(ref(db, "spectacles/salle_bessay"));
await set(newRef, { ...data, id:newRef.key });

alert("âœ… RÃ©servation enregistrÃ©e !");
sendEmail({ ...data, id:newRef.key });

resForm.reset();
updateTotal();

});

/* Rendu liste + event delegation */
async function renderList(){

  let entries = Object.entries(reservations);

  // âœ… Tri alphabÃ©tique sur le champ "name"
  entries = entries.sort((a, b) => {
    const nameA = (a[1].name || "").toUpperCase();
    const nameB = (b[1].name || "").toUpperCase();
    return nameA.localeCompare(nameB);
  });

  if (!entries.length){
    list.innerHTML = "<p>Aucune rÃ©servation.</p>";
    return;
  }
  /* --- AJOUT : Calcul des totaux --- */
let totalAdult = 0, totalChild = 0, totalAmount = 0;
for (const r of Object.values(reservations)){
  totalAdult += Number(r.nbAdult||0);
  totalChild += Number(r.nbChild||0);
  totalAmount += Number(r.amount||0);
}

/* Affichage rÃ©sumÃ© */
let summary = `
  <div style="max-width:600px;margin:0 auto 15px auto;padding:12px;
              background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);
              font-weight:600;font-size:1rem;text-align:center;">
    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Adultes : ${totalAdult} &nbsp; | &nbsp; ğŸ‘§ Enfants : ${totalChild} <br>
    ğŸ’¶ Total encaissÃ© (si tous payÃ©s) : ${totalAmount.toFixed(2)} â‚¬
  </div>
`;

  let html = summary + "<h3>ğŸ“‹ RÃ©servations</h3>";

  for (const [id, r] of entries){
    const pendingCount = await countPendingParticipants(id);

    const payClass = r.paid ? "paid" : "unpaid";
    const payTxt   = r.paid ? "âœ… PayÃ©" : "âŒ";
    const presClass= r.present ? "paid" : "unpaid";
    const presTxt  = r.present ? "ğŸŸï¸ PrÃ©sent" : "ğŸš« Absent";
    html += `
<div class="accordion-card ${r.present ? 'present-card' : ''} ${r.free ? 'free-line' : ''}" data-card="${id}">

        <div class="accordion-header" data-toggle="${id}">
<span>
<b>${r.name}</b> â€“ ${r.nbPlaces} places
${r.free ? `<span class="free-badge">GRATUIT</span>` : ""}

${pendingCount > 0 ? `
  <span style="
    background:#fb8c00;
    color:white;
    border-radius:50%;
    padding:3px 8px;
    font-size:12px;
    font-weight:700;
    margin-left:8px;
    display:inline-block;
    min-width:20px;
    text-align:center;
  ">
    ${pendingCount}
  </span>
` : ""}

</span>

          <span class="${payClass}">${payTxt}</span>
        </div>
        <div class="accordion-body" id="body-${id}">
          <p>ğŸ“ ${r.phone}</p>
          <p>ğŸ“§ ${r.email}</p>
          <p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ${r.nbAdult} adulte(s), ${r.nbChild} enfant(s)</p>
          <p><b>ğŸ’¶ Montant :</b> ${Number(r.amount||0).toFixed(2)} â‚¬</p>

          <p><b>ğŸŸï¸ Statut :</b> <span class="${presClass}">${presTxt}</span></p>
${adminMode ? `
  <button class="action-btn" data-action="toggle-paid" data-id="${id}" data-next="${!r.paid}">ğŸ’¶ Basculer paiement</button>
  <button class="action-btn" style="background:#8e24aa;" data-action="toggle-present" data-id="${id}" data-next="${!r.present}">ğŸŸï¸ Valider billet</button>

  <button class="action-btn" style="background:#1976d2;"
    data-action="resend-ticket"
    data-id="${id}">
    ğŸ“§ Renvoyer le billet
  </button>
<button class="action-btn"
  style="background:#2e7d32;"
  data-action="participants"
  data-id="${id}">
  ğŸ“© Demander les infos des participants
</button>

  <div class="participants-list" id="participants-${id}">
    <p style="font-weight:600;margin-top:10px;">
      ğŸ‘¥ Participants :
    </p>
    <div style="font-size:0.9rem;color:#444;">
      Chargementâ€¦
    </div>
  </div>


  <button class="delete-btn" data-action="delete" data-id="${id}">ğŸ—‘ Supprimer</button>
` : ""}

        </div>
      </div>`;
  }
  list.innerHTML = html;
  // ğŸ”½ Charger les participants pour chaque rÃ©servation (admin)
if (adminMode) {
  Object.keys(reservations).forEach(id => loadParticipants(id));
}

}
list.addEventListener("click", async (e)=>{
  const header = e.target.closest("[data-toggle]");
  if (header){
    const id = header.getAttribute("data-toggle");
    document.getElementById(`body-${id}`).classList.toggle("open");
    return;
  }
  const btn = e.target.closest("[data-action]");
  if (!btn) return;
  const action = btn.getAttribute("data-action");
  const id = btn.getAttribute("data-id");
  if (action==="toggle-paid"){
    const next = btn.getAttribute("data-next")==="true";
    const r = reservations[id];
    await set(ref(db,`spectacles/salle_bessay/${id}`), { ...r, paid: next });
  } else if (action==="toggle-present"){
    const next = btn.getAttribute("data-next")==="true";
    const r = reservations[id];
    await set(ref(db,`spectacles/salle_bessay/${id}`), { ...r, present: next });
  } else if (action==="delete"){
    if (confirm("Supprimer ?")){
      await remove(ref(db,`spectacles/salle_bessay/${id}`));
    }
  }
  else if (action === "resend-ticket") {
  const r = reservations[id];
  if (!r || !r.email) {
    alert("âŒ Email introuvable");
    return;
  }

  if (!confirm(`ğŸ“§ Renvoyer le billet Ã  ${r.email} ?`)) return;

const html = buildEmailHTML({
  ...r,
  id
});

await sendViaBrevo(
  r.email,
  "ğŸŸï¸ Votre billet â€“ Salle de Bessay",
  html
);



  alert("âœ… Billet renvoyÃ©");
}
else if (action === "participants") {
  const r = reservations[id];

  participantsTargetReservationId = id;



document.getElementById("bulkSubject").value =
  "ğŸŸï¸ Informations nÃ©cessaires pour lâ€™envoi des billets â€“ Bessay";


const formLink =
  "https://orleanne03.github.io/theatre-saint-martin/participants.html?resId=" +
  id;

document.getElementById("bulkSubject").value =
  "ğŸŸï¸ Informations nÃ©cessaires pour lâ€™envoi des billets â€“ Bessay";

document.getElementById("bulkMessage").value =
  "Bonjour " + r.name + ",\n\n" +
  "Vous avez rÃ©servÃ© " + r.nbPlaces + " places pour le spectacle Ã  la Salle de Bessay.\n\n" +
  "Afin que chaque participant puisse recevoir son billet nominatif, " +
  "merci de complÃ©ter les informations des autres participants " +
  "(email et tÃ©lÃ©phone) via le lien ci-dessous :\n\n" +
  formLink + "\n\n" +
  "Une fois le formulaire complÃ©tÃ©, nous pourrons envoyer les billets " +
  "Ã  chaque personne concernÃ©e.\n\n" +
  "Ã€ trÃ¨s bientÃ´t ğŸ­\n" +
  "La troupe du ThÃ©Ã¢tre Saint-Martin";



  document.getElementById("bulkEmailModal").style.display = "flex";
}


});

/* Bouton Admin + boutons admin */
adminToggleBtn.addEventListener("click", ()=>{
  if (!adminMode){
    const pass = prompt("Mot de passe admin :");
    if (pass !== "admin123") { alert("Mot de passe incorrect !"); return; }
    adminMode = true;
    document.body.classList.add("admin-mode");
    adminNotice.style.display = "block";
    adminToggleBtn.textContent = "ğŸšª Sortir du mode admin";
[priceBtn,testEmailBtn,exportBtn, exportEmailsBtn].forEach(b=>b.style.display="inline-block");
document.getElementById("sendBulkEmail").style.display = "inline-block";
document.getElementById("sendAllTickets").style.display = "inline-block";




  } else {
    adminMode = false;
    emailTestMode = false;
    document.body.classList.remove("admin-mode");
    adminNotice.style.display = "none";
    adminToggleBtn.textContent = "ğŸ” Mode Admin";
[priceBtn,testEmailBtn,exportBtn, exportEmailsBtn].forEach(b=>b.style.display="none");
document.getElementById("sendBulkEmail").style.display = "none";
document.getElementById("sendAllTickets").style.display = "none";



    testNotice.style.display = "none";
  }
  renderList();
});

priceBtn.addEventListener("click", ()=>{
  const a = parseFloat(prompt("Tarif adulte (â‚¬)", priceAdult));
  const c = parseFloat(prompt("Tarif enfant (â‚¬)", priceChild));
  if (!isNaN(a)) priceAdult = a;
  if (!isNaN(c)) priceChild = c;
  alert(`Tarifs mis Ã  jour :\nAdulte = ${priceAdult} â‚¬\nEnfant = ${priceChild} â‚¬`);
  updateTotal();
});

testEmailBtn.addEventListener("click", ()=>{
  emailTestMode = !emailTestMode;
  testNotice.style.display = emailTestMode ? "block" : "none";
  testEmailBtn.textContent = emailTestMode ? "âœ‰ï¸ Mode Email : RÃ‰EL" : "âœ‰ï¸ Mode Email : TEST";
});

function safeCell(v){return v==null?"":String(v).replace(/\r?\n/g," ").trim();}
function exportReservationsCSV(obj){
  try{
    if(!obj||!Object.keys(obj).length){alert("Aucune rÃ©servation Ã  exporter.");return;}
    const header=["Nom","Email","TÃ©lÃ©phone","Adultes","Enfants","Total places","Montant (â‚¬)","PayÃ©","PrÃ©sent"];
    const rows=[header];
    Object.values(obj).forEach(r=>{
      const amountNum=Number(r?.amount||0);
      rows.push([safeCell(r?.name),safeCell(r?.email),safeCell(r?.phone),
        Number(r?.nbAdult||0),Number(r?.nbChild||0),Number(r?.nbPlaces||0),
        amountNum.toFixed(2),r?.paid?"Oui":"Non",r?.present?"Oui":"Non"]);
    });
    const csv="\uFEFF"+rows.map(l=>l.join(";")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const date=new Date().toISOString().split("T")[0];
    const filename=`reservations_bessay_${date}.csv`;
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download=filename;a.style.display="none";
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }catch(err){console.error("[EXPORT] Erreur:",err);alert("Erreur pendant lâ€™export CSV.");}
}
exportBtn.addEventListener("click", ()=>exportReservationsCSV(reservations));
async function exportAllEmailsCSV() {
  const emails = new Set();

  // 1) Emails des rÃ©servations principales
  Object.values(reservations).forEach(r => {
    if (r?.email) emails.add(String(r.email).toLowerCase().trim());
  });

  // 2) Emails des participants
  for (const resId of Object.keys(reservations)) {
    const snap = await get(ref(db, `participants/${resId}`));
    if (!snap.exists()) continue;

    Object.values(snap.val()).forEach(p => {
      if (p?.email) emails.add(String(p.email).toLowerCase().trim());
    });
  }

  if (!emails.size) {
    alert("Aucun email trouvÃ©.");
    return;
  }

  const header = "email";
  const rows = [header, ...Array.from(emails).sort()];
  const csv = "\uFEFF" + rows.join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const date = new Date().toISOString().split("T")[0];
  const filename = `emails_bessay_${date}.csv`;

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  alert(`âœ… Export terminÃ© : ${emails.size} emails`);
}

exportEmailsBtn.addEventListener("click", exportAllEmailsCSV);

// ===================================================
// ğŸ“¢ EMAIL GROUPÃ‰ (ERRATUM) â€” MODE ADMIN
// ===================================================
const bulkBtn = document.getElementById("sendBulkEmail");
const bulkModal = document.getElementById("bulkEmailModal");

bulkBtn.addEventListener("click", ()=>{
  populateBulkRecipients();
  bulkModal.style.display = "flex";
});


document.getElementById("bulkCancel").onclick = ()=>{
  bulkModal.style.display = "none";
};

document.getElementById("bulkSend").onclick = async ()=>{
  const subject = document.getElementById("bulkSubject").value.trim();
  const message = document.getElementById("bulkMessage").value.trim();

  if (!subject || !message){
    alert("âš ï¸ Sujet et message requis");
    return;
  }

// ğŸ” RÃ©cupÃ©ration des emails uniques
const emailsSet = new Set();

// ğŸ” Emails cochÃ©s
const checked = document.querySelectorAll(".bulk-recipient:checked");

// ğŸ¯ 1ï¸âƒ£ Cas : demande infos participants â†’ UNE SEULE PERSONNE
if (participantsTargetReservationId) {
  const r = reservations[participantsTargetReservationId];
  if (r?.email) {
    emailsSet.add(r.email.toLowerCase());
  }
}
// â˜‘ï¸ 2ï¸âƒ£ Cas : erratum avec cases cochÃ©es
else if (checked.length > 0) {
  checked.forEach(cb => {
    const r = reservations[cb.value];
    if (r?.email) emailsSet.add(r.email.toLowerCase());
  });
}
// ğŸ“¢ 3ï¸âƒ£ Cas : erratum global (personne cochÃ©e)
else {
  Object.values(reservations).forEach(r => {
    if (r.email) emailsSet.add(r.email.toLowerCase());
  });
}


participantsTargetReservationId = null;


  if (!emailsSet.size){
    alert("âŒ Aucun email trouvÃ©");
    return;
  }

  if (!confirm(`ğŸ“¬ Envoyer lâ€™email Ã  ${emailsSet.size} personnes ?`)) return;

  let sent = 0;

  for (const email of emailsSet){
    const html = `
<div style="
  font-family:'Segoe UI',Arial,sans-serif;
  background-color:#f4f6f8;
  padding:20px;
">
  <div style="
    max-width:600px;
    margin:0 auto;
    background:#ffffff;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.12);
    overflow:hidden;
  ">

    <!-- EN-TÃŠTE -->
    <div style="
      background: linear-gradient(135deg, #1565c0, #2196f3);
      color:white;
      text-align:center;
      padding:22px 20px;
    ">
      <h2 style="margin:0;font-size:22px;">ğŸ­ ThÃ©Ã¢tre Saint-Martin</h2>
      <p style="margin:6px 0 0;font-size:14px;opacity:0.95;">
        Salle de Bessay â€“ Spectacle du 23 janvier 2026
      </p>
    </div>

    <!-- CONTENU -->
    <div style="padding:28px 30px; color:#333; line-height:1.6;">
      <h3 style="
        margin-top:0;
        color:#d32f2f;
        font-size:18px;
      ">
        ğŸ“¢ Information importante
      </h3>

      <p>Bonjour,</p>

      <div style="
        background:#fff8e1;
        border-left:5px solid #ff9800;
        padding:14px 16px;
        border-radius:6px;
        margin:15px 0;
        font-size:15px;
      ">
        ${message.replace(/\n/g,"<br>")}
      </div>

      <p style="margin-top:18px;">
        Nous vous remercions de votre comprÃ©hension et restons Ã  votre disposition.
      </p>

      <p style="margin-top:22px;">
        ğŸ­ <b>Lâ€™Ã©quipe du ThÃ©Ã¢tre Saint-Martin</b><br>
        ğŸ“ Salle de Bessay<br>
        ğŸ“ 06 09 12 11 59
      </p>
    </div>

    <!-- PIED -->
    <div style="
      background:#f0f0f0;
      text-align:center;
      padding:12px;
      font-size:12px;
      color:#777;
    ">
      Vous recevez cet email suite Ã  votre rÃ©servation.<br>
      Â© ThÃ©Ã¢tre Saint-Martin â€“ Tous droits rÃ©servÃ©s
    </div>

  </div>
</div>
`;


    if (emailTestMode){
      console.log("ğŸ§ª TEST â†’", email, html);
      document.getElementById("emailPreview").innerHTML = html;
      document.getElementById("emailModal").classList.add("show");
    } else {
await sendViaBrevo(email, subject, html);

    }

    sent++;
  }

  bulkModal.style.display = "none";

  alert(
    emailTestMode
      ? `ğŸ§ª Mode TEST : ${sent} emails simulÃ©s`
      : `âœ… ${sent} emails envoyÃ©s`
  );
};
function populateBulkRecipients() {
  const container = document.getElementById("bulkRecipients");
  container.innerHTML = "";

  Object.entries(reservations).forEach(([id, r]) => {
    if (!r.email) return;

    const label = document.createElement("label");
    label.style.display = "block";
    label.style.cursor = "pointer";

    label.innerHTML = `
      <input type="checkbox"
             class="bulk-recipient"
             value="${id}"
             style="margin-right:6px;">
      ${r.name} â€” ${r.email}
    `;

    container.appendChild(label);
  });
}


async function loadParticipants(resId) {
  
  const container = document.getElementById(`participants-${resId}`);
  if (!container) return;
  container.innerHTML = "";
  const snap = await get(ref(db, `participants/${resId}`));

  if (!snap.exists()) {
    container.innerHTML = "<p>â€” Aucun participant</p>";
    return;
  }

  const participants = Object.entries(snap.val());

  let html = "<ul style='padding-left:18px;'>";

participants.forEach(([pid, p]) => {
  const showBadge = p.entered === true && p.ticketSent !== true;

  html += `
    <li style="display:flex;align-items:center;justify-content:space-between;">
      <span>
        ${p.name} â€” ${p.email} ${p.phone ? "â€” " + p.phone : ""}

        ${showBadge ? `
          <span style="
            background:#2e7d32;
            color:white;
            padding:2px 8px;
            border-radius:6px;
            font-size:12px;
            font-weight:600;
            margin-left:8px;
          ">
            ğŸŸï¸ EntrÃ©
          </span>
        ` : ""}
      </span>

      <span>
        ${adminMode ? `

<button
  class="mark-entered"
  data-resid="${resId}"
  data-pid="${pid}"
  ${p.entered ? "disabled" : ""}
  style="
    background:${p.entered ? '#2e7d32' : '#c62828'};
    color:white;
    border:none;
    border-radius:6px;
    padding:4px 8px;
    font-size:13px;
    font-weight:600;
    cursor:${p.entered ? 'default' : 'pointer'};
    margin-right:6px;
    opacity:${p.entered ? '0.7' : '1'};
  "
>
  ${p.entered ? "EntrÃ©" : "Non entrÃ©"}
</button>



        <button
  class="send-ticket-participant"
  data-resid="${resId}"
  data-pid="${pid}"
  title="Envoyer le billet"
  style="background:none;border:none;cursor:pointer;font-size:18px;"
>
  ğŸ–¨ï¸
</button>

<button
  class="delete-participant"
  data-resid="${resId}"
  data-pid="${pid}"
  title="Supprimer le participant"
  style="background:none;border:none;cursor:pointer;font-size:18px;color:#e53935;"
>
  âŒ
</button>

        ` : ""}
      </span>
    </li>
  `;
});




  html += "</ul>";
  container.innerHTML = html;
}






async function sendParticipantTicket(participant, reservation, pid) {

  const html = `
  <div style="font-family:Segoe UI,Arial,sans-serif;padding:20px;background:#f9f9f9;">
    <div style="max-width:600px;margin:auto;background:#fff;border-radius:10px;
                box-shadow:0 3px 10px rgba(0,0,0,.15);overflow:hidden;">

      <div style="background:#2e7d32;color:white;text-align:center;padding:18px;">
        <h2 style="margin:0;">ğŸ­ ThÃ©Ã¢tre Saint-Martin</h2>
        <p style="margin:5px 0 0;">Salle de Bessay â€“ 23 janvier 2026</p>
      </div>

      <div style="padding:25px;line-height:1.6;">
        <p>Bonjour <b>${participant.name}</b>,</p>

        <p>
          Suite Ã  la rÃ©servation effectuÃ©e par
          <b>${reservation.name}</b>,
          voici <b>votre billet nominatif</b> Ã  prÃ©senter Ã  votre arrivÃ©e.
        </p>

        <p>
          ğŸ“ Salle de Bessay<br>
          ğŸ•— PrÃ©sence Ã  19h00 â€“ Spectacle Ã  20h30
        </p>

        <div style="text-align:center;margin:25px 0;">
<a href="https://orleanne03.github.io/theatre-saint-martin/billet.html?id=${reservation.id}&email=${encodeURIComponent(participant.email)}"

   style="background:#388e3c;color:white;padding:12px 20px;
          text-decoration:none;border-radius:6px;font-weight:bold;">
  ğŸ–¨ï¸ Imprimer mon billet
</a>

        </div>

        <p style="font-size:14px;color:#555;">
          Merci de prÃ©senter ce billet (imprimÃ© ou sur tÃ©lÃ©phone) Ã  lâ€™entrÃ©e.
        </p>

        <p style="font-size:14px;color:#777;">
          Ã€ trÃ¨s bientÃ´t ğŸ­<br>
          ThÃ©Ã¢tre Saint-Martin
        </p>
      </div>
    </div>
  </div>
  `;

  if (emailTestMode){
    document.getElementById("emailPreview").innerHTML = html;
    document.getElementById("emailModal").classList.add("show");
    return;
  }

await sendViaBrevo(
  participant.email,
  "ğŸŸï¸ Votre billet â€“ Troupe Saint Martin",
  html
);
await set(
  ref(db, `participants/${reservation.id}/${pid}`),
  {
    ...participant,
    ticketSent: true
  }
);


}

document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".send-ticket-participant");
  if (!btn) return;

  const resId = btn.dataset.resid;
  const pid = btn.dataset.pid;

  // ğŸ” RÃ©cupÃ©ration participant
  const pSnap = await get(ref(db, `participants/${resId}/${pid}`));
  if (!pSnap.exists()) {
    alert("âŒ Participant introuvable");
    return;
  }
  const participant = pSnap.val();

  // ğŸ” RÃ©cupÃ©ration rÃ©servation principale
  const rSnap = await get(ref(db, `spectacles/salle_bessay/${resId}`));
  if (!rSnap.exists()) {
    alert("âŒ RÃ©servation introuvable");
    return;
  }
  const reservation = rSnap.val();

  if (!participant.email) {
    alert("âŒ Email du participant manquant");
    return;
  }

  if (!confirm(`Envoyer le billet Ã  ${participant.email} ?`)) return;

await sendParticipantTicket(
  participant,
  { ...reservation, id: resId },
  pid
);


  alert("âœ… Billet envoyÃ© au participant");

});

// ===================================================
// ğŸ“¬ RENVOYER TOUS LES BILLETS â€” BESSSAY (MODE ADMIN)
// ===================================================
document.getElementById("sendAllTickets").onclick = async () => {
  if (!confirm("Renvoyer TOUS les billets Bessay (clients + participants) ?")) return;

  let totalSent = 0;

  const resSnap = await get(ref(db, "spectacles/salle_bessay"));
  if (!resSnap.exists()) {
    alert("Aucune rÃ©servation trouvÃ©e.");
    return;
  }

  const reservations = resSnap.val();

  for (const resId of Object.keys(reservations)) {
    const reservation = reservations[resId];

    // 1ï¸âƒ£ Envoi au client principal
    if (reservation.email) {
await sendViaBrevo(
  reservation.email,
  "ğŸŸï¸ Votre billet â€“ Salle de Bessay",
  buildEmailHTML({ ...reservation, id: resId })
);

      totalSent++;
    }

    // 2ï¸âƒ£ Envoi aux participants
    const partSnap = await get(ref(db, `participants/${resId}`));
    if (!partSnap.exists()) continue;

    const participants = partSnap.val();

    for (const pid of Object.keys(participants)) {
      const participant = participants[pid];
      if (!participant.email) continue;

await sendParticipantTicket(
  participant,
  { ...reservation, id: resId },
  pid
);


      totalSent++;
    }
  }

  alert(`ğŸŸï¸ ${totalSent} billets envoyÃ©s (clients + participants)`);
};
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".mark-entered");
  if (!btn) return;

  const resId = btn.dataset.resid;
  const pid = btn.dataset.pid;

  const snap = await get(ref(db, `participants/${resId}/${pid}`));
  if (!snap.exists()) return;

  const participant = snap.val();

  await set(ref(db, `participants/${resId}/${pid}`), {
    ...participant,
    entered: true
  });

  loadParticipants(resId);
});

document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".delete-participant");
  if (!btn) return;

  const resId = btn.getAttribute("data-resid");
  const pid = btn.getAttribute("data-pid");

  if (!resId || !pid) {
    console.error("âŒ IDs manquants", { resId, pid });
    alert("Erreur : identifiants manquants");
    return;
  }

  if (!confirm("Supprimer ce participant ?")) return;

  console.log("ğŸ”¥ Suppression Firebase :", `participants/${resId}/${pid}`);

  await remove(ref(db, `participants/${resId}/${pid}`));

  loadParticipants(resId);
});


async function sendViaBrevo(to, subject, html) {
  const res = await fetch("https://brevo-mailer.theatre-sm-03.workers.dev", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      to: to,
      subject: subject,
      html: html
    })
  });

  if (!res.ok) {
    const err = await res.text();
    throw new Error(err);
  }
}



</script>


</body>
</html>
